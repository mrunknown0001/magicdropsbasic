import{r as n,b as xe,j as e,h as O,k as G,l as q,i as W,e as M,m as ie,bn as Ne,bo as Se,p as ke,A as re,K as le,bc as Ee,z as x,Y as me,V as fe,f as he,X as pe,ai as Ce,s as A,aF as De,o as ce,T as Ae,W as ze,R as Fe,O as Re,a0 as ee,u as ve,M as Te,F as ne,aM as Me,t as Ie,bp as be,bb as $e,P as Ve,G as Be,L as Ue}from"./index-C2zOcIr5.js";import{u as Pe}from"./useTaskAssignment-DzXizOwJ.js";import{T as Le}from"./TaskDetail-CgJpSS8C.js";import{S as X}from"./ShimmerEffect-By9i5EVD.js";import{u as Oe}from"./useToast-BsUGRjrm.js";import{R as ge}from"./refresh-cw-BQFYSu-c.js";import{C as J}from"./copy-B975JfD7.js";import{S as oe}from"./smartphone-BVgYlr7j.js";import{K as ye,L as Ge}from"./link-DLAKUAWl.js";import{E as de}from"./external-link-Bq5Q6tnA.js";import{f as qe}from"./formatDistanceToNow-Zog-F_3p.js";import{F as we}from"./FileUpload-C0tYnj7c.js";import"./upload-DWuvDsn2.js";const We=({taskAssignment:r,isLoading:g=!1,onComplete:C,onBack:t,onNextStep:m,onPreviousStep:y})=>{const[b,o]=n.useState((r==null?void 0:r.current_step)||1),[h,i]=n.useState(!1),{settings:u}=xe(),p=(u==null?void 0:u.primary_color)||"#ee1d3c";if(u!=null&&u.accent_color,n.useEffect(()=>{r&&r.current_step&&o(r.current_step)},[r]),g)return e.jsxs(O,{className:"w-full max-w-3xl mx-auto",children:[e.jsx(G,{children:e.jsx(q,{className:"text-center text-xl",children:e.jsx(X,{className:"h-8 w-48 mx-auto"})})}),e.jsx(W,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(X,{className:"h-6 w-full"}),e.jsx(X,{className:"h-32 w-full"}),e.jsx(X,{className:"h-6 w-full"}),e.jsxs("div",{className:"flex justify-between mt-8",children:[e.jsx(X,{className:"h-10 w-24"}),e.jsx(X,{className:"h-10 w-24"})]})]})})]});if(!r||!r.task_template)return e.jsx("div",{children:"No task template found"});const{task_template:w}=r,j=w.steps||[],_=j.length,c=Math.min(Math.max(1,b),_),d=j[c-1],N=c===_,R=c===1;if(!j.length||!d)return e.jsxs(O,{className:"w-full max-w-3xl mx-auto",children:[e.jsx(G,{children:e.jsx(q,{className:"text-center text-xl",children:"Anweisungen nicht verfügbar"})}),e.jsxs(W,{children:[e.jsx("p",{className:"text-center text-gray-500 dark:text-gray-400 mb-6",children:"Für diese Aufgabe wurden keine Anweisungen hinterlegt."}),e.jsx("div",{className:"flex justify-center",children:e.jsx(M,{onClick:()=>t&&t(),variant:"secondary",children:"Zurück zur Aufgabe"})})]})]});const l=async()=>{if(!h)try{if(i(!0),N)C&&C();else{const D=c+1;o(D),m&&await m()}}catch(D){console.error("Failed to navigate to next step:",D),x.error("Failed to navigate to next step. Please try again.")}finally{i(!1)}},z=async()=>{if(!h)try{i(!0);const D=c-1;o(D),y&&await y()}catch(D){console.error("Failed to navigate to previous step:",D),x.error("Failed to navigate to previous step. Please try again.")}finally{i(!1)}},U=()=>{h||t&&t()};return e.jsx(ie.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.5},className:"w-full h-full flex flex-col",children:e.jsxs(O,{className:"w-full h-full flex flex-col shadow-lg border border-gray-200 dark:border-gray-800",children:[e.jsx(G,{className:"border-b border-gray-100 dark:border-gray-800 pb-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(q,{className:"text-2xl font-bold",children:w.title}),e.jsxs("div",{className:"flex items-center mt-2 text-gray-500 dark:text-gray-400",children:[e.jsx(Ne,{className:"mr-2"}),e.jsxs("span",{children:["Schritt ",c," von ",_]})]})]}),e.jsx("div",{className:"flex items-center space-x-1",children:Array.from({length:_}).map((D,$)=>e.jsx("div",{className:`h-2 w-8 rounded-full mx-0.5 ${$<c?"bg-green-500":$===c-1?"":"bg-gray-200 dark:bg-gray-700"}`,style:$===c-1?{backgroundColor:p}:{}},$))})]})}),e.jsx(W,{className:"flex-grow overflow-auto py-8",children:e.jsx(ie.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"h-full flex flex-col",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700 mb-8",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex-shrink-0 rounded-full w-12 h-12 flex items-center justify-center mr-4",style:{backgroundColor:`${p}20`},children:e.jsx(Se,{size:24,style:{color:p}})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 dark:text-gray-100 mb-3",children:d.title}),e.jsx("div",{className:"text-gray-700 dark:text-gray-300 space-y-4",children:d.description.split(`
`).map((D,$)=>e.jsx("p",{className:"text-base leading-relaxed",children:D},$))})]})]})})},c)}),e.jsxs(ke,{className:"border-t border-gray-100 dark:border-gray-800 p-6 flex flex-col sm:flex-row justify-between space-y-4 sm:space-y-0",children:[R?e.jsx(M,{onClick:U,disabled:h,variant:"outline",style:{display:"inline-flex",alignItems:"center",whiteSpace:"nowrap",minWidth:"200px",padding:"8px 16px"},children:"← Zurück zur Aufgabe"}):e.jsx(M,{onClick:z,disabled:h,variant:"outline",style:{display:"inline-flex",alignItems:"center",whiteSpace:"nowrap",minWidth:"120px",padding:"8px 16px"},children:"← Zurück"}),e.jsx(re,{onClick:l,disabled:h,className:"px-8 py-2 text-base font-medium whitespace-nowrap min-w-[140px]",style:{backgroundColor:p,color:"white"},children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx("span",{children:N?"Abschließen":"Weiter"}),N?e.jsx(le,{size:16}):e.jsx(Ee,{size:16})]})})]})]})})},He=({taskAssignment:r,onSubmit:g,onBack:C})=>{const[t,m]=n.useState(!1),[y,b]=n.useState(""),[o,h]=n.useState(""),[i,u]=n.useState(""),[p,w]=n.useState(""),j=async _=>{_.preventDefault();const c={designAndLayout:y,usability:o,content:i,overallImpression:p};try{m(!0),await g(c)}catch(d){console.error("Failed to submit rating:",d),x.error("Bewertung konnte nicht gespeichert werden"),m(!1)}};return e.jsxs(O,{className:"w-full h-full",children:[e.jsxs(G,{children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(me,{className:"text-blue-500 mr-2",size:24}),e.jsx(q,{className:"text-xl font-bold",children:"Bewertung der Website/App"})]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1",children:"Bitte bewerte deine Erfahrung und beantworte die folgenden Fragen"})]}),e.jsx(W,{className:"overflow-auto",children:e.jsxs("form",{onSubmit:j,children:[e.jsxs("div",{className:"mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsx("label",{className:"block font-semibold text-lg text-gray-800 dark:text-gray-100",children:"1. Design und Layout"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1 mb-4",children:"Wie empfindest du das Design und das visuelle Erscheinungsbild der Website oder App? Was gefällt dir besonders gut oder was wirkt eher unübersichtlich oder veraltet?"}),e.jsx("textarea",{value:y,onChange:_=>b(_.target.value),className:"w-full p-4 border-2 rounded-lg border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all",rows:4,placeholder:"Das Design ist modern und aufgeräumt. Besonders gefallen mir die klaren Farben und großen Buttons. In manchen Bereichen wirkt es aber etwas textlastig.",disabled:t})]}),e.jsxs("div",{className:"mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsx("label",{className:"block font-semibold text-lg text-gray-800 dark:text-gray-100",children:"2. Benutzerfreundlichkeit"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1 mb-4",children:"Wie gut lässt sich die Website oder App bedienen? Gab es etwas, das unklar war oder dich beim Navigieren gestört hat?"}),e.jsx("textarea",{value:o,onChange:_=>h(_.target.value),className:"w-full p-4 border-2 rounded-lg border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all",rows:4,placeholder:"Die Navigation war intuitiv und ich habe alle Funktionen schnell gefunden. Die App-Menüs könnten aber etwas größer sein – auf kleineren Bildschirmen ist es manchmal fummelig.",disabled:t})]}),e.jsxs("div",{className:"mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsx("label",{className:"block font-semibold text-lg text-gray-800 dark:text-gray-100",children:"3. Inhalte und Informationsgehalt"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1 mb-4",children:"Wie hilfreich und verständlich sind die Inhalte? Gibt es Informationen oder Funktionen, die fehlen oder überflüssig wirken?"}),e.jsx("textarea",{value:i,onChange:_=>u(_.target.value),className:"w-full p-4 border-2 rounded-lg border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all",rows:4,placeholder:"Alle Inhalte waren verständlich geschrieben und gut gegliedert. Ich hätte mir allerdings eine ausführlichere FAQ-Sektion gewünscht.",disabled:t})]}),e.jsxs("div",{className:"mb-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700",children:[e.jsx("label",{className:"block font-semibold text-lg text-gray-800 dark:text-gray-100",children:"4. Gesamteindruck"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1 mb-4",children:"Wie ist dein Gesamteindruck der Website oder App? Würdest du sie weiterempfehlen? Warum (nicht)?"}),e.jsx("textarea",{value:p,onChange:_=>w(_.target.value),className:"w-full p-4 border-2 rounded-lg border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all",rows:4,placeholder:"Der Gesamteindruck ist positiv. Die App ist übersichtlich, funktioniert stabil und sieht gut aus. Ich würde sie auf jeden Fall weiterempfehlen.",disabled:t})]}),e.jsxs("div",{className:"flex justify-between mt-8 border-t pt-6",children:[e.jsx(M,{type:"button",onClick:C,variant:"outline",disabled:t,style:{display:"inline-flex",alignItems:"center",whiteSpace:"nowrap",minWidth:"120px",padding:"8px 16px"},children:"← Zurück"}),e.jsx(re,{type:"submit",disabled:t||!y||!o||!i||!p,className:"bg-green-600 hover:bg-green-700 text-white px-8 py-2 text-base font-medium whitespace-nowrap min-w-[180px]",children:e.jsx("div",{className:"flex items-center justify-center space-x-2",children:e.jsx("span",{children:t?"Wird gespeichert...":"Bewertung abschicken"})})})]})]})})]})},Ze=({taskAssignment:r,onAccept:g,onDecline:C,isLoading:t=!1})=>{const{settings:m}=xe(),y=(m==null?void 0:m.primary_color)||"#ee1d3c";m!=null&&m.accent_color;const[b,o]=n.useState(null),h={initial:{opacity:0,y:20},animate:{opacity:1,y:0,transition:{duration:.5}}};return e.jsx(ie.div,{className:"w-full h-full flex flex-col",initial:"initial",animate:"animate",variants:h,children:e.jsxs(O,{className:"w-full h-full flex flex-col shadow-lg border border-gray-200 dark:border-gray-800",children:[e.jsxs(G,{className:"border-b border-gray-100 dark:border-gray-800 pb-6",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("div",{className:"flex-shrink-0 rounded-full w-16 h-16 flex items-center justify-center",style:{backgroundColor:`${y}20`},children:e.jsx(fe,{style:{color:y},size:32})})}),e.jsx(q,{className:"text-3xl font-bold text-center",children:"Möchtest du den Video-Chat durchführen?"}),e.jsx("p",{className:"text-center text-gray-600 dark:text-gray-400 mt-2 max-w-2xl mx-auto",children:"Der Video-Chat ist ein wichtiger Teil des Bewertungsprozesses. Bitte lies dir die folgenden Hinweise sorgfältig durch."})]}),e.jsxs(W,{className:"flex-grow overflow-auto py-6 px-6 md:px-8",children:[e.jsx("div",{className:"max-w-none mb-6",children:e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-6 rounded-lg mb-6 border border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4",children:"Hinweise für den Video-Chat"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 mb-4",children:"Damit du den Anmeldeprozess realistisch bewerten kannst, bitten wir dich, dich wie ein echter Neukunde zu verhalten. Deine Angaben dienen ausschließlich der internen Bewertung – sie sind nicht rechtsverbindlich."}),e.jsx("h4",{className:"text-base font-medium text-gray-900 dark:text-gray-100 mb-2",children:"Gesetzlich vorgeschriebene Fragen im Chat"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 mb-3",children:"Während des Video-Chats kann dir der/die Mitarbeiter:in Sicherheitsfragen stellen, z. B.:"}),e.jsxs("div",{className:"bg-gray-100 dark:bg-gray-700 p-3 rounded-md mb-3",children:[e.jsx("p",{className:"italic text-gray-600 dark:text-gray-400 mb-1",children:'„Wirst du gezwungen, einen Account zu eröffnen?"'}),e.jsx("p",{className:"italic text-gray-600 dark:text-gray-400",children:'„Steht jemand bei dir, der dich zur Anmeldung drängt?"'})]}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100 mb-3",children:'Diese Fragen musst du immer mit „Nein" beantworten.'}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 mb-4",children:"Falls keine solchen Fragen gestellt werden, vermerke das bitte im Bewertungsbogen."}),e.jsx("h4",{className:"text-base font-medium text-gray-900 dark:text-gray-100 mb-2",children:"Wichtige Hinweise zur Durchführung"}),e.jsxs("ul",{className:"text-gray-700 dark:text-gray-300 space-y-2",children:[e.jsx("li",{children:"Wähle eine ruhige Umgebung mit guter Beleuchtung, funktionierender Webcam und stabiler Internetverbindung."}),e.jsx("li",{children:"Folge den Anweisungen des Video-Chat-Systems bzw. der Mitarbeiterin oder des Mitarbeiters Schritt für Schritt."}),e.jsx("li",{children:"Sollte etwas unklar oder technisch problematisch sein, notiere es bitte im Bewertungsbogen."})]})]})}),e.jsx("div",{className:"flex items-center justify-center mt-6",children:e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg border border-amber-200 dark:border-amber-800 flex items-center",children:[e.jsx(he,{className:"text-amber-500 mr-3 flex-shrink-0",size:24}),e.jsx("p",{className:"text-sm text-amber-800 dark:text-amber-300 m-0",children:"Bei Ablehnung wird die Bewertung als nicht erfolgreich gewertet und fließt nicht in deine Leistungen ein."})]})})]}),e.jsx(ke,{className:"border-t border-gray-100 dark:border-gray-800 p-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4 w-full",children:[e.jsx(M,{variant:"outline",className:"flex-1 py-2 px-6 border-red-200 hover:border-red-300 dark:border-red-800 dark:hover:border-red-700 text-sm sm:text-base min-w-[200px]",onClick:C,disabled:t,onMouseEnter:()=>o("decline"),onMouseLeave:()=>o(null),children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(pe,{className:"text-red-500 flex-shrink-0",size:16}),e.jsx("span",{className:"whitespace-nowrap",children:"Ablehnen – Ich möchte nicht teilnehmen"})]})}),e.jsx(re,{className:"flex-1 py-2 px-6 text-sm sm:text-base min-w-[220px]",onClick:g,disabled:t,onMouseEnter:()=>o("accept"),onMouseLeave:()=>o(null),style:{backgroundColor:y,color:"white"},children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(Ce,{className:"flex-shrink-0",size:16}),e.jsx("span",{className:"whitespace-nowrap",children:"Einverstanden – Ich führe den Video-Chat durch"})]})})]})})]})})},Ke=r=>{const[g,C]=n.useState([]),[t,m]=n.useState(!1),[y,b]=n.useState(null),[o,h]=n.useState(null),[i,u]=n.useState("all"),[p,w]=n.useState(""),[j,_]=n.useState(!1),{showToast:c}=Oe(),d=n.useRef(!1),N=n.useRef(!1),R=n.useRef(r),l=n.useRef(null);n.useEffect(()=>{r!==R.current&&(d.current=!1,R.current=r)},[r]);const z=n.useCallback(async(k,f=!1)=>{if(N.current&&!f)return;const S=k||r;if(!S){b("No phone number ID provided");return}N.current=!0,m(!0),b(null);try{const{data:F,error:s}=await A.from("phone_numbers").select("*").eq("id",S).single();if(s)throw s;h(F),console.log(`DEBUG: Fetching messages for phone ${S} (${F.phone_number})`);let a;try{const{data:v,error:T}=await A.rpc("get_phone_messages",{p_phone_number_id:S});if(T)throw T;a=v,console.log("DEBUG: RPC function succeeded")}catch(v){console.log("DEBUG: RPC failed, using direct query:",v);try{const{data:T,error:E}=await A.from("phone_messages").select("*").eq("phone_number_id",S).order("received_at",{ascending:!1});if(E)throw E;a=T,console.log("DEBUG: Direct query succeeded")}catch(T){console.log("DEBUG: Direct query also failed:",T);const{data:E,error:I}=await A.from("phone_messages").select("id, phone_number_id, sender, message, received_at, message_source, created_at").eq("phone_number_id",S).order("received_at",{ascending:!1});if(I)throw I;a=E,console.log("DEBUG: Permissive query succeeded")}}console.log(`DEBUG: Found ${(a==null?void 0:a.length)||0} messages in database for phone ${S}`),console.log("DEBUG: Messages data:",a),C(a),d.current=!0,F.provider==="receive_sms_online"&&(!a||a.length===0)&&D.current({type:"info",title:"No Messages Found",message:"Try syncing messages from receive-sms-online.info"})}catch(F){console.error("Error fetching phone messages:",F),b(F.message||"Failed to fetch phone messages"),D.current({type:"error",title:"Error",message:"Failed to fetch phone messages"})}finally{m(!1),N.current=!1}},[r]),U=n.useRef(z);U.current=z;const D=n.useRef(c);D.current=c,n.useEffect(()=>{let k=!0,f=!1;const S=async()=>{if(!(!k||!r))try{d.current||await U.current()}catch(a){console.error("Error loading initial phone messages:",a)}},F=()=>f||!k||!r?null:(f=!0,A.channel(`phone_messages:${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"phone_messages",filter:`phone_number_id=eq.${r}`},a=>{k&&(C(v=>[a.new,...v]),D.current({type:"info",title:"New Message",message:`New message received from ${a.new.sender}`}))}).subscribe());S();const s=F();return()=>{k=!1,s&&A.removeChannel(s),l.current&&(clearInterval(l.current),l.current=null)}},[r]);const $=n.useCallback(async k=>{var S,F;const f=k||r;if(!f)throw new Error("No phone number ID provided");try{const{data:s,error:a}=await A.from("phone_numbers").select("*").eq("id",f).single();if(a)throw a;if(s.provider==="receive_sms_online"&&s.external_url)try{const E=await fetch("/api/phone/receive-sms/preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:s.external_url,phoneNumberId:f})});if(!E.ok)throw new Error(`Backend request failed: ${E.status} ${E.statusText}`);const I=await E.json();if(I.success&&I.messages.length>0)return I.messages.map(P=>({id:`temp-${Date.now()}-${Math.random()}`,phone_number_id:f,sender:P.sender,message:P.message,received_at:P.received_at,message_source:"scraping",created_at:new Date().toISOString()}))}catch{try{const{ReceiveSmsOnlineScraper:I}=await De(async()=>{const{ReceiveSmsOnlineScraper:P}=await import("./receiveSmsOnlineScraper-DkEzJxaM.js");return{ReceiveSmsOnlineScraper:P}},[]),B=await I.scrapeMessages(s.external_url);if(B.success&&B.messages.length>0)return B.messages.map(L=>({id:`temp-${Date.now()}-${Math.random()}`,phone_number_id:f,sender:L.sender,message:L.message,received_at:L.received_at,message_source:"scraping",created_at:new Date().toISOString()}))}catch(I){throw console.error("Both backend and frontend scraping failed:",I),I}}else if(s.provider==="smspva"&&s.external_url)try{console.log(`[SMSPVA] Fetching messages for phone ${s.phone_number} (ID: ${s.external_url})`);const E=await fetch(`/api/phone/status/${f}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!E.ok)throw new Error(`SMSPVA API error: ${E.status}`);const I=await E.json();console.log("SMSPVA messages response:",I);const B=((S=I.data)==null?void 0:S.messages)||I.messages||[];if(B&&B.length>0){const P=[];for(const L of B)try{const{data:Q,error:ae}=await A.from("phone_messages").upsert({phone_number_id:f,sender:L.sender||"SMSPVA",message:L.text||L.message||"",received_at:L.received_at||new Date().toISOString(),message_source:"api"},{onConflict:"phone_number_id,sender,message"}).select().single();!ae&&Q&&P.push(Q)}catch(Q){console.error("Error inserting SMSPVA message:",Q)}return console.log(`[SMSPVA] Successfully processed ${P.length} messages`),P}else console.log("[SMSPVA] No messages found in API response")}catch(E){throw console.error("Error fetching SMSPVA messages:",E),E}else if(s.provider==="gogetsms"&&(s.external_url||s.rent_id))try{const E=s.external_url||s.rent_id;console.log(`[GOGETSMS] Fetching messages for phone ${s.phone_number} (Rental ID: ${E})`);const I=await fetch(`/api/phone/status/${f}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!I.ok)throw new Error(`GoGetSMS API error: ${I.status}`);const B=await I.json();console.log("GoGetSMS messages response:",B);const P=((F=B.data)==null?void 0:F.messages)||B.messages||[];if(P&&P.length>0){const L=[];for(const Q of P)try{const{data:ae,error:_e}=await A.from("phone_messages").upsert({phone_number_id:f,sender:Q.sender||"GoGetSMS",message:Q.text||Q.message||"",received_at:Q.received_at||new Date().toISOString(),message_source:"api"},{onConflict:"phone_number_id,sender,message"}).select().single();!_e&&ae&&L.push(ae)}catch(ae){console.error("Error inserting GoGetSMS message:",ae)}return console.log(`[GOGETSMS] Successfully processed ${L.length} messages`),L}else console.log("[GOGETSMS] No messages found in API response")}catch(E){throw console.error("Error fetching GoGetSMS messages:",E),E}const{data:v,error:T}=await A.from("phone_messages").select("*").eq("phone_number_id",f).order("received_at",{ascending:!1});if(T)throw T;return v}catch(s){throw console.error("Error fetching SMS immediately:",s),s}},[r]),Y=n.useCallback(async(k,f=!0)=>{const S=k||r;if(!S){f&&D.current({type:"error",title:"Error",message:"No phone number ID provided"});return}try{m(!0);const F=await $(S);C(F),f&&D.current({type:"success",title:"Messages Updated",message:`Found ${F.length} messages`})}catch(F){console.error("Error syncing messages:",F),f&&D.current({type:"error",title:"Sync Failed",message:F instanceof Error?F.message:"Failed to sync messages"})}finally{m(!1)}},[r,$]),H=n.useCallback(async()=>{if(!(!o||!r))try{if(console.log(`[AUTO-REFRESH] Syncing ${o.provider} phone number: ${o.phone_number}`),o.provider==="anosim"){const k=o.order_booking_id||o.external_url||o.rent_id;if(k){console.log(`[AUTO-REFRESH] Syncing Anosim booking ID: ${k}`);try{const f=await fetch(`/api/phone/sync/anosim/${k}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(f.ok){const S=await f.json();console.log("[AUTO-REFRESH] Anosim sync successful:",S)}else console.warn(`[AUTO-REFRESH] Anosim sync failed: ${f.status}`)}catch(f){console.warn("[AUTO-REFRESH] Anosim sync error:",f)}}}else if(o.provider==="smspva")try{(await fetch(`/api/phone/sync/smspva/${r}`,{method:"POST",headers:{"Content-Type":"application/json"}})).ok&&console.log("[AUTO-REFRESH] SMSPVA sync successful")}catch(k){console.warn("[AUTO-REFRESH] SMSPVA sync error:",k)}else o.provider==="receive_sms_online"&&await $(r);await z(r,!0)}catch(k){console.error("[AUTO-REFRESH] Error during sync:",k),await z(r,!0)}},[o,r,z,$]),Z=n.useCallback(()=>{if(!o||o.provider!=="receive_sms_online"&&o.provider!=="smspva"&&o.provider!=="anosim"&&o.provider!=="gogetsms"){D.current({type:"warning",title:"Not Supported",message:"Auto-refresh is only available for manual, SMSPVA, Anosim, and GoGetSMS phone numbers"});return}if(o.provider==="gogetsms"&&!o.external_url&&!o.rent_id){D.current({type:"warning",title:"Missing Rental ID",message:"GoGetSMS auto-refresh requires a rental ID"});return}_(k=>{const f=!k;return f?(l.current=setInterval(()=>{H()},15e3),D.current({type:"success",title:"Auto-Refresh Started",message:"Messages will refresh every 15 seconds with API sync"})):(l.current&&(clearInterval(l.current),l.current=null),D.current({type:"info",title:"Auto-Refresh Stopped",message:"Automatic message refresh has been disabled"})),f})},[o,r,H]),K=n.useCallback(()=>{let k=g;if(i!=="all"&&(k=k.filter(f=>i==="sms_activate"?f.message_source==="api"||!f.message_source:i==="receive_sms_online"?f.message_source==="scraping":i==="smspva"?f.message_source==="api":!0)),p.trim()){const f=p.toLowerCase();k=k.filter(S=>S.sender.toLowerCase().includes(f)||S.message.toLowerCase().includes(f))}return k},[g,i,p]),te=n.useCallback(()=>{const k=K();if(k.length===0){D.current({type:"warning",title:"No Messages",message:"No messages to export"});return}const f=[["Sender","Message","Received At","Source"].join(","),...k.map(a=>[`"${a.sender}"`,`"${a.message.replace(/"/g,'""')}"`,`"${new Date(a.received_at).toLocaleString()}"`,`"${a.message_source||"SMS-Activate"}"`].join(","))].join(`
`),S=new Blob([f],{type:"text/csv;charset=utf-8;"}),F=document.createElement("a"),s=URL.createObjectURL(S);F.setAttribute("href",s),F.setAttribute("download",`messages_${(o==null?void 0:o.phone_number)||"export"}_${new Date().toISOString().split("T")[0]}.csv`),F.style.visibility="hidden",document.body.appendChild(F),F.click(),document.body.removeChild(F),D.current({type:"success",title:"Export Complete",message:`Exported ${k.length} messages to CSV`})},[K,o]);return{messages:g,loading:t,error:y,phoneNumber:o,filterProvider:i,searchTerm:p,autoRefresh:j,fetchMessages:z,fetchSMSImmediately:$,addMessage:async k=>{try{const{data:f,error:S}=await A.from("phone_messages").insert({phone_number_id:k.phone_number_id,sender:k.sender,message:k.message}).select().single();if(S)throw S;return f}catch(f){throw console.error("Error adding phone message:",f),D.current({type:"error",title:"Error",message:"Failed to add phone message"}),f}},syncMessages:Y,toggleAutoRefresh:Z,filteredMessages:K(),exportMessages:te,setFilterProvider:u,setSearchTerm:w}},Qe=r=>{const[g,C]=n.useState(null),[t,m]=n.useState(!1),[y,b]=n.useState(null),o=n.useCallback(async()=>{if(!r){C(null);return}m(!0),b(null);try{let{data:h,error:i}=await A.from("phone_numbers").select("*").eq("id",r).single();if(i&&({data:h,error:i}=await A.from("phone_number").select("*").eq("id",r).single(),i&&({data:h,error:i}=await A.from("task_phone_numbers").select("*").eq("id",r).single(),i)))throw i;C(h)}catch(h){b(h.message||"Failed to fetch phone number details")}finally{m(!1)}},[r]);return n.useEffect(()=>{o()},[r,o]),{phoneNumber:g,loading:t,error:y,fetchPhoneNumber:o}},Je=({taskAssignment:r,onRefresh:g,onCompleteVideoChat:C,isLoading:t=!1,isAdminView:m=!1})=>{var F,s;const{colors:y}=xe(),[b,o]=n.useState(!1),[h,i]=n.useState(new Date),[u,p]=n.useState(!1),[w,j]=n.useState(!1),{messages:_,loading:c,error:d,fetchMessages:N,fetchSMSImmediately:R}=Ke(r.phone_number_id),{phoneNumber:l}=Qe(r.phone_number_id),[z,U]=n.useState(!1),D=n.useRef(!1);n.useEffect(()=>{r.phone_number_id&&!z&&((async()=>{try{await N(r.phone_number_id)}catch(v){console.error("Initial message load failed:",v)}})(),U(!0))},[r.phone_number_id,z]),n.useEffect(()=>{r.phone_number_id&&z&&!D.current&&_.length===0&&((l==null?void 0:l.provider)==="receive_sms_online"||(l==null?void 0:l.provider)==="smspva"||(l==null?void 0:l.provider)==="anosim"||(l==null?void 0:l.provider)==="gogetsms")&&(async()=>{try{if(D.current=!0,console.log(`[VideoCallAccepted] Auto-fetching SMS for provider: ${l==null?void 0:l.provider}`),l.provider==="anosim"){const v=l.order_booking_id||l.external_url||l.rent_id;v&&(console.log(`[VideoCallAccepted] Auto-syncing Anosim booking ID: ${v}`),(await fetch(`/api/phone/sync/anosim/${v}`,{method:"POST",headers:{"Content-Type":"application/json"}})).ok&&console.log("[VideoCallAccepted] Auto-sync successful"))}else await R(r.phone_number_id);await N(r.phone_number_id,!0)}catch(v){console.error("Auto-sync attempt failed:",v)}})()},[r.phone_number_id,z,_.length,l==null?void 0:l.provider]);const $=async()=>{if(!(!r.phone_number_id||c))try{if((l==null?void 0:l.provider)==="receive_sms_online"||(l==null?void 0:l.provider)==="smspva"||(l==null?void 0:l.provider)==="anosim"||(l==null?void 0:l.provider)==="gogetsms")if(console.log(`[VideoCallAccepted] Fetching SMS for provider: ${l.provider}`),l.provider==="anosim"){const a=l.order_booking_id||l.external_url||l.rent_id;if(a){console.log(`[VideoCallAccepted] Syncing Anosim booking ID: ${a}`);const v=await fetch(`/api/phone/sync/anosim/${a}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(v.ok){const T=await v.json();console.log("[VideoCallAccepted] Anosim sync response:",T)}else console.error("[VideoCallAccepted] Anosim sync failed:",v.status)}}else await R(r.phone_number_id);await N(r.phone_number_id,!0),x.success("SMS-Nachrichten aktualisiert")}catch(a){console.error("SMS refresh failed:",a),x.error("Fehler beim Aktualisieren der SMS-Nachrichten")}},Y=async()=>{if(!b){o(!0);try{await g(),i(new Date),x.success("Daten erfolgreich aktualisiert")}catch{x.error("Fehler beim Aktualisieren der Daten")}finally{o(!1)}}},H=a=>{try{return a.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})}catch{return"Unbekannt"}},Z=!!(r.demo_email||r.demo_password||r.ident_code||r.ident_url);r.phone_number_id||(F=r.task_template)!=null&&F.play_store_url||(s=r.task_template)!=null&&s.app_store_url;const K=!Z,te=Z&&w,se=()=>{var a;return(a=r.task_template)==null?void 0:a.play_store_url},k=()=>{var a;return(a=r.task_template)==null?void 0:a.app_store_url},f=a=>{try{return qe(new Date(a),{addSuffix:!0,locale:Re})}catch{return"Unbekannt"}},S=(a,v)=>{a&&(navigator.clipboard.writeText(a),x.success(`${v} in die Zwischenablage kopiert!`))};return e.jsx(e.Fragment,{children:e.jsxs(O,{className:"w-full h-full shadow-sm border-0 overflow-hidden",children:[e.jsx("div",{className:`h-1 w-full bg-[${y.primary}] dark:bg-[${y.primaryLight}]`}),e.jsxs(G,{className:"text-center border-b border-gray-100 dark:border-gray-800 pb-6",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"bg-green-100 dark:bg-green-900/30 p-4 rounded-full shadow-sm",children:e.jsx(le,{className:"text-green-600 dark:text-green-400",size:40})})}),e.jsx(q,{className:"text-2xl font-bold",children:"Vielen Dank für dein Einverständnis"})]}),e.jsx(W,{className:"pt-6",children:e.jsxs("div",{className:"max-w-none mb-6",children:[e.jsx("div",{className:"bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-6 border border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mt-0.5",children:e.jsx(ce,{size:16,className:"text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 mb-2",children:"Demo-Daten werden vorbereitet"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-2",children:"Bearbeitungszeit: Bis zu 3 Stunden (meist schneller)"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-500",children:"Die Seite aktualisiert sich automatisch, wenn die Daten bereitstehen."})]})]})}),e.jsxs("div",{className:"flex justify-between items-center text-sm text-gray-600 dark:text-gray-300 mb-4 bg-gray-50 dark:bg-gray-800/50 p-3 rounded-md border border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ce,{size:16,className:"mr-2 text-gray-500 dark:text-gray-400"}),e.jsxs("span",{children:["Zuletzt aktualisiert: ",H(h)]})]}),e.jsx(M,{size:"sm",variant:"ghost",onClick:Y,disabled:b,leftIcon:e.jsx(ge,{size:14,className:b?"animate-spin":""}),children:"Aktualisieren"})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-3 sm:gap-6 p-0 sm:p-5",children:[e.jsx("div",{className:"w-full lg:w-[30%] order-2 lg:order-1",children:e.jsxs(O,{className:"h-full shadow-sm border-0 overflow-hidden",children:[e.jsx("div",{className:`h-1 w-full bg-[${y.accent}] dark:bg-[${y.accentLight}]`}),e.jsxs(G,{className:"flex flex-row items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-gray-800",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`p-2 rounded-lg bg-[${y.accent}]/10 dark:bg-gray-700 text-[${y.accent}] dark:text-white mr-2`,children:e.jsx(me,{size:16})}),e.jsx(q,{className:"font-app font-app-medium text-gray-900 dark:text-white text-sm",children:"SMS Nachrichten"})]}),r.phone_number_id&&e.jsx(M,{size:"sm",variant:"ghost",onClick:$,disabled:c,leftIcon:e.jsx(ge,{size:12,className:c?"animate-spin":""}),children:"Aktualisieren"})]}),e.jsx(W,{className:"p-2 sm:p-4",children:c?e.jsxs("div",{className:"space-y-3",children:[e.jsx(X,{className:"h-20 w-full rounded-md"}),e.jsx(X,{className:"h-20 w-full rounded-md"})]}):d?e.jsxs("div",{className:"text-center p-4 text-red-500 dark:text-red-400",children:[e.jsx(he,{size:20,className:"mx-auto mb-2"}),e.jsx("p",{className:"text-sm",children:"Fehler beim Laden der Nachrichten."})]}):_&&_.length>0?e.jsxs("div",{className:"space-y-3",children:[(()=>{const a=_[0];return e.jsxs("div",{className:"p-3 rounded-lg text-sm bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/50 ml-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("span",{className:"font-medium text-xs text-gray-500 dark:text-gray-400",children:"Neueste SMS"}),e.jsx("span",{className:"text-xs text-gray-400 dark:text-gray-500",children:f(a.received_at)})]}),e.jsx("p",{className:"m-0 whitespace-pre-wrap break-words text-gray-700 dark:text-gray-300",children:a.message}),e.jsx(M,{variant:"ghost",size:"xs",className:"mt-1 h-7 w-7 p-0 rounded-full",onClick:()=>S(a.message,"SMS-Nachricht"),title:"SMS-Nachricht kopieren",children:e.jsx(J,{size:14})})]},0)})(),_.length>1&&e.jsxs("div",{className:"text-center p-2 text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 rounded-md border border-gray-100 dark:border-gray-700",children:[e.jsx(me,{size:12,className:"inline mr-1"}),_.length-1," weitere Nachricht",_.length>2?"en":""," vorhanden"]})]}):e.jsxs("div",{className:"text-center p-4 text-gray-500 dark:text-gray-400",children:[e.jsx(Ae,{size:20,className:"mx-auto mb-2"}),e.jsx("p",{className:"text-sm",children:"Keine SMS-Nachrichten vorhanden."})]})})]})}),e.jsx("div",{className:"w-full lg:w-[70%] order-1 lg:order-2 px-0",children:e.jsxs(O,{className:"h-full shadow-sm border-0 overflow-hidden",children:[e.jsx("div",{className:`h-1 w-full bg-[${y.primary}] dark:bg-[${y.primaryLight}]`}),e.jsxs(G,{className:"flex flex-row items-center px-5 py-4 border-b border-gray-100 dark:border-gray-800",children:[e.jsx("div",{className:`p-2 rounded-lg bg-[${y.primary}]/10 dark:bg-gray-700 text-[${y.primary}] dark:text-white mr-3`,children:e.jsx(oe,{size:18})}),e.jsx(q,{className:"font-app font-app-medium text-gray-900 dark:text-white",children:"Test-Daten"})]}),e.jsx(W,{className:"p-2 sm:p-5",children:K?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-6",children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"w-16 h-16 border-4 border-gray-200 dark:border-gray-700 border-t-blue-500 rounded-full animate-spin"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(oe,{className:"text-blue-500",size:24})})]}),e.jsxs("div",{className:"text-center max-w-md",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-3",children:"Deine Test-Daten werden vorbereitet"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4 leading-relaxed",children:"Wir beantragen gerade deine Demo-Daten für den Video-Chat. Das kann bis zu 3 Stunden dauern, meistens geht es aber deutlich schneller."}),e.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-800 mb-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(he,{className:"text-blue-500 mr-3 mt-0.5 flex-shrink-0",size:20}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-blue-800 dark:text-blue-300 text-sm font-medium mb-1",children:"Was passiert als nächstes?"}),e.jsx("p",{className:"text-blue-700 dark:text-blue-300 text-sm",children:"Sobald deine Daten bereitstehen, erscheinen sie automatisch hier. Du kannst diese Seite geöffnet lassen oder später zurückkehren."})]})]})}),e.jsxs("div",{className:"flex justify-center items-center space-x-1 mb-4",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Seite wird automatisch aktualisiert..."})]})]}):e.jsxs("div",{className:"grid grid-cols-1 gap-2 sm:gap-4",children:[r.phone_number_id&&l&&e.jsx("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gray-100 dark:bg-gray-700 mr-3",children:e.jsx(ze,{size:16,className:"text-gray-600 dark:text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:"Telefonnummer"}),e.jsx("p",{className:"text-lg font-mono text-gray-800 dark:text-gray-200 mt-1",children:l.phone_number})]})]}),e.jsx(M,{variant:"ghost",size:"sm",className:"flex-shrink-0",onClick:()=>S(l.phone_number,"Telefonnummer"),title:"Telefonnummer kopieren",children:e.jsx(J,{size:14})})]})}),r.demo_email&&e.jsx("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gray-100 dark:bg-gray-700 mr-3",children:e.jsx(Fe,{size:16,className:"text-gray-600 dark:text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:"Demo E-Mail"}),e.jsx("p",{className:"text-sm font-mono text-gray-800 dark:text-gray-200 mt-1 break-all",children:r.demo_email})]})]}),e.jsx(M,{variant:"ghost",size:"sm",className:"flex-shrink-0",onClick:()=>S(r.demo_email,"E-Mail"),title:"E-Mail kopieren",children:e.jsx(J,{size:14})})]})}),r.demo_password&&e.jsx("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gray-100 dark:bg-gray-700 mr-3",children:e.jsx(ye,{size:16,className:"text-gray-600 dark:text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:"Demo Passwort"}),e.jsx("p",{className:"text-sm font-mono text-gray-800 dark:text-gray-200 mt-1 break-all",children:r.demo_password})]})]}),e.jsx(M,{variant:"ghost",size:"sm",className:"flex-shrink-0",onClick:()=>S(r.demo_password,"Passwort"),title:"Passwort kopieren",children:e.jsx(J,{size:14})})]})}),r.ident_code&&e.jsx("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gray-100 dark:bg-gray-700 mr-3",children:e.jsx(ye,{size:16,className:"text-gray-600 dark:text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:"Ident-Code"}),e.jsx("p",{className:"text-sm font-mono text-gray-800 dark:text-gray-200 mt-1 break-all",children:r.ident_code})]})]}),e.jsx(M,{variant:"ghost",size:"sm",className:"flex-shrink-0",onClick:()=>S(r.ident_code,"Ident-Code"),title:"Ident-Code kopieren",children:e.jsx(J,{size:14})})]})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[r.ident_url&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 rounded-lg bg-gray-100 dark:bg-gray-700 mr-3",children:e.jsx(Ge,{size:16,className:"text-gray-600 dark:text-gray-400"})}),e.jsx("h4",{className:"text-sm font-medium text-gray-900 dark:text-gray-100",children:"Ident-Prozess"})]}),e.jsx(M,{variant:"ghost",size:"sm",className:"flex-shrink-0",onClick:()=>S(r.ident_url,"Ident-URL"),title:"Ident-URL kopieren",children:e.jsx(J,{size:14})})]}),e.jsx(M,{size:"md",variant:"primary",className:"w-full",leftIcon:e.jsx(de,{size:16}),onClick:()=>window.open(r.ident_url,"_blank"),children:"Ident-Prozess öffnen"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[se()&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-1.5 rounded-lg bg-gray-100 dark:bg-gray-700 mr-2",children:e.jsx(oe,{size:14,className:"text-gray-600 dark:text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 dark:text-gray-100",children:"Android App"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Google Play Store"})]})]}),e.jsx(M,{variant:"ghost",size:"sm",className:"flex-shrink-0",onClick:()=>S(se(),"Play Store URL"),title:"Play Store URL kopieren",children:e.jsx(J,{size:12})})]}),e.jsx(M,{size:"sm",variant:"secondary",className:"w-full",leftIcon:e.jsx(de,{size:14}),onClick:()=>window.open(se(),"_blank"),children:"Play Store öffnen"})]}),k()&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-1.5 rounded-lg bg-gray-100 dark:bg-gray-700 mr-2",children:e.jsx(oe,{size:14,className:"text-gray-600 dark:text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-900 dark:text-gray-100",children:"iOS App"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Apple App Store"})]})]}),e.jsx(M,{variant:"ghost",size:"sm",className:"flex-shrink-0",onClick:()=>S(k(),"App Store URL"),title:"App Store URL kopieren",children:e.jsx(J,{size:12})})]}),e.jsx(M,{size:"sm",variant:"secondary",className:"w-full",leftIcon:e.jsx(de,{size:14}),onClick:()=>window.open(k(),"_blank"),children:"App Store öffnen"})]})]})]})]})})]})})]}),!m&&C&&e.jsxs("div",{className:"mt-8 space-y-4",children:[K&&e.jsxs("div",{className:"p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ce,{className:"text-yellow-600 dark:text-yellow-400 mr-2",size:20}),e.jsx("p",{className:"text-yellow-800 dark:text-yellow-200 font-medium",children:"Bitte warten, bis die Testdaten von einem Administrator zugewiesen wurden."})]}),e.jsx("p",{className:"text-yellow-700 dark:text-yellow-300 text-sm mt-2",children:"Erst dann können Sie mit der Aufgabe fortfahren."})]}),Z&&e.jsx("div",{className:"p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg",children:e.jsxs("label",{className:"flex items-start space-x-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:w,onChange:a=>j(a.target.checked),className:"mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-blue-800 dark:text-blue-200 font-medium",children:"Ich habe den Video-Ident Test erfolgreich abgeschlossen"}),e.jsx("p",{className:"text-blue-700 dark:text-blue-300 text-sm mt-1",children:"Bestätigen Sie, dass Sie alle Testdaten erhalten und den Video-Ident-Prozess erfolgreich durchgeführt haben."})]})]})}),e.jsx("div",{className:"flex justify-center sm:justify-end",children:e.jsx(re,{onClick:C,disabled:t||!te,className:`px-10 py-3 text-lg font-semibold whitespace-nowrap min-w-[280px] w-full sm:w-auto ${te?"bg-green-600 hover:bg-green-700 text-white":"bg-gray-400 cursor-not-allowed text-white"}`,children:e.jsxs("div",{className:"flex items-center justify-center space-x-3",children:[e.jsx(le,{size:18}),e.jsx("span",{children:K?"Warten auf Testdaten...":w?"Video-Chat abschließen":"Video-Ident Test abschließen"})]})})})]})]})})]})})},Xe=({onRestart:r,isLoading:g=!1})=>{const C=async()=>{g||await r()};return e.jsxs(O,{className:"w-full h-full shadow-lg border border-gray-200 dark:border-gray-800",children:[e.jsxs(G,{className:"text-center border-b border-gray-100 dark:border-gray-800 pb-6",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"bg-red-100 dark:bg-red-900/30 p-4 rounded-full shadow-sm",children:e.jsx(pe,{className:"text-red-600 dark:text-red-400",size:40})})}),e.jsx(q,{className:"text-2xl font-bold",children:"Die Bewertung ist fehlgeschlagen"})]}),e.jsx(W,{className:"pt-8",children:e.jsxs("div",{className:"prose dark:prose-invert max-w-none mb-8 text-center",children:[e.jsx("p",{className:"text-gray-700 dark:text-gray-300 text-lg",children:"Du kannst jederzeit zurückkehren und die Bewertung neu starten, sobald du bereit für den Video-Call bist."}),e.jsx("div",{className:"mt-10 flex justify-center",children:e.jsx(re,{onClick:C,disabled:g,className:"px-8 py-2 text-base font-medium whitespace-nowrap bg-blue-600 hover:bg-blue-700 text-white min-w-[180px]",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(ge,{size:16}),e.jsx("span",{children:g?"Wird zurückgesetzt...":"Aufgabe neu starten"})]})})})]})})]})},V=[];for(let r=0;r<256;++r)V.push((r+256).toString(16).slice(1));function Ye(r,g=0){return(V[r[g+0]]+V[r[g+1]]+V[r[g+2]]+V[r[g+3]]+"-"+V[r[g+4]]+V[r[g+5]]+"-"+V[r[g+6]]+V[r[g+7]]+"-"+V[r[g+8]]+V[r[g+9]]+"-"+V[r[g+10]]+V[r[g+11]]+V[r[g+12]]+V[r[g+13]]+V[r[g+14]]+V[r[g+15]]).toLowerCase()}let ue;const er=new Uint8Array(16);function rr(){if(!ue){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ue=crypto.getRandomValues.bind(crypto)}return ue(er)}const tr=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),je={randomUUID:tr};function sr(r,g,C){var m;if(je.randomUUID&&!r)return je.randomUUID();r=r||{};const t=r.random??((m=r.rng)==null?void 0:m.call(r))??rr();if(t.length<16)throw new Error("Random bytes length must be >= 16");return t[6]=t[6]&15|64,t[8]=t[8]&63|128,Ye(t)}const ar=()=>{const[r,g]=n.useState(!1),[C,t]=n.useState(null),m=n.useCallback(async(h,i,u,p={})=>{if(!h)return x.error("Keine Datei zum Hochladen ausgewählt"),null;try{g(!0),t(null);const w=h.name.split(".").pop(),j=`${sr()}.${w}`,_=u?`${u}/${j}`:j,{data:c,error:d}=await ee(async()=>await A.storage.from(i).upload(_,h,{cacheControl:"3600",upsert:!1,contentType:h.type,duplex:"half",metadata:p}));if(d)throw d;if(!c)throw new Error("Upload failed: No data returned");const{data:N}=A.storage.from(i).getPublicUrl(c.path);if(!N||!N.publicUrl)throw new Error("Failed to get public URL for file");const R={id:c.path,name:h.name,size:h.size,type:h.type,url:N.publicUrl,created_at:new Date().toISOString(),...p};return x.success("Datei erfolgreich hochgeladen"),R}catch(w){console.error("Error uploading file:",w);const j=w instanceof Error?w.message:"Fehler beim Hochladen der Datei";return t(w instanceof Error?w:new Error(j)),x.error(j),null}finally{g(!1)}},[]),y=n.useCallback(async(h,i)=>{try{t(null);const{data:u,error:p}=await ee(async()=>await A.storage.from(h).download(i));if(p)throw p;if(!u)throw new Error("Download failed: No data returned");const w=URL.createObjectURL(u),j=document.createElement("a");j.href=w,j.download=i.split("/").pop()||"download",document.body.appendChild(j),j.click(),URL.revokeObjectURL(w),document.body.removeChild(j),x.success("Datei wird heruntergeladen")}catch(u){console.error("Error downloading file:",u);const p=u instanceof Error?u.message:"Fehler beim Herunterladen der Datei";t(u instanceof Error?u:new Error(p)),x.error(p)}},[]),b=n.useCallback(async(h,i)=>{try{t(null);const{error:u}=await ee(async()=>await A.storage.from(h).remove([i]));if(u)throw u;return x.success("Datei erfolgreich gelöscht"),!0}catch(u){console.error("Error deleting file:",u);const p=u instanceof Error?u.message:"Fehler beim Löschen der Datei";return t(u instanceof Error?u:new Error(p)),x.error(p),!1}},[]),o=n.useCallback(async(h,i="")=>{try{t(null);const{data:u,error:p}=await ee(async()=>await A.storage.from(h).list(i,{sortBy:{column:"created_at",order:"desc"}}));if(p)throw p;return u?await Promise.all(u.filter(j=>!j.id.endsWith("/")).map(async j=>{var c,d;const{data:_}=A.storage.from(h).getPublicUrl(i?`${i}/${j.name}`:j.name);return{id:j.id,name:j.name,size:((c=j.metadata)==null?void 0:c.size)||0,type:((d=j.metadata)==null?void 0:d.mimetype)||"",url:_.publicUrl,created_at:j.created_at}})):[]}catch(u){console.error("Error listing files:",u);const p=u instanceof Error?u.message:"Fehler beim Auflisten der Dateien";return t(u instanceof Error?u:new Error(p)),x.error(p),[]}},[]);return{uploading:r,error:C,uploadFile:m,downloadFile:y,deleteFile:b,listFiles:o}},nr=r=>{const[g,C]=n.useState([]),[t,m]=n.useState(!1),[y,b]=n.useState(null),{user:o}=ve(),{uploadFile:h,downloadFile:i,deleteFile:u}=ar(),p="task-attachments",w=n.useCallback(async d=>{const N=d||r;if(!N){console.error("No task ID provided");return}try{m(!0),b(null);const{data:R,error:l}=await A.from("task_assignments").select("task_id").eq("id",N).single();if(l)throw l;if(!(R!=null&&R.task_id))throw new Error("Task ID not found in assignment");const{data:z,error:U}=await ee(async()=>await A.from("task_attachments").select("*").eq("task_id",R.task_id).order("created_at",{ascending:!1}));if(U)throw U;C(z)}catch(R){console.error("Error fetching task attachments:",R),b(R instanceof Error?R:new Error("Failed to fetch attachments")),x.error("Fehler beim Laden der Anhänge")}finally{m(!1)}},[r]),j=n.useCallback(async(d,N,R)=>{if(!o)return x.error("Sie müssen angemeldet sein, um Dateien hochzuladen"),null;try{m(!0),b(null);const{data:l,error:z}=await A.from("task_assignments").select("task_id").eq("id",N).single();if(z)throw console.error("Error getting task assignment:",z),new Error("Fehler beim Abrufen der Aufgabenzuweisung");if(!l||!l.task_id)throw new Error("Aufgabe nicht gefunden");const U=l.task_id,D=`${o.id}/${N}`,$=await h(d,p,D,{task_id:U,user_id:o.id});if(!$)throw new Error("Datei konnte nicht hochgeladen werden");const{data:Y,error:H}=await ee(async()=>await A.from("task_attachments").insert([{task_id:U,user_id:o.id,file_name:d.name,file_path:$.id,file_type:d.type,file_size:d.size,storage_bucket:p,public_url:$.url}]).select().single());if(H)throw H;const Z={...Y,attachment_type:R};return await w(N),Z}catch(l){return console.error("Error uploading task attachment:",l),b(l instanceof Error?l:new Error("Failed to upload attachment")),x.error("Fehler beim Hochladen des Anhangs"),null}finally{m(!1)}},[o,h,w]),_=n.useCallback(async d=>{try{await i(p,d.file_path)}catch(N){console.error("Error downloading task attachment:",N),x.error("Fehler beim Herunterladen des Anhangs")}},[i]),c=n.useCallback(async d=>{try{if(m(!0),b(null),!await u(p,d.file_path))throw new Error("Datei konnte nicht gelöscht werden");const{error:R}=await ee(async()=>await A.from("task_attachments").delete().eq("id",d.id));if(R)throw R;return await w(r),x.success("Anhang erfolgreich gelöscht"),!0}catch(N){return console.error("Error deleting task attachment:",N),b(N instanceof Error?N:new Error("Failed to delete attachment")),x.error("Fehler beim Löschen des Anhangs"),!1}finally{m(!1)}},[u,w,r]);return n.useState(()=>{r&&w()}),{attachments:g,loading:t,error:y,fetchAttachments:w,uploadTaskAttachment:j,downloadTaskAttachment:_,deleteTaskAttachment:c}},ir=({attachments:r,onDownload:g,onDelete:C,isLoading:t=!1})=>{if(t)return e.jsxs("div",{className:"py-4 text-center text-gray-500 dark:text-gray-400",children:[e.jsx("div",{className:"animate-pulse flex justify-center",children:e.jsx("div",{className:"h-8 w-8 bg-gray-200 dark:bg-gray-700 rounded-full"})}),e.jsx("p",{className:"mt-2",children:"Anhänge werden geladen..."})]});if(r.length===0)return e.jsx("div",{className:"py-4 text-center text-gray-500 dark:text-gray-400",children:e.jsx("p",{children:"Keine Anhänge vorhanden"})});const m=i=>{switch(i.split("/")[0]){case"image":return e.jsx(Me,{size:20});case"video":return e.jsx(fe,{size:20});case"audio":return e.jsx(ne,{size:20});case"application":return i.includes("pdf")?e.jsx(ne,{size:20}):i.includes("zip")||i.includes("rar")||i.includes("tar")?e.jsx(ne,{size:20}):e.jsx(ne,{size:20});default:return e.jsx(ne,{size:20})}},y=i=>i<1024?`${i} B`:i<1024*1024?`${(i/1024).toFixed(1)} KB`:`${(i/(1024*1024)).toFixed(1)} MB`,b=i=>new Date(i).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"}),o={hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.05}}},h={hidden:{opacity:0,y:20},show:{opacity:1,y:0}};return e.jsx(ie.div,{className:"space-y-2",variants:o,initial:"hidden",animate:"show",children:r.map(i=>e.jsxs(ie.div,{className:"flex items-center justify-between bg-gray-50 dark:bg-gray-800 rounded px-3 py-2",variants:h,children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"text-gray-600 dark:text-gray-400",children:m(i.file_type)}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 truncate max-w-xs",children:i.file_name}),e.jsxs("div",{className:"flex text-xs text-gray-500 dark:text-gray-400 space-x-2",children:[e.jsx("span",{children:y(i.file_size)}),e.jsx("span",{children:"•"}),e.jsx("span",{children:b(i.created_at)})]})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>g(i),title:"Herunterladen",children:e.jsx(Te,{size:16})}),e.jsx(M,{variant:"ghost",size:"sm",onClick:()=>C(i),title:"Löschen",children:e.jsx(pe,{size:16,className:"text-red-500"})})]})]},i.id))})},lr=({taskAssignment:r,onComplete:g,onBack:C})=>{var _;const{attachments:t,loading:m,uploadTaskAttachment:y,downloadTaskAttachment:b,deleteTaskAttachment:o,fetchAttachments:h}=nr(r.id),[i,u]=n.useState(!1),p=((_=r.task_template)==null?void 0:_.required_attachments)||[];n.useEffect(()=>{h()},[h]);const w=async(c,d)=>{try{await y(c,r.id,d),x.success("Dokument erfolgreich hochgeladen")}catch(N){console.error("Error uploading document",N),x.error("Fehler beim Hochladen des Dokuments")}},j=async()=>{if(p.length>0&&p.some(c=>c.required)&&t.length===0){x.error("Bitte laden Sie die erforderlichen Dokumente hoch");return}u(!0);try{await g()}catch(c){console.error("Error completing document step",c),x.error("Fehler beim Abschließen des Dokumentenschritts")}finally{u(!1)}};return e.jsxs(O,{className:"w-full max-w-3xl mx-auto",children:[e.jsx(G,{children:e.jsx(q,{className:"text-xl font-bold",children:"Dokumente hochladen"})}),e.jsx(W,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Bitte laden Sie die erforderlichen Dokumente für diese Aufgabe hoch."}),p.length>0?e.jsx("div",{className:"space-y-4",children:p.map((c,d)=>e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-md p-4",children:[e.jsxs("h3",{className:"font-medium mb-2 text-gray-700 dark:text-gray-300",children:[c.name,c.required&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),c.description&&e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-3",children:c.description}),e.jsx(we,{acceptedTypes:["application/pdf","image/jpeg","image/png"],maxSizeMB:10,onFileSelect:N=>w(N,c.name),label:`${c.name} hochladen`,showPreview:!1})]},d))}):e.jsx("div",{className:"border border-gray-200 dark:border-gray-700 rounded-md p-4",children:e.jsx(we,{acceptedTypes:["application/pdf","image/jpeg","image/png"],maxSizeMB:10,onFileSelect:c=>w(c),label:"Dokument hochladen",showPreview:!1})}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"font-medium mb-3 text-gray-700 dark:text-gray-300",children:"Hochgeladene Dokumente:"}),e.jsx(ir,{attachments:t,onDownload:b,onDelete:o,isLoading:m})]}),e.jsxs("div",{className:"flex justify-between mt-8",children:[e.jsx(M,{onClick:C,variant:"outline",style:{display:"inline-flex",alignItems:"center",whiteSpace:"nowrap",minWidth:"120px",padding:"8px 16px"},children:"← Zurück"}),e.jsx(re,{onClick:j,disabled:i,className:"bg-green-600 hover:bg-green-700 text-white px-8 py-2 text-base font-medium whitespace-nowrap min-w-[240px]",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx("span",{children:"Dokumente bestätigen & abschließen"}),e.jsx(le,{size:16})]})})]})]})})]})},or=({onSubmit:r,onBack:g})=>{const[C,t]=n.useState(!1),{control:m,handleSubmit:y,formState:{errors:b}}=Ie({defaultValues:{callQuality:0,agentProfessionalism:0,callHelpfulness:0,feedback:""}}),o=async i=>{try{t(!0),await r(i)}catch(u){console.error("Failed to submit video call rating:",u),x.error("Bewertung konnte nicht gespeichert werden"),t(!1)}},h=({name:i,label:u,control:p,error:w})=>e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300",children:u}),e.jsx(be,{name:i,control:p,rules:{required:!0,min:1},render:({field:{onChange:j,value:_}})=>e.jsx("div",{className:"flex items-center",children:[1,2,3,4,5].map(c=>e.jsx("button",{type:"button",onClick:()=>j(c),className:`p-1 focus:outline-none transition-all ${_>=c?"text-yellow-500 scale-110":"text-gray-300 dark:text-gray-500 hover:text-yellow-300"}`,disabled:C,children:e.jsx($e,{size:32,fill:_>=c?"currentColor":"none"})},c))})}),w&&e.jsx("p",{className:"mt-1 text-red-500 text-sm",children:w})]});return e.jsxs(O,{className:"w-full h-full overflow-auto",children:[e.jsxs(G,{children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(fe,{className:"text-blue-500 mr-2",size:24}),e.jsx(q,{className:"text-xl font-bold",children:"Video-Chat Bewertung"})]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1",children:"Bitte bewerte deine Erfahrung mit dem Video-Chat"})]}),e.jsx(W,{children:e.jsxs("form",{onSubmit:y(o),children:[e.jsx(h,{name:"callQuality",label:"Wie war die Verbindungsqualität des Video-Chats?",control:m,error:b.callQuality?"Bitte wähle eine Bewertung":void 0}),e.jsx(h,{name:"agentProfessionalism",label:"Wie professionell war der Support-Mitarbeiter während des Gesprächs?",control:m,error:b.agentProfessionalism?"Bitte wähle eine Bewertung":void 0}),e.jsx(h,{name:"callHelpfulness",label:"Wie hilfreich war der Video-Chat für deine Aufgabe?",control:m,error:b.callHelpfulness?"Bitte wähle eine Bewertung":void 0}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300",children:"Hast du weitere Anmerkungen oder Feedback zum Video-Chat?"}),e.jsx(be,{name:"feedback",control:m,render:({field:i})=>e.jsx("textarea",{...i,className:"w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 dark:border-gray-700 transition-all",rows:4,placeholder:"Dein Feedback hilft uns, den Video-Chat Service zu verbessern",disabled:C})})]}),e.jsxs("div",{className:"flex justify-between mt-8",children:[e.jsx(M,{type:"button",onClick:g,variant:"outline",disabled:C,style:{display:"inline-flex",alignItems:"center",whiteSpace:"nowrap",minWidth:"120px",padding:"8px 16px"},children:"← Zurück"}),e.jsx(re,{type:"submit",disabled:C,className:"bg-green-600 hover:bg-green-700",children:e.jsxs("div",{className:"flex items-center",children:[C?"Wird gespeichert...":"Bewertung abschicken",e.jsx(le,{size:16,className:"ml-1"})]})})]})]})})]})},kr=()=>{const{assignmentId:r}=Ve(),g=Be(),{user:C}=ve(),{taskAssignment:t,isLoading:m,error:y,fetchTaskAssignment:b,updateCurrentStep:o,updateVideoChatStatus:h,submitTaskRating:i,submitVideoCallRating:u,restartRejectedTask:p}=Pe(r),w=n.useRef(null),j=async()=>{if(console.log("Refreshing task assignment data for ID:",r),!r){console.error("Cannot refresh: No assignment ID available");return}try{const s=await b();console.log("Fresh task data fetched:",s),s&&s.video_chat_status==="accepted"?(console.log("Video chat status is accepted, showing accepted view"),d("video_accepted"),s.phone_number_id&&console.log("Task has phone number assigned:",s.phone_number_id)):s?(console.log("Task data refreshed but video_chat_status is:",s.video_chat_status),s.current_step===0?d("details"):s.current_step>0&&s.video_chat_status==="not_started"&&d("instructions")):console.log("No fresh data returned from fetchTaskAssignment")}catch(s){console.error("Error refreshing task assignment data:",s),x.error("Fehler beim Aktualisieren der Daten")}},_=s=>{var T,E,I;if(!s)return"details";if(s.status==="completed")return"completed";const a=(T=s.task_template)==null?void 0:T.type,v=a==="platzhalter"||a==="andere"||a==="other";if(!v&&s.video_chat_status==="completed"&&s.video_call_rating_completed!==!0)return"video_call_rating";if(!v&&s.document_step_required&&!s.document_step_completed&&s.video_chat_status==="completed"&&s.video_call_rating_completed===!0)return"document_upload";if(!v){const B=s.video_chat_status;if(B==="accepted")return"video_accepted";if(B==="declined")return"video_declined"}return s.current_step===0?"details":s.current_step>0&&(v||s.video_chat_status==="not_started")?s.current_step<(((I=(E=s.task_template)==null?void 0:E.steps)==null?void 0:I.length)||0)?"instructions":"rating":"details"},[c,d]=n.useState(()=>_(t));n.useEffect(()=>{console.log("TaskFlow component mounted or updated with assignmentId:",r),console.log("Current taskAssignment state:",t),console.log("Current flow step:",c),y&&(Object.keys(y).length>0||y instanceof Error)&&console.error("TaskFlow error:",y)},[r,t,c,y]),n.useEffect(()=>()=>{console.log("TaskFlow component unmounting, cleaning up"),w.current&&(clearInterval(w.current),w.current=null)},[]);const N=n.useRef(!1);n.useEffect(()=>{r&&!t&&!m&&!N.current&&(console.log("No task assignment loaded, attempting to fetch..."),N.current=!0,b().then(s=>{s||console.log("Failed to fetch task assignment on initial load")}))},[r,t,m,b]),n.useEffect(()=>{N.current=!1},[r]);const R=n.useRef(null);n.useEffect(()=>{if(!t){console.log("No task assignment data available");return}if(R.current&&JSON.stringify(R.current)===JSON.stringify(t)){console.log("Task assignment unchanged, skipping flow step update");return}if(z.current){console.log("Manual flow change in progress, skipping automatic flow step determination");return}R.current=t,console.log("Determining flow step based on task assignment state:",t),console.log("Current video_chat_status:",t.video_chat_status),console.log("Video call rating completed:",t.video_call_rating_completed),console.log("Document step required:",t.document_step_required),console.log("Document step completed:",t.document_step_completed);const s=_(t);console.log("Setting flow step to:",s),d(s)},[t]);const l=n.useRef(!1),z=n.useRef(!1),U=async()=>{if(l.current){console.log("Action already in progress, ignoring additional click");return}console.log("handleStartTask called, current step:",c);try{if(l.current=!0,!t){console.error("Cannot proceed: taskAssignment is null"),x.error("Fehler: Aufgabendaten nicht verfügbar"),l.current=!1;return}z.current=!0,d("instructions"),console.log("Updating current step to 1..."),o(1).then(s=>{console.log("updateCurrentStep background result:",s),setTimeout(()=>{z.current=!1},1e3)}).catch(s=>{console.error("Background step update failed:",s),z.current=!1}).finally(()=>{setTimeout(()=>{l.current=!1},500)})}catch(s){console.error("Error starting task:",s),x.error("Fehler beim Starten der Aufgabe"),d("instructions"),l.current=!1,z.current=!1}},D=async()=>{var v,T;if(!t)return;const s=t.current_step+1,a=((T=(v=t.task_template)==null?void 0:v.steps)==null?void 0:T.length)||0;if(s<=a)try{await o(s),d("instructions")}catch(E){console.error("Error navigating to next instruction:",E),x.error("Fehler beim Navigieren zum nächsten Anweisung")}else d("rating")},$=async()=>{if(!(!t||t.current_step<=1))try{await o(t.current_step-1)}catch(s){console.error("Error navigating to previous instruction:",s),x.error("Fehler beim Navigieren zur vorherigen Anweisung")}},Y=async s=>{var a,v,T;if(t)if(await i(s),((a=t.task_template)==null?void 0:a.type)==="platzhalter"||((v=t.task_template)==null?void 0:v.type)==="andere"||((T=t.task_template)==null?void 0:T.type)==="other")try{console.log("Task type is platzhalter/andere/other, marking as completed directly.");const{error:E}=await A.from("task_assignments").update({status:"completed"}).eq("id",t.id);if(E)throw E;await b(),d("completed"),x.success("Aufgabe erfolgreich abgeschlossen!")}catch(E){console.error("Error completing task:",E),x.error("Fehler beim Abschließen der Aufgabe")}else d("video_decision")},H=async()=>{if(!t){console.error("Cannot accept video chat: no task assignment available"),x.error("Fehler: Aufgabe nicht gefunden");return}console.log("Accepting video chat for task:",t.id);try{z.current=!0,d("video_accepted"),console.log("Sending status update to database...");const s=await h("accepted");if(console.log("Video chat status update result:",s),s)console.log("Successfully updated video chat status to started"),w.current&&clearInterval(w.current),w.current=setInterval(()=>{console.log("Auto-refreshing data..."),j()},3e4),console.log("Doing immediate refresh..."),await j(),x.success("Video-Chat akzeptiert!");else throw console.error("Failed to update video chat status - null result received"),new Error("Failed to update video chat status")}catch(s){console.error("Error accepting video chat:",s),x.error("Fehler beim Akzeptieren des Video-Chats"),d("video_accepted")}finally{setTimeout(()=>{z.current=!1},1e3)}},Z=async()=>{if(t)try{z.current=!0,console.log("Completing video chat for task:",t.id),console.log("Current video_chat_status:",t.video_chat_status),console.log("Current video_call_rating_completed:",t.video_call_rating_completed);const{error:s}=await A.from("task_assignments").update({video_chat_status:"completed"}).eq("id",t.id);if(s)throw s;const a=await b();console.log("Task updated, new state:",a),console.log("Moving to VIDEO_CALL_RATING step"),d("video_call_rating"),x.success("Video-Chat abgeschlossen. Bitte bewerte deine Erfahrung.")}catch(s){console.error("Error completing video chat:",s),x.error("Fehler beim Abschließen des Video-Chats")}finally{setTimeout(()=>{z.current=!1},1e3)}},K=async s=>{try{z.current=!0,console.log("Submitting video call rating with data:",s),console.log("Current task assignment state:",t);const a=await u(s);if(!a)throw new Error("Failed to submit video call rating");if(console.log("Video call rating submitted successfully, result:",a),console.log("Updated video_call_rating_completed:",a.video_call_rating_completed),t!=null&&t.document_step_required)console.log("Document step is required, moving to DOCUMENT_UPLOAD"),d("document_upload"),x.success("Bitte laden Sie nun die erforderlichen Dokumente hoch.");else{console.log("No document step required, submitting task for review");const v={completed_at:new Date().toISOString(),document_step_completed:!1,video_chat_status:t.video_chat_status,video_call_rating_completed:!0,video_call_rating_data:s,demo_data:t.demo_data},{error:T}=await A.from("task_assignments").update({status:"submitted",submitted_at:new Date().toISOString(),submission_data:v}).eq("id",(t==null?void 0:t.id)||"");if(T)throw new Error(T.message);if(t!=null&&t.task_id){console.log(`🔄 Updating task status to submitted for task_id: ${t.task_id}`);const{error:E}=await A.from("tasks").update({status:"submitted",updated_at:new Date().toISOString()}).eq("id",t.task_id);E?console.error("Error updating task status:",E):console.log("✅ Successfully updated both task_assignments and tasks status to submitted")}await b(),d("completed"),x.success("Aufgabe erfolgreich eingereicht! Sie wird nun von einem Administrator geprüft.")}}catch(a){console.error("Error submitting video call rating:",a);const v=a instanceof Error?a.message:"Unknown error";x.error(`Fehler: ${v}`)}finally{setTimeout(()=>{z.current=!1},1e3)}},te=async()=>{if(t){console.log("Declining video chat...");try{const s=await h("declined");if(console.log("Video chat status update result:",s),s)d("video_declined"),await b();else throw new Error("Failed to update video chat status")}catch(s){console.error("Error declining video chat:",s),x.error("Fehler beim Ablehnen des Video-Chats"),d("video_declined")}}},se=async()=>{if(t)try{await o(0),await h("not_started"),await b(),d("details"),x.success("Die Aufgabe wurde neu gestartet.")}catch(s){console.error("Error restarting task:",s),x.error("Fehler beim Neustarten der Aufgabe")}},k=async()=>{if(t)try{await p()&&(await b(),d("details"),x.success("Aufgabe wurde erfolgreich neu gestartet!"))}catch(s){console.error("Error restarting rejected task:",s),x.error("Fehler beim Neustarten der abgelehnten Aufgabe")}},f=async()=>{if(t)try{console.log("Submitting task for admin review:",t.id);const s={completed_at:new Date().toISOString(),document_step_completed:!0,video_chat_status:t.video_chat_status,video_call_rating_completed:t.video_call_rating_completed,video_call_rating_data:t.video_call_rating_data,demo_data:t.demo_data},{error:a}=await A.from("task_assignments").update({document_step_completed:!0,status:"submitted",submitted_at:new Date().toISOString(),submission_data:s}).eq("id",t.id);if(a)throw a;if(t!=null&&t.task_id){console.log(`🔄 Updating task status to submitted for task_id: ${t.task_id}`);const{error:v}=await A.from("tasks").update({status:"submitted",updated_at:new Date().toISOString()}).eq("id",t.task_id);v?console.error("Error updating task status:",v):console.log("✅ Successfully updated both task_assignments and tasks status to submitted")}await b(),d("completed"),x.success("Aufgabe erfolgreich eingereicht! Sie wird nun von einem Administrator geprüft.")}catch(s){console.error("Error submitting task for review:",s),x.error("Fehler beim Einreichen der Aufgabe")}},S=()=>{g("/tasks")},F=()=>{r&&(console.log("Retrying task assignment fetch..."),b())};return m&&!t?e.jsx("div",{className:"flex justify-center items-center h-96",children:e.jsx(Ue,{})}):y?e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-red-500",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),e.jsx("div",{className:"ml-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut."})}),e.jsx("div",{className:"ml-auto pl-3",children:e.jsx("button",{type:"button",className:"bg-red-100 text-red-500 hover:bg-red-200 px-3 py-1 rounded-md",onClick:F,children:"Wiederholen"})})]}),e.jsx("button",{onClick:()=>b(),className:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700",children:"Erneut versuchen"})]}):t?e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[c==="details"&&e.jsx(Le,{taskAssignment:t,isLoading:m,onStartTask:U,onRestartTask:k}),c==="instructions"&&e.jsx(We,{taskAssignment:t,isLoading:m,onNextStep:D,onPreviousStep:$,onBack:()=>d("details")}),c==="rating"&&e.jsx(He,{taskAssignment:t,onSubmit:Y,onBack:$}),c==="video_decision"&&e.jsx(Ze,{taskAssignment:t,onAccept:H,onDecline:te,isLoading:m}),c==="video_accepted"&&e.jsx(Je,{taskAssignment:t,onRefresh:j,onCompleteVideoChat:Z,isLoading:m,isAdminView:!1}),c==="video_declined"&&e.jsx(Xe,{taskAssignment:t,onRestart:se,isLoading:m}),c==="video_call_rating"&&e.jsx(or,{taskAssignment:t,onSubmit:K,onBack:()=>{d("video_accepted")}}),c==="document_upload"&&e.jsx(lr,{taskAssignment:t,onComplete:f,onBack:()=>g("/mitarbeiter/tasks")}),c==="completed"&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx("div",{className:"text-5xl text-green-500 mb-4",children:"✅"}),e.jsx("h2",{className:"text-2xl font-bold text-center mb-2 text-gray-900 dark:text-gray-100",children:"Aufgabe erfolgreich abgeschlossen!"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-center mb-8",children:"Vielen Dank für deine Arbeit."}),e.jsx(M,{onClick:()=>g("/mitarbeiter/tasks"),className:"inline-flex items-center px-8 py-2 whitespace-nowrap min-w-[200px] justify-center",children:e.jsx("span",{children:"Zurück zur Aufgabenliste"})})]})]}):e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/30 p-6 rounded-lg text-center max-w-2xl mx-auto my-8",children:[e.jsx("h2",{className:"text-xl font-bold text-yellow-700 dark:text-yellow-400 mb-2",children:"Aufgabe nicht gefunden"}),e.jsx("p",{className:"text-yellow-600 dark:text-yellow-300 mb-4",children:"Die angeforderte Aufgabe konnte nicht gefunden werden oder Sie haben keine Berechtigung, darauf zuzugreifen."}),e.jsx("button",{onClick:S,className:"inline-flex items-center px-8 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 whitespace-nowrap min-w-[220px] justify-center",children:e.jsx("span",{children:"Zurück zu meinen Aufträgen"})})]})};export{kr as default};
