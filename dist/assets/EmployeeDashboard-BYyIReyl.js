import{u as W,b as Y,r as u,b9 as q,s as v,_ as Q,O as X,U as Z,G as ee,ba as te,j as e,K as ae,B as M,F as se,o as V,E as re,C as ie,m as y,d as ne,e as H,L as I,f as oe,A as le,h as z,i as _,k as G,bb as O,l as U,bc as ce,g as w,V as P}from"./index-C2zOcIr5.js";import{u as de}from"./useTaskTemplates-DrpK2931.js";import{K as me}from"./KycGate-DCpnyEHV.js";import{R as J}from"./refresh-cw-BQFYSu-c.js";import"./connectionManager-WW8tX6Ox.js";const E={userTasksCount:0,userCompletedTasksCount:0,userDocumentsCount:0,userHoursThisMonth:0,lastFetchTime:0},ge=()=>{const{user:r,profile:c}=W(),{settings:a}=Y(),[d,h]=u.useState(()=>{try{const g=sessionStorage.getItem("employeeDashboardStats");if(g){const o=JSON.parse(g);if(o.lastFetchTime&&Date.now()-o.lastFetchTime<5*60*1e3)return{...E,...o}}}catch(g){console.error("Error retrieving stored stats:",g)}return E}),[p,n]=u.useState([]),[A,k]=u.useState(!1),[F,j]=u.useState(null),[L,C]=u.useState(!1),m=u.useRef(!1),N=u.useCallback(async()=>{if(!r)return[];if(q(c,a).isBlocked)return console.log("üõ°Ô∏è KYC verification required, returning empty tasks array"),[];C(!0);try{const{data:o,error:f}=await v.from("task_assignments").select("*, task_template:task_template_id(*)").eq("assignee_id",r.id).eq("status","pending").order("created_at",{ascending:!1}).limit(5);if(f)throw f;return n(o||[]),o||[]}catch(o){return console.error("Error fetching tasks:",o),[]}finally{C(!1)}},[r,c,a]),D=g=>{try{return Q(new Date(g),"dd.MM.yyyy",{locale:X})}catch{return"Ung√ºltiges Datum"}},b=u.useCallback(async(g=!1)=>{if(!r){console.log("No user found, skipping fetch");return}if(q(c,a).isBlocked){console.log("üõ°Ô∏è KYC verification required, returning zero stats");const i={...E,lastFetchTime:Date.now()};return h(i),n([]),k(!1),j(null),i}if(m.current){console.log("Data fetch already in progress, skipping");return}const f=Date.now();if(!g&&d.lastFetchTime&&f-d.lastFetchTime<5e3){console.log(`In cooling period, not fetching again. Last fetch: ${new Date(d.lastFetchTime).toLocaleTimeString()}`);return}d.lastFetchTime&&f-d.lastFetchTime<5*60*1e3||k(!0),m.current=!0,j(null);try{console.log("Fetching employee dashboard data...");let i={...E,lastFetchTime:Date.now()};try{const{count:s,error:t}=await v.from("task_assignments").select("*",{count:"exact",head:!0}).eq("assignee_id",r.id).eq("status","pending");!t&&s!==null&&(i.userTasksCount=s)}catch(s){console.warn("Could not fetch user tasks count:",s)}try{const{count:s,error:t}=await v.from("task_assignments").select("*",{count:"exact",head:!0}).eq("assignee_id",r.id).eq("status","completed");!t&&s!==null&&(i.userCompletedTasksCount=s)}catch(s){console.warn("Could not fetch user completed tasks count:",s)}try{const{count:s,error:t}=await v.from("contract_assignments").select("*",{count:"exact",head:!0}).eq("user_id",r.id).eq("status","signed");!t&&s!==null&&(i.userDocumentsCount=s)}catch(s){console.warn("Could not fetch user documents count:",s)}try{const s=await fetch(`/api/time-entries/stats/${r.id}?period=month`);if(s.ok){const t=await s.json();t.success&&t.data&&(i.userHoursThisMonth=t.data.totalHours||0)}}catch(s){console.warn("Could not fetch worked hours from time tracking API:",s);try{const t=new Date,l=new Date(t.getFullYear(),t.getMonth(),1),{data:x,error:T}=await v.from("time_entries").select("hours").eq("employee_id",r.id).eq("status","approved").gte("entry_date",l.toISOString().split("T")[0]);!T&&x&&(i.userHoursThisMonth=x.reduce((B,S)=>B+(S.hours||0),0))}catch(t){console.warn("Could not fetch time entries from database fallback:",t)}}return h(i),sessionStorage.setItem("employeeDashboardStats",JSON.stringify(i)),await N(),i}catch(i){console.error("Error fetching dashboard data:",i),j(i instanceof Error?i:new Error("Failed to fetch dashboard data"))}finally{k(!1),m.current=!1}},[N,d.lastFetchTime,r,c,a]);u.useEffect(()=>{r&&b()},[b,r]);const $=q(c,a);return{stats:d,tasks:p,loading:A,tasksLoading:L,error:F,isKycBlocked:$.isBlocked,fetchData:b,formatDate:D}},xe=()=>{var i,s;const{profile:r,isTaskBasedUser:c}=W(),{colors:a}=Y(),d=ee(),{stats:h,tasks:p,loading:n,tasksLoading:A,error:k,fetchData:F,formatDate:j}=ge(),{templates:L,loading:C}=de(),{balance:m,loading:N}=te(c()?r==null?void 0:r.id:void 0),D=L.filter(t=>t.is_starter_job||t.type==="public").slice(0,4),b=()=>{F(!0)},$=t=>{const l=p.find(x=>x.task_template_id===t);d(l?`/task-assignments/${l.id}/flow`:"/mitarbeiter/tasks")},o=new Date().toLocaleDateString("de-DE",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),f=[{title:"Abgeschlossene Auftr√§ge",value:n?"-":h.userCompletedTasksCount.toString(),icon:e.jsx(ae,{size:20}),link:"/mitarbeiter/tasks",color:"green",description:"Gesamt"},{title:"Aktive Auftr√§ge",value:n?"-":h.userTasksCount.toString(),icon:e.jsx(M,{size:20}),link:"/mitarbeiter/tasks",color:"blue",description:"In Bearbeitung"},...c()?[]:[{title:"Dokumente",value:n?"-":h.userDocumentsCount.toString(),icon:e.jsx(se,{size:20}),link:"/mitarbeiter/contracts",color:"purple",description:"Vertr√§ge & Dokumente"}],...c()?[]:[{title:"Stunden diesen Monat",value:n?"-":`${h.userHoursThisMonth}h`,icon:e.jsx(V,{size:20}),link:"/mitarbeiter/tasks",color:"amber",description:"Arbeitszeit"}]],K=c()?[{title:"Aktuelles Guthaben",value:N?"-":`‚Ç¨${((i=m==null?void 0:m.current_balance)==null?void 0:i.toFixed(2))||"0.00"}`,icon:e.jsx(re,{size:20}),link:"/mitarbeiter/auszahlung",color:"emerald",description:"Verf√ºgbar f√ºr Auszahlung"},{title:"Gesamt verdient",value:N?"-":`‚Ç¨${((s=m==null?void 0:m.total_earned)==null?void 0:s.toFixed(2))||"0.00"}`,icon:e.jsx(ie,{size:20}),link:"/mitarbeiter/auszahlung",color:"indigo",description:"Alle Aufgaben"}]:[],R=[...f,...K];return e.jsxs("div",{className:"space-y-8 w-full",children:[e.jsx(y.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.5},className:"bg-gradient-to-r from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-xl p-6 shadow-sm",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-app font-app-bold text-gray-900 dark:text-white",children:"Mitarbeiter Dashboard"}),e.jsxs("p",{className:"mt-2 text-gray-600 dark:text-gray-300 font-app",children:["Willkommen zur√ºck, ",e.jsx("span",{className:"font-app-medium text-gray-800 dark:text-gray-200",children:r?`${r.first_name||""} ${r.last_name||""}`.trim()||r.email:""}),". Hier ist ein √úberblick √ºber Ihre Aktivit√§ten."]})]}),e.jsxs("div",{className:"mt-4 md:mt-0 flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-4",children:[e.jsxs("div",{className:"flex items-center bg-white dark:bg-gray-800 px-3 py-1.5 rounded-lg shadow-sm",children:[e.jsx(ne,{className:"text-accent mr-2",size:16}),e.jsx("p",{className:"text-sm font-app text-gray-700 dark:text-gray-300",children:o})]}),e.jsx(H,{variant:"outline",size:"sm",onClick:b,disabled:n,leftIcon:e.jsx(J,{className:"h-4 w-4"}),children:"Aktualisieren"})]})]})}),n&&e.jsx(y.div,{initial:{opacity:0},animate:{opacity:1},className:"flex justify-center py-12",children:e.jsx(I,{size:"lg"})}),k&&!n&&e.jsxs(y.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200 p-6 rounded-xl shadow-sm flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(oe,{className:"mr-2",size:20}),e.jsx("p",{className:"font-app",children:"Fehler beim Laden der Dashboard-Daten."})]}),e.jsx("div",{className:"mt-2",children:e.jsx(le,{onClick:b,variant:"danger",icon:e.jsx(J,{size:16}),disabled:n,children:"Daten neu laden"})})]}),!n&&!k&&e.jsx(me,{profile:r,settings:null,mode:"prompt",children:e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6",children:R.map((t,l)=>{const x={blue:{bg:`bg-[${a.primary}]/5 dark:bg-gray-800`,text:`text-[${a.primary}] dark:text-white`,icon:`bg-[${a.primary}]/10 dark:bg-gray-700 text-[${a.primary}] dark:text-white`},green:{bg:`bg-[${a.accent}]/5 dark:bg-gray-800`,text:`text-[${a.accent}] dark:text-white`,icon:`bg-[${a.accent}]/10 dark:bg-gray-700 text-[${a.accent}] dark:text-white`},purple:{bg:`bg-[${a.primaryDark}]/5 dark:bg-gray-800`,text:`text-[${a.primaryDark}] dark:text-white`,icon:`bg-[${a.primaryDark}]/10 dark:bg-gray-700 text-[${a.primaryDark}] dark:text-white`},amber:{bg:`bg-[${a.accentDark}]/5 dark:bg-gray-800`,text:`text-[${a.accentDark}] dark:text-white`,icon:`bg-[${a.accentDark}]/10 dark:bg-gray-700 text-[${a.accentDark}] dark:text-white`},emerald:{bg:"bg-emerald-50 dark:bg-gray-800",text:"text-emerald-600 dark:text-emerald-400",icon:"bg-emerald-100 dark:bg-gray-700 text-emerald-600 dark:text-emerald-400"},indigo:{bg:"bg-indigo-50 dark:bg-gray-800",text:"text-indigo-600 dark:text-indigo-400",icon:"bg-indigo-100 dark:bg-gray-700 text-indigo-600 dark:text-indigo-400"}},T=x[t.color]||x.blue,B=({children:S})=>t.onClick?e.jsx("div",{onClick:t.onClick,className:"cursor-pointer",children:S}):e.jsx(w,{to:t.link,children:S});return e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:l*.1,duration:.5},children:e.jsx(B,{children:e.jsxs(z,{className:"h-full shadow-sm border-0 overflow-hidden hover:shadow-md transition-shadow",children:[e.jsx("div",{className:`h-1 w-full ${t.color==="emerald"||t.color==="indigo"?`bg-${t.color}-500`:t.color==="blue"||t.color==="purple"?`bg-[${a.primary}]`:`bg-[${a.accent}]`} dark:${t.color==="emerald"||t.color==="indigo"?`bg-${t.color}-400`:t.color==="blue"||t.color==="purple"?`bg-[${a.primaryLight}]`:`bg-[${a.accentLight}]`}`}),e.jsx(_,{className:"p-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:`p-3 rounded-lg ${T.icon} mr-4`,children:Z.cloneElement(t.icon,{size:24})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:`text-sm font-app font-app-medium ${T.text}`,children:t.title}),e.jsxs("div",{className:"flex items-baseline mt-1",children:[e.jsx("p",{className:"text-3xl font-app font-app-bold text-gray-900 dark:text-white",children:t.value}),e.jsx("p",{className:"ml-2 text-xs font-app text-gray-500 dark:text-gray-400",children:t.description})]})]})]})})]})})},l)})}),D.length>0&&e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3,duration:.5},className:"grid grid-cols-1 gap-6",children:e.jsxs(z,{className:"shadow-sm border-0 overflow-hidden",children:[e.jsx("div",{className:`h-1 w-full bg-[${a.accent}] dark:bg-[${a.accentLight}]`}),e.jsx(G,{className:"flex flex-row items-center justify-between px-6 pt-6 pb-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`p-2 rounded-lg bg-[${a.accent}]/10 dark:bg-gray-700 text-[${a.accent}] dark:text-white mr-3`,children:e.jsx(O,{size:18})}),e.jsx(U,{className:"font-app font-app-medium text-gray-900 dark:text-white",children:"Verf√ºgbare Aufgaben"})]})}),e.jsx(_,{className:"px-6 pb-6",children:C?e.jsx("div",{className:"flex justify-center py-6",children:e.jsx(I,{size:"md"})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:D.map(t=>e.jsx(y.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},whileHover:{scale:1.02},transition:{duration:.2},className:"cursor-pointer",onClick:()=>$(t.id),children:e.jsx(z,{className:"h-full shadow-sm border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all duration-200 bg-white dark:bg-gray-800",children:e.jsxs(_,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-app font-app-semibold text-gray-900 dark:text-white text-sm line-clamp-2",children:t.title}),t.is_starter_job&&e.jsxs("div",{className:"flex items-center mt-1",children:[e.jsx(O,{size:12,className:"text-yellow-500 fill-current mr-1"}),e.jsx("span",{className:"text-xs text-yellow-600 dark:text-yellow-400",children:"Starter-Job"})]})]}),e.jsx(ce,{size:16,className:"text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300 transition-colors flex-shrink-0 ml-2"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 line-clamp-3 mb-3",children:t.description||"Keine Beschreibung verf√ºgbar"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${t.priority==="high"?"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400":t.priority==="medium"?"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400":"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}`,children:t.priority==="high"?"Hoch":t.priority==="medium"?"Mittel":"Niedrig"}),e.jsx(H,{size:"sm",variant:"outline",onClick:l=>{l.stopPropagation(),$(t.id)},className:"text-xs py-1 px-2 h-auto",children:"Details"})]})]})})},t.id))})})]})}),e.jsx(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4,duration:.5},className:"grid grid-cols-1 gap-6",children:e.jsxs(z,{className:"shadow-sm border-0 overflow-hidden",children:[e.jsx("div",{className:`h-1 w-full bg-[${a.primary}] dark:bg-[${a.primaryLight}]`}),e.jsxs(G,{className:"flex flex-row items-center justify-between px-6 pt-6 pb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`p-2 rounded-lg bg-[${a.primary}]/10 dark:bg-gray-700 text-[${a.primary}] dark:text-white mr-3`,children:e.jsx(M,{size:18})}),e.jsx(U,{className:"font-app font-app-medium text-gray-900 dark:text-white",children:"Meine Auftr√§ge"})]}),e.jsx(w,{to:"/mitarbeiter/tasks",className:"text-sm font-app text-accent hover:underline",children:"Alle anzeigen"})]}),e.jsx(_,{className:"px-6 pb-6",children:A?e.jsx("div",{className:"flex justify-center py-6",children:e.jsx(I,{size:"md"})}):p.length===0?e.jsxs("div",{className:"text-center py-8 bg-gray-50 dark:bg-gray-800/50 rounded-lg",children:[e.jsx("div",{className:"p-3 rounded-full bg-gray-100 dark:bg-gray-700 mx-auto mb-3 w-12 h-12 flex items-center justify-center",children:e.jsx(M,{className:"text-gray-500 dark:text-gray-400",size:24})}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 font-app",children:"Keine aktiven Auftr√§ge vorhanden."}),e.jsx("div",{className:"mt-4",children:e.jsx(w,{to:"/mitarbeiter/tasks",children:e.jsx(H,{variant:"outline",size:"sm",children:"Zur Auftrags√ºbersicht"})})})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"rounded-lg overflow-hidden divide-y divide-gray-100 dark:divide-gray-700 bg-gray-50 dark:bg-gray-800/50",children:p.slice(0,5).map(t=>{var l,x;return e.jsx(w,{to:`/task-assignments/${t.id}/flow`,className:"block hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors",children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"mt-0.5 mr-3 flex-shrink-0",children:t.current_step>0?e.jsx("div",{className:"w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center",children:e.jsx(P,{size:16})}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 flex items-center justify-center",children:e.jsx(P,{size:16})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-app font-app-medium text-gray-900 dark:text-white text-base",children:((l=t.task_template)==null?void 0:l.title)||"Unnamed Task"}),e.jsx("p",{className:"text-sm font-app text-gray-500 dark:text-gray-400 mt-1 line-clamp-1",children:((x=t.task_template)==null?void 0:x.description)||"No description"}),e.jsxs("div",{className:"flex items-center mt-2 text-xs font-app text-gray-500 dark:text-gray-400",children:[e.jsx(V,{size:12,className:"mr-1"}),e.jsxs("span",{children:["Erstellt am ",j(t.created_at)]})]})]}),e.jsx("div",{className:"ml-4 flex-shrink-0",children:e.jsx("div",{className:`px-2.5 py-1 rounded-full text-xs font-app font-app-medium ${t.current_step>0?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300"}`,children:t.current_step>0?"In Bearbeitung":"Neu"})})]})})},t.id)})}),p.length>5&&e.jsx("div",{className:"text-center pt-2",children:e.jsxs(w,{to:"/mitarbeiter/tasks",className:"text-sm font-app text-accent hover:underline",children:[p.length-5," weitere Auftr√§ge anzeigen"]})})]})})]})})]})})]})},ke=Z.memo(xe);export{ke as default};
