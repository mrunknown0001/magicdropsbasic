import{u as J,r as s,s as n,z as o}from"./index-C2zOcIr5.js";const N=()=>{const{user:d}=J(),[m,k]=s.useState([]),[b,y]=s.useState([]),[E,h]=s.useState([]),[S,A]=s.useState([]),[C,v]=s.useState([]),[x,g]=s.useState(!1),[T,_]=s.useState(!1),[F,u]=s.useState(null),f=s.useCallback(async()=>{try{g(!0);const{data:r,error:e}=await n.from("knowledge_base_categories").select("*").eq("is_active",!0).order("sort_order");if(e)throw e;k(r||[])}catch(r){console.error("Error fetching categories:",r),u("Failed to fetch categories"),o.error("Fehler beim Laden der Kategorien")}finally{g(!1)}},[]),c=s.useCallback(async r=>{try{g(!0);let e=n.from("knowledge_base_articles").select(`
          *,
          knowledge_base_categories!inner (name, color, icon)
        `).order("created_at",{ascending:!1});r&&r!=="all"&&(e=e.eq("category_id",r));const{data:t,error:a}=await e;if(a)throw a;y(t||[])}catch(e){console.error("Error fetching articles:",e),u("Failed to fetch articles"),o.error("Fehler beim Laden der Artikel")}finally{g(!1)}},[]),j=s.useCallback(async(r,e=!0)=>{var t;if(!r.trim()){h([]);return}try{if(_(!0),e)try{const l=await fetch("/api/ai-knowledge/search",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(t=(await n.auth.getSession()).data.session)==null?void 0:t.access_token}`},body:JSON.stringify({query:r,limit:10,threshold:.5})});if(l.ok){const p=await l.json();h(p.results||[]);return}}catch(l){console.warn("Semantic search failed, falling back to text search:",l)}const{data:a,error:i}=await n.from("knowledge_base_articles").select(`
          *,
          knowledge_base_categories!inner (name, color, icon)
        `).eq("is_published",!0).or(`title.ilike.%${r}%,content.ilike.%${r}%,summary.ilike.%${r}%`).order("helpful_votes",{ascending:!1});if(i)throw i;h(a||[])}catch(a){console.error("Error searching articles:",a),u("Search failed"),o.error("Suchfehler")}finally{_(!1)}},[]),$=s.useCallback(async r=>{if(!d)return null;try{const{data:e,error:t}=await n.from("knowledge_base_articles").insert({...r,created_by:d.id,ai_training_enabled:r.ai_training_enabled??!0,context_priority:r.context_priority??5,response_template:r.response_template||null,conversation_examples:r.conversation_examples||[]}).select().single();if(t)throw t;return await c(),o.success("Artikel erfolgreich erstellt"),e}catch(e){return console.error("Error creating article:",e),o.error("Fehler beim Erstellen des Artikels"),null}},[d,c]),B=s.useCallback(async(r,e)=>{try{const{data:t,error:a}=await n.from("knowledge_base_articles").update({...e,updated_at:new Date().toISOString()}).eq("id",r).select().single();if(a)throw a;return await c(),o.success("Artikel erfolgreich aktualisiert"),t}catch(t){return console.error("Error updating article:",t),o.error("Fehler beim Aktualisieren des Artikels"),null}},[c]),L=s.useCallback(async r=>{try{const{error:e}=await n.from("knowledge_base_articles").delete().eq("id",r);if(e)throw e;return await c(),o.success("Artikel erfolgreich gelöscht"),!0}catch(e){return console.error("Error deleting article:",e),o.error("Fehler beim Löschen des Artikels"),!1}},[c]),O=s.useCallback(async(r,e)=>{try{const t=e?"helpful_votes":"unhelpful_votes",{error:a}=await n.rpc("increment_article_vote",{article_id:r,vote_type:t});if(a)throw a;await c(),o.success("Bewertung gespeichert")}catch(t){console.error("Error voting on article:",t),o.error("Fehler beim Bewerten")}},[c]),z=s.useCallback(async r=>{var e;try{const t=await fetch(`/api/ai-knowledge/embeddings/${r}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(e=(await n.auth.getSession()).data.session)==null?void 0:e.access_token}`}});if(!t.ok){const i=await t.json();throw new Error(i.error||"Failed to generate embeddings")}const a=await t.json();return o.success(`Embeddings generiert (${a.embeddingSize} Dimensionen)`),a}catch(t){throw console.error("Error generating embeddings:",t),o.error("Fehler beim Generieren der Embeddings"),t}},[]),w=s.useCallback(async r=>{try{const{data:e,error:t}=await n.from("ai_training_examples").select("*").eq("article_id",r).eq("is_active",!0).order("created_at",{ascending:!1});if(t)throw t;A(e||[])}catch(e){console.error("Error fetching training examples:",e),u("Failed to fetch training examples")}},[]),D=s.useCallback(async(r,e)=>{if(!d)return null;try{const{data:t,error:a}=await n.from("ai_training_examples").insert({article_id:r,...e,created_by:d.id}).select().single();if(a)throw a;return await w(r),o.success("Training-Beispiel erstellt"),t}catch(t){return console.error("Error creating training example:",t),o.error("Fehler beim Erstellen des Training-Beispiels"),null}},[d,w]),R=s.useCallback(async(r,e,t,a)=>{try{await n.from("ai_knowledge_metrics").insert({article_id:r,chat_conversation_id:e,usage_type:t,relevance_score:a}),await n.from("knowledge_base_articles").update({ai_usage_count:n.raw("ai_usage_count + 1"),last_ai_usage:new Date().toISOString()}).eq("id",r)}catch(i){console.error("Error tracking AI usage:",i)}},[]),U=s.useCallback(async(r,e="7d")=>{var t;try{const a=await fetch(`/api/ai-knowledge/analytics?timeframe=${e}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(t=(await n.auth.getSession()).data.session)==null?void 0:t.access_token}`}});if(!a.ok){const l=await a.json();throw new Error(l.error||"Failed to fetch analytics")}const i=await a.json();return v(i.analytics||[]),i.analytics}catch(a){return console.error("Error fetching AI analytics:",a),u("Failed to fetch AI analytics"),[]}},[]),q=s.useCallback(async()=>{var r;try{const e=await fetch("/api/ai-knowledge/export",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(r=(await n.auth.getSession()).data.session)==null?void 0:r.access_token}`}});if(!e.ok){const p=await e.json();throw new Error(p.error||"Failed to export training data")}const t=await e.json(),a=new Blob([JSON.stringify(t.data,null,2)],{type:"application/json"}),i=window.URL.createObjectURL(a),l=document.createElement("a");return l.href=i,l.download=`ai-training-data-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(l),l.click(),window.URL.revokeObjectURL(i),document.body.removeChild(l),o.success(`Training-Daten exportiert (${t.data.total_articles} Artikel)`),t.data}catch(e){throw console.error("Error exporting training data:",e),o.error("Fehler beim Exportieren der Training-Daten"),e}},[]),I=s.useCallback(async(r,e)=>{var t;try{const a=await fetch(`/api/ai-knowledge/effectiveness/${r}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(t=(await n.auth.getSession()).data.session)==null?void 0:t.access_token}`},body:JSON.stringify({effectivenessScore:e})});if(!a.ok){const i=await a.json();throw new Error(i.error||"Failed to update effectiveness score")}o.success("Effektivitäts-Score aktualisiert"),await c()}catch(a){throw console.error("Error updating effectiveness score:",a),o.error("Fehler beim Aktualisieren des Effektivitäts-Scores"),a}},[c]),G=s.useCallback(()=>{h([])},[]);return s.useEffect(()=>{f(),c()},[f,c]),{categories:m,articles:b,searchResults:E,trainingExamples:S,knowledgeMetrics:C,loading:x,searchLoading:T,error:F,fetchCategories:f,fetchArticles:c,searchArticles:j,createArticle:$,updateArticle:B,deleteArticle:L,voteArticle:O,generateEmbeddings:z,clearSearch:G,fetchTrainingExamples:w,createTrainingExample:D,trackAIUsage:R,getAIAnalytics:U,exportTrainingData:q,updateEffectivenessScore:I}};export{N as u};
