import{t as P,r as o,u as Z,G as L,j as e,e as g,aw as M,h as H,k as Q,l as U,i as W,I as d,a5 as X,af as J,s as Y}from"./index-C2zOcIr5.js";import{e as ee}from"./contractUtils-B5S0O9Tf.js";import{u as te}from"./useToast-BsUGRjrm.js";import{R as re}from"./quill.snow-B5tST0Aw.js";const ne=()=>{var j,v,V,w;const{register:n,handleSubmit:N,formState:{errors:i},setValue:C}=P(),[s,m]=o.useState({}),[p,y]=o.useState(!1),[x,S]=o.useState(""),c=o.useRef(null),{user:h}=Z(),b=L(),{showToast:f}=te(),T=async t=>{try{y(!0);const{title:r,category:a,content:l,is_active:u,is_template:B,parent_id:R,version_number:q,template_data:$,version:G,created_by:I}=t,K={title:r,category:a,content:l,is_active:u,is_template:B,parent_id:R,version_number:q,template_data:$,version:G,created_by:I},{data:O,error:k}=await Y.from("contracts").insert([K]).select().single();if(k)throw k;return O}catch(r){throw console.error("Failed to create contract:",r),r}finally{y(!1)}},_=t=>{t!==x&&(S(t),c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{C("content",t),z(t)},500))},z=t=>{if(!t)return;const r=ee(t),a={...s};let l=!1;r.forEach(u=>{a[u]||(a[u]="",l=!0)}),l&&m(a)};o.useEffect(()=>()=>{c.current&&clearTimeout(c.current)},[]);const F=async t=>{try{const r={...s},a=t.monthly_salary||0;a>0&&(r.salary=`${a} €`);const l={title:t.title,category:t.category,content:x,version:t.version,is_active:!0,is_template:!0,template_data:r,created_by:(h==null?void 0:h.id)||null,version_number:1};await T(l),f({title:"Erfolg",message:"Vertragsvorlage wurde erfolgreich erstellt.",type:"success"}),b("/admin/contracts")}catch{f({title:"Fehler",message:"Die Vertragsvorlage konnte nicht erstellt werden.",type:"error"})}},D=()=>{const t=`custom${Object.keys(s).length+1}`;m({...s,[t]:""})},E=(t,r)=>{m({...s,[t]:r})},A=t=>{const r={...s};delete r[t],m(r)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Neue Vertragsvorlage erstellen"}),e.jsxs(g,{onClick:()=>b("/admin/contracts"),variant:"outline",className:"flex items-center gap-2",children:[e.jsx(M,{size:16}),"Zurück"]})]}),e.jsxs(H,{children:[e.jsx(Q,{children:e.jsx(U,{children:"Vertragsvorlage Details"})}),e.jsx(W,{children:e.jsxs("form",{onSubmit:N(F),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("div",{children:e.jsx(d,{label:"Titel",...n("title",{required:"Titel ist erforderlich"}),error:(j=i.title)==null?void 0:j.message,placeholder:"Vertragsvorlage Titel"})}),e.jsx("div",{children:e.jsx(d,{label:"Kategorie",...n("category",{required:"Kategorie ist erforderlich"}),error:(v=i.category)==null?void 0:v.message,placeholder:"z.B. Arbeitsvertrag, Dienstleistungsvertrag, etc."})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("div",{children:e.jsx(d,{label:"Version",...n("version",{required:"Version ist erforderlich"}),error:(V=i.version)==null?void 0:V.message,placeholder:"z.B. 1.0, 2023-01, etc."})}),e.jsx("div",{children:e.jsx(d,{label:"Monatliches Gehalt (€)",type:"number",...n("monthly_salary",{valueAsNumber:!0,validate:t=>!t||t>=0||"Gehalt muss eine positive Zahl sein"}),error:(w=i.monthly_salary)==null?void 0:w.message,placeholder:"z.B. 2500"})})]}),e.jsx("div",{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Vertragstext"}),e.jsx("input",{type:"hidden",...n("content",{required:"Vertragstext ist erforderlich"})}),e.jsx(re,{theme:"snow",value:x,onChange:_,modules:{toolbar:[[{header:[1,2,3,4,5,6,!1]}],["bold","italic","underline","strike"],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],[{align:[]}],["link","image","video"],["clean"]]},formats:["header","bold","italic","underline","strike","list","bullet","indent","link","image","video","align"],className:"bg-white dark:bg-gray-700 text-gray-900 dark:text-white",style:{height:"300px",marginBottom:"40px"}}),i.content&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.content.message}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:["Verwenden Sie Platzhalter im Format ","{{"," variableName ","}}",". Diese werden automatisch erkannt und unten angezeigt."]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Erkannte Variablen"}),e.jsxs(g,{type:"button",variant:"outline",size:"sm",onClick:D,className:"flex items-center gap-2",children:[e.jsx(X,{size:14}),"Variable hinzufügen"]})]}),e.jsx("div",{className:"space-y-4 bg-gray-50 dark:bg-gray-800 p-4 rounded-md",children:Object.keys(s).length===0?e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Keine Variablen im Vertragstext gefunden. Fügen Sie Platzhalter wie ","{{"," name ","}}","  im Text ein."]}):Object.entries(s).map(([t,r])=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(d,{label:`Variable {{${t}}}`,value:r,onChange:a=>E(t,a.target.value),placeholder:`Standardwert für ${t}`})}),e.jsx("button",{type:"button",className:"mt-6 p-2 text-red-500 hover:text-red-700 focus:outline-none",onClick:()=>A(t),children:e.jsx(J,{size:16})})]},t))}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:"Diese Werte werden als Standardwerte für die Variablen verwendet. Sie können beim Zuweisen des Vertrags überschrieben werden."})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(g,{onClick:()=>b("/admin/contracts"),type:"button",variant:"outline",children:"Abbrechen"}),e.jsx(g,{type:"submit",variant:"primary",isLoading:p,disabled:p,children:"Vertragsvorlage erstellen"})]})]})})]})]})};export{ne as default};
