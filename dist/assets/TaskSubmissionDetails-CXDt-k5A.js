import{P as J,G as O,b as X,r as c,s as g,j as e,L as ee,f as se,e as b,V as D,Q as te,h as U,k as B,l as R,i as K,w as re,R as ae,W as ne,o as ie,K as le,z as u}from"./index-C2zOcIr5.js";import{u as de}from"./useTaskAssignment-DzXizOwJ.js";import{S as oe}from"./smartphone-BVgYlr7j.js";import{K as ce,L as me}from"./link-DLAKUAWl.js";const ge={not_started:"Nicht gestartet",accepted:"Akzeptiert",declined:"Abgelehnt",completed:"Abgeschlossen"},be=()=>{const{submissionId:h}=J(),A=O(),{colors:n}=X(),{isLoading:j,error:T,updateDemoData:q,assignPhoneNumber:Z}=de(),[a,k]=c.useState(null),[L,G]=c.useState([]),[N,I]=c.useState(!1),[v,w]=c.useState(""),[_,p]=c.useState(""),[S,C]=c.useState(""),[$,P]=c.useState(""),[z,y]=c.useState(""),E=async()=>{if(h)try{console.log("Fetching submission details for ID:",h);const[s,t,d]=await Promise.allSettled([g.from("task_assignments").select("*").eq("id",h).single(),Promise.resolve(null),Promise.resolve(null)]);if(s.status==="rejected")throw s.reason;const r=s.value.data;if(!r){u.error("Einreichung nicht gefunden"),A("/admin/submissions");return}console.log("Assignment data loaded:",r);const f=[];if(r.task_template_id&&f.push(g.from("task_templates").select("*").eq("id",r.task_template_id).single().then(i=>({type:"template",result:i}))),r.assignee_id&&f.push(g.rpc("get_profiles_with_emails_by_ids",{profile_ids:[r.assignee_id]}).then(i=>({type:"profile",result:i}))),f.length>0){const i=await Promise.allSettled(f);for(const m of i)if(m.status==="fulfilled"){const{type:M,result:o}=m.value;M==="template"&&!o.error&&o.data?(r.task_template=o.data,console.log("Template data loaded:",o.data)):M==="profile"&&!o.error&&o.data&&o.data.length>0&&(r.assignee=o.data[0],console.log("Profile data loaded:",o.data[0]))}else console.warn("Failed to fetch additional data:",m.reason)}if(r.assignee_id&&!r.assignee){console.log("Trying fallback profile fetch...");try{const{data:i,error:m}=await g.from("profiles").select("*").eq("id",r.assignee_id).single();!m&&i&&(r.assignee=i,console.log("Fallback profile data loaded:",i))}catch(i){console.warn("Fallback profile fetch also failed:",i)}}k(r),w(r.demo_email||""),p(r.demo_password||""),C(r.ident_code||""),P(r.ident_url||""),y(r.phone_number_id||""),console.log("Submission details fully loaded and state updated")}catch(s){console.error("Error fetching submission details:",s),u.error("Fehler beim Laden der Einreichungsdetails")}},H=async()=>{try{const{data:s,error:t}=await g.from("phone_numbers").select("*").eq("status","active").order("created_at",{ascending:!1});if(t)throw t;G(s)}catch(s){console.error("Error fetching phone numbers:",s),u.error("Fehler beim Laden der Telefonnummern")}};c.useEffect(()=>{E(),H();const s=g.channel(`submission-${h}`).on("postgres_changes",{event:"*",schema:"public",table:"task_assignments",filter:`id=eq.${h}`},t=>{console.log("Submission updated:",t)}).subscribe();return()=>{g.removeChannel(s)}},[h]);const V=async()=>{if(a){I(!0);try{console.log("Saving test data for submission:",a.id),await q(a.id,{demoEmail:v,demoPassword:_,identCode:S,identUrl:$,phoneNumberId:z||null})&&(k(t=>t&&{...t,demo_email:v,demo_password:_,ident_code:S,ident_url:$,phone_number_id:z||null,assignee:t.assignee,task_template:t.task_template}),u.success("Testdaten erfolgreich gespeichert"),setTimeout(()=>{E()},1e3))}catch(s){console.error("Error saving test data:",s),u.error("Fehler beim Speichern der Testdaten"),a&&(w(a.demo_email||""),p(a.demo_password||""),C(a.ident_code||""),P(a.ident_url||""),y(a.phone_number_id||""))}finally{I(!1)}}},W=s=>{try{const t=new Date(s);if(isNaN(t.getTime()))return"Ungültiges Datum";const d=t.getDate().toString().padStart(2,"0"),r=(t.getMonth()+1).toString().padStart(2,"0"),f=t.getFullYear(),i=t.getHours().toString().padStart(2,"0"),m=t.getMinutes().toString().padStart(2,"0");return`${d}.${r}.${f} ${i}:${m}`}catch{return"Ungültiges Datum"}},F=()=>{A("/admin/submissions")},Q=s=>{const t=s.target.value;y(t),a&&t!==a.phone_number_id&&Z(a.id,t||null).then(d=>{d&&(k(r=>r&&{...r,phone_number_id:t||null,assignee:r.assignee,task_template:r.task_template}),u.success("Telefonnummer erfolgreich zugewiesen"))}).catch(d=>{console.error("Error assigning phone number:",d),u.error("Fehler beim Zuweisen der Telefonnummer"),y(a.phone_number_id||"")})},Y=()=>{const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";let t="";for(let d=0;d<12;d++)t+=s.charAt(Math.floor(Math.random()*s.length));p(t)};if(j)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(ee,{size:"lg"})});if(T)return e.jsxs("div",{className:"flex flex-col items-center justify-center h-64",children:[e.jsx("div",{className:"text-red-500 mb-4",children:e.jsx(se,{size:48})}),e.jsx("p",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2",children:"Fehler beim Laden der Daten"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-4",children:T.message}),e.jsx(b,{onClick:E,children:"Erneut versuchen"})]});if(!a)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mb-4",children:e.jsx(D,{className:"text-gray-500",size:24})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2",children:"Einreichung nicht gefunden"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 max-w-md mx-auto mb-4",children:"Die angeforderte Einreichung konnte nicht gefunden werden."}),e.jsx(b,{onClick:F,children:"Zurück zur Übersicht"})]});const x=a.assignee,l=a.task_template;return e.jsxs("div",{className:"w-full px-4 py-6",children:[e.jsx("div",{className:"mb-6",children:e.jsx(b,{variant:"ghost",onClick:F,className:`inline-flex items-center text-[${n.primary}] dark:text-white hover:bg-[${n.primary}]/10 dark:hover:bg-gray-700`,leftIcon:e.jsx(te,{size:16}),children:"Zurück zur Übersicht"})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(U,{className:"col-span-1 border-0 shadow-sm overflow-hidden",children:[e.jsx(B,{className:"border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50 pb-4",children:e.jsxs(R,{className:"font-app font-app-medium text-gray-900 dark:text-white flex items-center",children:[e.jsx(D,{size:18,className:`mr-2 text-[${n.primary}] dark:text-white`}),"Einreichungsdetails"]})}),e.jsx(K,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:`flex-shrink-0 h-10 w-10 rounded-full bg-[${n.primary}]/10 dark:bg-gray-700 flex items-center justify-center`,children:e.jsx(re,{className:`h-5 w-5 text-[${n.primary}] dark:text-white`})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("h3",{className:"text-md font-medium text-gray-900 dark:text-gray-100",children:"Mitarbeiter"}),j?e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-32 mb-1"}),e.jsx("div",{className:"h-3 bg-gray-200 dark:bg-gray-700 rounded w-24"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:x?`${x.first_name} ${x.last_name}`:"Unbekannter Mitarbeiter"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:(x==null?void 0:x.email)||"Keine E-Mail"})]})]})]}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsx("h3",{className:"text-md font-medium text-gray-900 dark:text-gray-100 mb-2",children:"Aufgabe"}),j?e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-5 bg-gray-200 dark:bg-gray-700 rounded w-40 mb-2"}),e.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-full mb-1"}),e.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-800 dark:text-gray-200 font-medium",children:(l==null?void 0:l.title)||a.task_name||"Unbekannte Aufgabe"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:(l==null?void 0:l.description)||a.task_description||"Keine Beschreibung verfügbar"}),(l==null?void 0:l.type)&&e.jsx("div",{className:"mt-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200",children:l.type})]})]}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsx("h3",{className:"text-md font-medium text-gray-900 dark:text-gray-100 mb-2",children:"Status"}),e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{className:`px-2.5 py-1 rounded-full bg-[${n.primary}]/10 text-[${n.primary}] dark:bg-gray-700 dark:text-white text-sm flex items-center`,children:[e.jsx(D,{size:14,className:"mr-1"}),ge[a.video_chat_status]||a.video_chat_status]})}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-2",children:["Aktualisiert am: ",W(a.updated_at)]})]})]})})]}),e.jsxs(U,{className:"col-span-1 lg:col-span-2 border-0 shadow-sm overflow-hidden",children:[e.jsxs(B,{className:"border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50 pb-4",children:[e.jsxs(R,{className:"font-app font-app-medium text-gray-900 dark:text-white flex items-center",children:[e.jsx(oe,{size:18,className:`mr-2 text-[${n.primary}]`}),"Testdaten hinzufügen"]}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:"Füge Testdaten hinzu, die dem Mitarbeiter angezeigt werden sollen"})]}),e.jsx(K,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"demoEmail",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Demo E-Mail"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(ae,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"demoEmail",type:"email",className:"pl-10 pr-4 py-2 border rounded-md w-full dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent dark:focus:ring-accent",placeholder:"beispiel@demo.com",value:v,onChange:s=>w(s.target.value)})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"demoPassword",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Demo Passwort"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(ce,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"demoPassword",type:"text",className:`pl-10 pr-20 py-2 border rounded-md w-full dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-[${n.primary}]/30 focus:border-[${n.primary}] transition-colors`,placeholder:"sicheres-passwort",value:_,onChange:s=>p(s.target.value)}),e.jsx("button",{type:"button",className:`absolute inset-y-0 right-0 pr-3 flex items-center text-sm text-[${n.primary}] hover:text-[${n.primary}]/80 dark:text-white dark:hover:text-gray-300`,onClick:Y,children:"Generieren"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"identCode",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Ident-Code"}),e.jsx("input",{id:"identCode",type:"text",className:`px-4 py-2 border rounded-md w-full dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-[${n.primary}]/30 focus:border-[${n.primary}] transition-colors`,placeholder:"z.B. ABC123",value:S,onChange:s=>C(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"identUrl",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Ident-URL"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(me,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"identUrl",type:"url",className:"pl-10 pr-4 py-2 border rounded-md w-full dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent dark:focus:ring-accent",placeholder:"https://example.com/ident/...",value:$,onChange:s=>P(s.target.value)})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"phoneNumber",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Telefonnummer zuweisen"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(ne,{className:"h-5 w-5 text-gray-400"})}),e.jsxs("select",{id:"phoneNumber",className:"pl-10 pr-4 py-2 border rounded-md w-full dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent dark:focus:ring-accent",value:z,onChange:Q,children:[e.jsx("option",{value:"",children:"Telefonnummer auswählen"}),L.map(s=>e.jsxs("option",{value:s.id,children:[s.phone_number," (",s.service," - ",s.country,")"]},s.id))]})]}),L.length===0&&e.jsx("p",{className:`mt-1 text-sm text-[${n.accent}] dark:text-[${n.accentLight}]`,children:"Keine Telefonnummern verfügbar. Bitte fügen Sie Telefonnummern im Admin-Bereich hinzu."})]}),e.jsxs("div",{className:"pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3",children:[e.jsx(b,{variant:"outline",onClick:F,disabled:N,children:"Abbrechen"}),e.jsx(b,{onClick:V,disabled:N,className:"flex items-center",children:N?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"mr-1 animate-spin",size:16}),e.jsx("span",{children:"Wird gespeichert..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"mr-1",size:16}),e.jsx("span",{children:"Speichern"})]})})]})]})})]})]})]})};export{be as default};
