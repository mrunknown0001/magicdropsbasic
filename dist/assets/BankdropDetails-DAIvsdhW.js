import{P as xe,G as ge,ah as he,r as n,u as be,s as m,j as e,L as ue,e as b,b as fe,aX as pe,Q as ye,C as G,m as D,Y as ke,K as E,J as $,f as je,h as K,k as O,l as Z,w as Ne,i as W,o as X,D as we,B as ve,F as J,M as _e,z as u,_ as De,O as Ae}from"./index-C2zOcIr5.js";import{u as ze}from"./useTaskAssignment-DzXizOwJ.js";import{E as R}from"./external-link-Bq5Q6tnA.js";const $e=()=>{var H,U;const{id:A}=xe(),Q=ge(),F=he(),[a,Y]=n.useState(null),[r,z]=n.useState(null),[L,V]=n.useState([]),[ee,P]=n.useState(!0),[re,T]=n.useState(null),[se,ae]=n.useState(null),[x,j]=n.useState(!1),[te,C]=n.useState(!1),[N,w]=n.useState(""),[I,v]=n.useState(""),{user:M}=be(),{approveTaskSubmission:ne,rejectTaskSubmission:ie}=ze(),p=n.useRef(!1),_=n.useRef(!1),y=n.useRef(0),k=n.useRef(null),h=n.useMemo(()=>new URLSearchParams(F.search).get("assignment"),[F.search]);n.useEffect(()=>{const s=async()=>{if(!A||!h)return;if(_.current){console.log("Data fetch already in progress for BankdropDetails, skipping");return}const t=Date.now();if(t-y.current<5e3&&y.current>0){console.log(`In cooling period for BankdropDetails, not fetching again. Last fetch: ${new Date(y.current).toLocaleTimeString()}`);return}if(p.current&&r){console.log("BankdropDetails data already fetched, using cached data");return}console.log("Fetching BankdropDetails data..."),P(!0),_.current=!0,y.current=t;try{const{data:l,error:g}=await m.from("task_templates").select("id, title, play_store_url, app_store_url").eq("id",A).single();if(g)throw g;Y(l),console.log("Looking for assignment with ID:",h);const{data:d,error:B}=await m.from("task_assignments").select("*").eq("id",h).single();if(B)throw console.error("Error fetching assignment data:",B),B;if(console.log("Assignment data fetched:",d),d&&d.task_id&&console.log("Associated task ID:",d.task_id),d){if(d.assignee_id){const{data:c,error:f}=await m.rpc("get_profiles_with_emails_by_ids",{profile_ids:[d.assignee_id]});!f&&c&&c.length>0&&(d.assignee=c[0])}if(d.phone_number_id){console.log("Fetching phone number for ID:",d.phone_number_id);const{data:c,error:f}=await m.from("phone_numbers").select("phone_number").eq("id",d.phone_number_id).single();!f&&c?(console.log("Found phone number:",c.phone_number),ae(c.phone_number)):console.error("Error fetching phone number:",f)}if(d.task_id){const{data:c,error:f}=await m.from("task_attachments").select("*").eq("task_id",d.task_id);!f&&c&&V(c)}z(d)}p.current=!0,T(null)}catch(l){console.error("Error fetching bankdrop details:",l),T(l instanceof Error?l:new Error("Failed to fetch bankdrop details")),u.error("Fehler beim Laden der Bankdrop-Details")}finally{P(!1),_.current=!1}};if(s(),!k.current&&h){console.log("Setting up real-time subscription for BankdropDetails");const t=m.channel(`bankdrop-assignment-${h}`);t.on("postgres_changes",{event:"*",schema:"public",table:"task_assignments",filter:`id=eq.${h}`},o=>{console.log("Task assignment change detected:",o),_.current||(Date.now()-y.current>5e3?(console.log("Refetching data after task assignment change"),p.current=!1,s()):console.log("Change detected but in cooling period, not refetching"))}).subscribe(o=>{console.log(`Bankdrop details subscription status: ${o}`)}),k.current=t}return()=>{k.current&&(console.log("Cleaning up Bankdrop details subscription"),m.removeChannel(k.current),k.current=null)}},[A,h]);const de=async s=>{try{const{data:t,error:o}=await m.storage.from("task-attachments").download(s.file_path);if(o)throw o;const l=URL.createObjectURL(t),g=document.createElement("a");g.href=l,g.setAttribute("download",s.file_name),document.body.appendChild(g),g.click(),g.remove(),u.success("Dokument erfolgreich heruntergeladen")}catch(t){console.error("Error downloading attachment:",t),u.error("Fehler beim Herunterladen des Dokuments")}},S=s=>{try{return De(new Date(s),"dd.MM.yyyy HH:mm",{locale:Ae})}catch{return"Ung√ºltiges Datum"}},q=()=>{Q("/admin/bankdrops")},le=async()=>{if(!(!r||!M||x)){j(!0);try{await ne(r.id),u.success("Aufgabe erfolgreich genehmigt!"),p.current=!1,await(async()=>{const{data:t,error:o}=await m.from("task_assignments").select("*").eq("id",r.id).single();!o&&t&&z(l=>({...l,...t}))})()}catch(s){console.error("Error approving task:",s),u.error("Fehler beim Genehmigen der Aufgabe")}finally{j(!1)}}},oe=async()=>{if(!(!r||!M||!N.trim()||x)){j(!0);try{await ie(r.id,N,I),u.success("Aufgabe abgelehnt und Feedback gesendet!"),p.current=!1,await(async()=>{const{data:t,error:o}=await m.from("task_assignments").select("*").eq("id",r.id).single();!o&&t&&z(l=>({...l,...t}))})(),C(!1),w(""),v("")}catch(s){console.error("Error rejecting task:",s),u.error("Fehler beim Ablehnen der Aufgabe")}finally{j(!1)}}},ce=()=>{w(""),v(""),C(!0)},me=()=>{C(!1),w(""),v("")};if(ee&&!r)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(ue,{size:"lg"})});if(re||!r)return e.jsx("div",{className:"flex flex-col items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"Fehler beim Laden der Bankdrop-Details"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-4",children:"Die angeforderte Aufgabe konnte nicht gefunden werden."}),e.jsx(b,{onClick:q,children:"Zur√ºck zur √úbersicht"})]})});const{colors:i}=fe(),{theme:Ce}=pe();return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsxs(b,{variant:"ghost",onClick:q,className:"mr-4 dark:text-white",children:[e.jsx(ye,{size:16,className:"mr-2"}),"Zur√ºck"]}),e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white flex items-center",children:[e.jsx(G,{size:24,className:`mr-3 text-[${i.primary}] dark:text-white`}),(a==null?void 0:a.title)||"Bankdrop-Details"]})]}),r.status==="submitted"&&e.jsx(D.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-6 mb-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between",children:[e.jsxs("div",{className:"flex items-start mb-4 md:mb-0",children:[e.jsx(ke,{className:"mt-0.5 mr-3 text-blue-600 dark:text-blue-400",size:20}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-900 dark:text-blue-100 mb-1",children:"Aufgabe wartet auf Pr√ºfung"}),e.jsxs("p",{className:"text-blue-700 dark:text-blue-300 text-sm",children:["Diese Aufgabe wurde von ",(H=r.assignee)==null?void 0:H.first_name," ",(U=r.assignee)==null?void 0:U.last_name," eingereicht",r.submitted_at&&` am ${S(r.submitted_at)}`,". Pr√ºfen Sie die Unterlagen und genehmigen oder lehnen Sie die Aufgabe ab."]}),r.submission_data&&e.jsxs("p",{className:"text-blue-600 dark:text-blue-400 text-xs mt-1",children:["üìé ",Object.keys(r.submission_data).length," zus√§tzliche Datenfelder √ºbermittelt"]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx(b,{variant:"success",onClick:le,disabled:x,leftIcon:e.jsx(E,{size:16}),children:x?"Wird genehmigt...":"Genehmigen"}),e.jsx(b,{variant:"danger",onClick:ce,disabled:x,leftIcon:e.jsx($,{size:16}),children:"Ablehnen"})]})]})}),(r.status==="completed"||r.status==="rejected")&&r.reviewed_at&&e.jsx(D.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:`p-6 border-l-4 rounded-r-lg mb-6 ${r.status==="completed"?"border-green-500 bg-green-50 dark:bg-green-900/20":"border-red-500 bg-red-50 dark:bg-red-900/20"}`,children:e.jsxs("div",{className:"flex items-start",children:[r.status==="completed"?e.jsx(E,{className:"mt-0.5 mr-3 text-green-600 dark:text-green-400",size:20}):e.jsx($,{className:"mt-0.5 mr-3 text-red-600 dark:text-red-400",size:20}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:`text-lg font-semibold mb-1 ${r.status==="completed"?"text-green-900 dark:text-green-100":"text-red-900 dark:text-red-100"}`,children:r.status==="completed"?"Aufgabe genehmigt":"Aufgabe abgelehnt"}),e.jsxs("p",{className:`text-sm mb-2 ${r.status==="completed"?"text-green-700 dark:text-green-300":"text-red-700 dark:text-red-300"}`,children:["Gepr√ºft am ",S(r.reviewed_at)]}),r.status==="rejected"&&r.rejection_reason&&e.jsxs("div",{className:"mt-3 p-3 bg-red-100 dark:bg-red-900/30 rounded border border-red-200 dark:border-red-700",children:[e.jsx("h4",{className:"text-sm font-medium text-red-900 dark:text-red-100 mb-1",children:"Ablehnungsgrund:"}),e.jsx("p",{className:"text-red-800 dark:text-red-200 text-sm",children:r.rejection_reason}),r.admin_notes&&e.jsxs(e.Fragment,{children:[e.jsx("h4",{className:"text-sm font-medium text-red-900 dark:text-red-100 mt-2 mb-1",children:"Zus√§tzliche Hinweise:"}),e.jsx("p",{className:"text-red-800 dark:text-red-200 text-sm",children:r.admin_notes})]})]})]})]})}),e.jsx("div",{className:`p-4 border-l-4 border-[${i.primary}] dark:border-[${i.primary}] bg-[${i.primary}]/5 dark:bg-gray-800 rounded-r-md mb-6`,children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(je,{className:`mt-0.5 mr-3 text-[${i.primary}] dark:text-white`,size:20}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Bankkonto-Informationen"}),e.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-300",children:"Diese Daten sind vertraulich und ausschlie√ülich f√ºr autorisierte Mitarbeiter bestimmt. Bitte behandeln Sie alle Informationen mit angemessener Sorgfalt. üòâ"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(K,{className:"col-span-1 border-0 shadow-sm overflow-hidden dark:bg-gray-800 border border-gray-200 dark:border-gray-700",children:[e.jsx(O,{className:`border-b border-gray-100 dark:border-gray-700 bg-[${i.primary}]/5 dark:bg-gray-700/50`,children:e.jsxs(Z,{className:"font-app font-app-medium text-gray-900 dark:text-white flex items-center",children:[e.jsx(Ne,{size:18,className:`mr-2 text-[${i.primary}] dark:text-white`}),"Kontoinhaber"]})}),e.jsx(W,{className:"pt-5",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-start",children:e.jsxs("div",{className:"ml-0",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100",children:r.assignee?`${r.assignee.first_name} ${r.assignee.last_name}`:"Unbekannter Kontoinhaber"}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:["Erfasst am ",S(r.created_at)]})]})}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:"Kontostatus"}),e.jsx("span",{className:`px-2.5 py-1 rounded-full text-xs font-medium flex items-center w-fit ${r.status==="completed"?"bg-green-100 text-green-800 dark:bg-green-700/30 dark:text-white":r.status==="submitted"?"bg-blue-100 text-blue-800 dark:bg-blue-700/30 dark:text-white":r.status==="rejected"?"bg-red-100 text-red-800 dark:bg-red-700/30 dark:text-white":"bg-yellow-100 text-yellow-800 dark:bg-yellow-700/30 dark:text-white"}`,children:r.status==="completed"?e.jsxs(e.Fragment,{children:[e.jsx(E,{size:14,className:"mr-1"}),"Genehmigt"]}):r.status==="submitted"?e.jsxs(e.Fragment,{children:[e.jsx(X,{size:14,className:"mr-1"}),"Eingereicht"]}):r.status==="rejected"?e.jsxs(e.Fragment,{children:[e.jsx($,{size:14,className:"mr-1"}),"Abgelehnt"]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{size:14,className:"mr-1"}),"Ausstehend"]})})]}),r.phone_number_id&&e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Telefonnummer"}),e.jsx("p",{className:"text-gray-900 dark:text-white font-mono flex items-center",children:se||"L√§dt..."})]})]})})]}),e.jsxs(K,{className:"col-span-1 lg:col-span-2 border-0 shadow-sm overflow-hidden dark:bg-gray-800 border border-gray-200 dark:border-gray-700",children:[e.jsx(O,{className:`border-b border-gray-100 dark:border-gray-700 bg-[${i.primary}]/5 dark:bg-gray-700/50`,children:e.jsxs(Z,{className:"font-app font-app-medium text-gray-900 dark:text-white flex items-center",children:[e.jsx(G,{size:18,className:`mr-2 text-[${i.primary}] dark:text-white`}),"Bankkonto-Details"]})}),e.jsx(W,{className:"pt-5",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600",children:e.jsxs("h3",{className:"text-sm font-medium text-gray-900 dark:text-white flex items-center",children:[e.jsx(we,{size:16,className:"mr-2 text-gray-500 dark:text-gray-300"}),"Online-Banking Zugangsdaten"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center py-2 border-b border-gray-100 dark:border-gray-700",children:[e.jsx("span",{className:"w-32 flex-shrink-0 text-gray-500 dark:text-gray-400 mb-1 sm:mb-0",children:"Benutzername:"}),e.jsx("span",{className:"text-gray-900 dark:text-white font-mono",children:(r==null?void 0:r.demo_email)||"Nicht verf√ºgbar"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center py-2 border-b border-gray-100 dark:border-gray-700",children:[e.jsx("span",{className:"w-32 flex-shrink-0 text-gray-500 dark:text-gray-400 mb-1 sm:mb-0",children:"Passwort:"}),e.jsx("span",{className:"text-gray-900 dark:text-white font-mono",children:(r==null?void 0:r.demo_password)||"Nicht verf√ºgbar"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center py-2 border-b border-gray-100 dark:border-gray-700",children:[e.jsx("span",{className:"w-32 flex-shrink-0 text-gray-500 dark:text-gray-400 mb-1 sm:mb-0",children:"Ident-Code:"}),e.jsx("span",{className:"text-gray-900 dark:text-white font-mono",children:(r==null?void 0:r.ident_code)||"Nicht verf√ºgbar"})]}),r.ident_url&&e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center py-2",children:[e.jsx("span",{className:"w-32 flex-shrink-0 text-gray-500 dark:text-gray-400 mb-1 sm:mb-0",children:"Ident-URL:"}),e.jsxs("a",{href:r.ident_url,target:"_blank",rel:"noopener noreferrer",className:`text-[${i.primary}] dark:text-blue-400 hover:underline flex items-center`,children:[e.jsx("span",{className:"truncate max-w-xs",children:"Link √∂ffnen"}),e.jsx(R,{size:12,className:"ml-1 flex-shrink-0"})]})]})]})]}),((a==null?void 0:a.play_store_url)||(a==null?void 0:a.app_store_url))&&e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600",children:e.jsxs("h3",{className:"text-sm font-medium text-gray-900 dark:text-white flex items-center",children:[e.jsx(ve,{size:16,className:"mr-2 text-gray-500 dark:text-gray-300"}),"Mobile Banking"]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[(a==null?void 0:a.play_store_url)&&e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center py-2 border-b border-gray-100 dark:border-gray-700",children:[e.jsx("span",{className:"w-32 flex-shrink-0 text-gray-500 dark:text-gray-400 mb-1 sm:mb-0",children:"Android App:"}),e.jsxs("a",{href:a.play_store_url,target:"_blank",rel:"noopener noreferrer",className:`text-[${i.primary}] dark:text-blue-400 hover:underline flex items-center`,children:[e.jsx("span",{className:"truncate max-w-xs",children:"Google Play Store"}),e.jsx(R,{size:12,className:"ml-1 flex-shrink-0"})]})]}),(a==null?void 0:a.app_store_url)&&e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center py-2",children:[e.jsx("span",{className:"w-32 flex-shrink-0 text-gray-500 dark:text-gray-400 mb-1 sm:mb-0",children:"iOS App:"}),e.jsxs("a",{href:a.app_store_url,target:"_blank",rel:"noopener noreferrer",className:`text-[${i.primary}] dark:text-blue-400 hover:underline flex items-center`,children:[e.jsx("span",{className:"truncate max-w-xs",children:"Apple App Store"}),e.jsx(R,{size:12,className:"ml-1 flex-shrink-0"})]})]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md overflow-hidden",children:[e.jsx("div",{className:"px-4 py-3 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600",children:e.jsxs("h3",{className:"text-sm font-medium text-gray-900 dark:text-white flex items-center",children:[e.jsx(J,{size:16,className:"mr-2 text-gray-500 dark:text-gray-300"}),"Bankunterlagen"]})}),e.jsx("div",{className:"p-4",children:L.length===0?e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-sm p-2",children:"Keine Bankunterlagen verf√ºgbar"}):e.jsx(D.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-2",children:L.map(s=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-3 rounded border border-gray-200 dark:border-gray-600",children:[e.jsxs("div",{className:"flex items-center overflow-hidden",children:[e.jsx(J,{size:16,className:`text-[${i.primary}] dark:text-gray-300 mr-2 flex-shrink-0`}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white truncate",children:s.file_name}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[(s.file_size/1024).toFixed(1)," KB"]})]})]}),e.jsxs(b,{onClick:()=>de(s),size:"sm",variant:"primary",className:"text-white",style:{backgroundColor:i.primary,borderColor:i.primary},children:[e.jsx(_e,{size:16,className:"mr-2"}),"Herunterladen"]})]},s.id))})})]})]})})]})]}),te&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs(D.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Aufgabe ablehnen"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Ablehnungsgrund *"}),e.jsx("textarea",{className:"w-full px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none focus:ring-2 focus:ring-red-500/20 focus:border-red-500 outline-none",rows:3,placeholder:"Beschreiben Sie, warum die Aufgabe abgelehnt wird...",value:N,onChange:s=>w(s.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Zus√§tzliche Hinweise (optional)"}),e.jsx("textarea",{className:"w-full px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none focus:ring-2 focus:ring-red-500/20 focus:border-red-500 outline-none",rows:2,placeholder:"Weitere Hinweise f√ºr den Mitarbeiter...",value:I,onChange:s=>v(s.target.value)})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx(b,{variant:"outline",onClick:me,disabled:x,children:"Abbrechen"}),e.jsx(b,{variant:"danger",onClick:oe,disabled:!N.trim()||x,children:x?"Wird abgelehnt...":"Ablehnen"})]})]})})]})};export{$e as default};
