import{r as i,G as W,j as e,m as f,e as d,L as M,F as k,h as X,i as Z,w as P,aQ as $,K as C,X as I,M as J,a as U,z as _,f as ee,o as te,s as B}from"./index-C2zOcIr5.js";import{M as re}from"./Modal-BgYYuuIM.js";import{D as m}from"./KycDocumentUpload-fkAmUNAE.js";import{R as ae}from"./refresh-cw-BQFYSu-c.js";import"./external-link-Bq5Q6tnA.js";import"./upload-DWuvDsn2.js";const ge=()=>{const[c,E]=i.useState([]),[D,z]=i.useState(!0),[j,K]=i.useState(null),[n,G]=i.useState("in_review"),[s,h]=i.useState(null),[V,y]=i.useState(!1),[R,o]=i.useState({}),[q,L]=i.useState(!1);W();const H=async t=>{h(t),y(!0),L(!0),o({});try{console.log("Loading KYC documents for employee:",t.id);const{data:r,error:a}=await B.storage.from("kyc_documents").list(`${t.id}`,{sortBy:{column:"created_at",order:"desc"}});if(a){if(a.message.includes("not found")||a.message.includes("does not exist")){o({});return}throw a}console.log("Files found in storage:",r);const g=(r||[]).filter(l=>l.name!==".keep");console.log("Filtered files (excluding .keep):",g);const p={};for(const l of g){const u=`${t.id}/${l.name}`;let S;const Y=Object.values(m).find(x=>l.name.startsWith(`${x}_`));Y?S=Y:(console.warn("Could not determine document type from filename:",l.name),S=l.name.split("_")[0]);try{const{data:{signedUrl:x},error:T}=await B.storage.from("kyc_documents").createSignedUrl(u,3600);T?console.error("Error creating signed URL:",T):x&&(p[S]=x)}catch(x){console.error(`Error creating signed URL for ${l.name}:`,x)}}o(p),console.log("Loaded document URLs:",Object.keys(p))}catch(r){console.error("Error in openKycModal:",r),_.error("Fehler beim Laden der Dokumente")}finally{L(!1)}},w=async()=>{try{z(!0),console.log("=== FETCH KYC SUBMISSIONS CALLED ===");const{data:t,error:r}=await U.from("profiles").select("id, first_name, last_name, email, role, kyc_status, kyc_documents, kyc_verified_at, updated_at, created_at").eq("role","employee").not("kyc_status","is",null).order("updated_at",{ascending:!1});if(r)throw console.error("Supabase error:",r),r;console.log("KYC SUBMISSIONS FROM ADMIN CLIENT:",t==null?void 0:t.length,t),E(t||[])}catch(t){console.error("Error fetching KYC submissions:",t),_.error("Fehler beim Laden der KYC-PrÃ¼fungen")}finally{z(!1)}},b=async(t,r)=>{try{K(t);const a={kyc_status:r,updated_at:new Date().toISOString()};r==="approved"?a.kyc_verified_at=new Date().toISOString():r==="rejected"&&(a.kyc_verified_at=null),console.log("ðŸ”„ Admin KYC Review: Updating KYC status:",{profileId:t,newStatus:r,updateData:a});const{error:g}=await U.from("profiles").update(a).eq("id",t);if(g)throw g;E(l=>l.map(u=>u.id===t?{...u,kyc_status:r,updated_at:new Date().toISOString(),kyc_verified_at:r==="approved"?new Date().toISOString():r==="rejected"?null:u.kyc_verified_at}:u));const p={approved:"genehmigt",rejected:"abgelehnt",in_review:"zur PrÃ¼fung markiert"};_.success(`KYC-Status erfolgreich ${p[r]}`),setTimeout(()=>{w()},1e3),console.log("ðŸ”„ Admin KYC Review: Status update completed successfully")}catch(a){console.error("Error updating KYC status:",a),_.error("Fehler beim Aktualisieren des KYC-Status")}finally{K(null)}},A=t=>{const r={pending:{bg:"bg-yellow-100 dark:bg-yellow-900/30",text:"text-yellow-800 dark:text-yellow-300",label:"Zu prÃ¼fen"},in_review:{bg:"bg-blue-100 dark:bg-blue-900/30",text:"text-blue-800 dark:text-blue-300",label:"In PrÃ¼fung"},approved:{bg:"bg-green-100 dark:bg-green-900/30",text:"text-green-800 dark:text-green-300",label:"Genehmigt"},rejected:{bg:"bg-red-100 dark:bg-red-900/30",text:"text-red-800 dark:text-red-300",label:"Abgelehnt"}},a=r[t]||r.pending;return e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${a.bg} ${a.text}`,children:a.label})},F=t=>{switch(t){case"approved":return e.jsx(C,{size:16,className:"text-green-600 dark:text-green-400"});case"rejected":return e.jsx(I,{size:16,className:"text-red-600 dark:text-red-400"});case"in_review":return e.jsx(te,{size:16,className:"text-blue-600 dark:text-blue-400"});default:return e.jsx(ee,{size:16,className:"text-yellow-600 dark:text-yellow-400"})}},O=t=>{try{return new Date(t).toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return"Unbekannt"}},v=c.filter(t=>(console.log("FILTERING:",n,"USER:",t.first_name,"STATUS:",t.kyc_status),n==="all"?!0:t.kyc_status===n));console.log("TOTAL SUBMISSIONS:",c.length),console.log("SELECTED FILTER:",n),console.log("FILTERED SUBMISSIONS:",v.length),console.log("ALL SUBMISSIONS:",c),console.log("FILTERED RESULTS:",v);const Q=()=>({all:c.length,pending:c.filter(t=>t.kyc_status==="pending").length,in_review:c.filter(t=>t.kyc_status==="in_review").length,approved:c.filter(t=>t.kyc_status==="approved").length,rejected:c.filter(t=>t.kyc_status==="rejected").length});i.useEffect(()=>{w()},[]);const N=Q();return e.jsxs("div",{className:"space-y-6",children:[e.jsx(f.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-gradient-to-r from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-xl p-6 shadow-sm",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"KYC-PrÃ¼fung"}),e.jsx("p",{className:"mt-2 text-gray-600 dark:text-gray-300",children:"ÃœberprÃ¼fen und genehmigen Sie eingereichte KYC-Dokumente"})]}),e.jsx("div",{className:"mt-4 md:mt-0",children:e.jsx(d,{variant:"outline",size:"sm",onClick:w,disabled:D,leftIcon:e.jsx(ae,{className:"h-4 w-4"}),children:"Aktualisieren"})})]})}),e.jsx(f.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1},className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-1",children:e.jsx("div",{className:"flex flex-wrap gap-1",children:[{key:"all",label:"Alle",count:N.all},{key:"in_review",label:"In PrÃ¼fung",count:N.in_review},{key:"approved",label:"Genehmigt",count:N.approved},{key:"rejected",label:"Abgelehnt",count:N.rejected}].map(t=>e.jsxs("button",{onClick:()=>G(t.key),className:`px-3 py-2 rounded-md text-sm font-medium transition-colors ${n===t.key?"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300":"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"}`,children:[t.label,t.count>0&&e.jsx("span",{className:`ml-2 px-2 py-0.5 rounded-full text-xs ${n===t.key?"bg-blue-200 text-blue-800 dark:bg-blue-800 dark:text-blue-200":"bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-300"}`,children:t.count})]},t.key))})}),D?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(M,{size:"lg"})}):v.length===0?e.jsxs(f.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"text-center py-12 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700",children:[e.jsx("div",{className:"p-4 rounded-full bg-gray-100 dark:bg-gray-700 mx-auto mb-4 w-16 h-16 flex items-center justify-center",children:e.jsx(k,{className:"text-gray-500 dark:text-gray-400",size:28})}),e.jsx("h3",{className:"text-xl font-medium text-gray-900 dark:text-white mb-2",children:"Keine KYC-Einreichungen gefunden"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 max-w-md mx-auto",children:n==="all"?"Es wurden noch keine KYC-Dokumente eingereicht.":`Keine Einreichungen mit Status "${n==="in_review"?"In PrÃ¼fung":n==="approved"?"Genehmigt":"Abgelehnt"}" gefunden.`})]}):e.jsx(f.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"grid gap-6",children:v.map((t,r)=>e.jsx(f.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:r*.05},children:e.jsx(X,{className:"shadow-sm border border-gray-200 dark:border-gray-700",children:e.jsx(Z,{className:"p-6",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsx("div",{className:"p-3 rounded-full bg-gray-100 dark:bg-gray-700",children:e.jsx(P,{size:24,className:"text-gray-600 dark:text-gray-300"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:[t.first_name," ",t.last_name]}),F(t.kyc_status),A(t.kyc_status)]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mt-1",children:t.email}),e.jsxs("div",{className:"flex items-center space-x-4 mt-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{children:["Verifiziert: ",t.kyc_verified_at?O(t.kyc_verified_at):"Ausstehend"]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:["Aktualisiert: ",O(t.updated_at)]})]}),t.kyc_documents&&e.jsxs("div",{className:"mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Eingereichte Dokumente:"}),e.jsx("div",{className:"grid grid-cols-2 gap-2 text-xs text-gray-600 dark:text-gray-400",children:Object.entries(t.kyc_documents).map(([a,g])=>g&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(k,{size:12}),e.jsx("span",{className:"capitalize",children:a.replace("_"," ")})]},a))})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:()=>H(t),leftIcon:e.jsx($,{size:14}),children:"KYC prÃ¼fen"}),t.kyc_status!=="approved"&&e.jsx(d,{variant:"outline",size:"sm",onClick:()=>b(t.id,"approved"),disabled:j===t.id,leftIcon:e.jsx(C,{size:14}),className:"text-green-600 border-green-300 hover:bg-green-50 dark:text-green-400 dark:border-green-700 dark:hover:bg-green-900/20",children:"Genehmigen"}),t.kyc_status!=="rejected"&&e.jsx(d,{variant:"outline",size:"sm",onClick:()=>b(t.id,"rejected"),disabled:j===t.id,leftIcon:e.jsx(I,{size:14}),className:"text-red-600 border-red-300 hover:bg-red-50 dark:text-red-400 dark:border-red-700 dark:hover:bg-red-900/20",children:"Ablehnen"})]})]})})})},t.id))}),e.jsx(re,{isOpen:V,onClose:()=>{y(!1),h(null),o({})},title:"KYC-Dokumente prÃ¼fen",size:"xl",children:s&&e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"mb-6 pb-4 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center",children:e.jsx(P,{size:20,className:"text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:[s.first_name," ",s.last_name]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:s.email}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[F(s.kyc_status),A(s.kyc_status)]})]})]})}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("h4",{className:"text-md font-medium text-gray-900 dark:text-white mb-4 flex items-center",children:[e.jsx(k,{size:16,className:"mr-2"}),"Hochgeladene Dokumente"]}),q?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(M,{size:"md"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-2",children:"Dokumente werden geladen..."})]}):Object.keys(R).length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:Object.entries(R).map(([t,r])=>{const a=r.toLowerCase().includes(".jpg")||r.toLowerCase().includes(".jpeg")||r.toLowerCase().includes(".png");return e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h5",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t===m.IDENTITY_CARD_FRONT?"Ausweis Vorderseite":t===m.IDENTITY_CARD_BACK?"Ausweis RÃ¼ckseite":t===m.PASSPORT?"Reisepass":t===m.DRIVERS_LICENSE_FRONT?"FÃ¼hrerschein Vorderseite":t===m.DRIVERS_LICENSE_BACK?"FÃ¼hrerschein RÃ¼ckseite":t===m.ADDRESS_PROOF?"Adressnachweis":t}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>window.open(r,"_blank"),leftIcon:e.jsx(J,{size:12}),className:"text-xs",children:"Download"})]}),a?e.jsx("div",{className:"aspect-video bg-gray-100 dark:bg-gray-800 rounded-md overflow-hidden",children:e.jsx("img",{src:r,alt:`${t} document`,className:"w-full h-full object-contain cursor-pointer hover:scale-105 transition-transform",onClick:()=>window.open(r,"_blank"),onError:()=>{console.error(`Failed to load image: ${t}`)}})}):e.jsx("div",{className:"aspect-video bg-gray-100 dark:bg-gray-800 rounded-md flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(k,{size:32,className:"text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"PDF Dokument"}),e.jsx(d,{size:"sm",variant:"outline",onClick:()=>window.open(r,"_blank"),leftIcon:e.jsx($,{size:12}),className:"mt-2",children:"Ã–ffnen"})]})})]},t)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(k,{size:48,className:"text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Keine Dokumente hochgeladen"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsx(d,{variant:"ghost",onClick:()=>{y(!1),h(null),o({})},children:"SchlieÃŸen"}),s.kyc_status!=="approved"&&e.jsx(d,{onClick:()=>{b(s.id,"approved"),y(!1),h(null),o({})},disabled:j===s.id,leftIcon:e.jsx(C,{size:16}),className:"bg-green-600 hover:bg-green-700 text-white",children:"Genehmigen"}),s.kyc_status!=="rejected"&&e.jsx(d,{onClick:()=>{b(s.id,"rejected"),y(!1),h(null),o({})},disabled:j===s.id,leftIcon:e.jsx(I,{size:16}),className:"bg-red-600 hover:bg-red-700 text-white",children:"Ablehnen"})]})]})})]})};export{ge as default};
