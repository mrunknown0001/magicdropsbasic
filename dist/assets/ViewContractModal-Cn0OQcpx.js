import{r as w,u as $,s as d,z as g,j as e,v as J,m as O,af as R,e as M,aO as B,O as H}from"./index-C2zOcIr5.js";import{e as X}from"./contractUtils-B5S0O9Tf.js";import{f as K}from"./formatDistanceToNow-Zog-F_3p.js";const W=()=>{const[C,b]=w.useState(()=>{try{const r=sessionStorage.getItem("contractsList");if(r){const t=JSON.parse(r);if(t.lastFetchTime&&Date.now()-t.lastFetchTime<3e5)return t.contracts||[]}}catch(r){console.error("Error retrieving stored contracts:",r)}return[]}),[a,o]=w.useState(!1),[A,j]=w.useState(null),{user:f,isAdmin:i}=$(),[c,F]=w.useState(()=>{try{const r=sessionStorage.getItem("contractsList");if(r)return JSON.parse(r).lastFetchTime||0}catch(r){console.error("Error retrieving last fetch time:",r)}return 0}),y=w.useRef(!1),n=w.useCallback(async(r=!1)=>{if(!f){console.log("No user found, skipping fetch");return}if(y.current){console.log("Data fetch already in progress, skipping");return}const t=Date.now();if(!r&&c&&t-c<5e3){console.log(`In cooling period, not fetching again. Last fetch: ${new Date(c).toLocaleTimeString()}`);return}c&&t-c<5*60*1e3||o(!0),y.current=!0,j(null);try{console.log("Fetching contracts data...");let l=d.from("contracts").select("*");if(i())l=l.eq("is_template",!0);else{const{data:p,error:S}=await d.from("contract_assignments").select("contract_id").eq("user_id",f.id);if(S)throw S;const T=(p==null?void 0:p.map(N=>N.contract_id))||[];if(T.length>0)l=l.in("id",T);else{b([]),o(!1),y.current=!1;const N=Date.now();F(N);try{sessionStorage.setItem("contractsList",JSON.stringify({contracts:[],lastFetchTime:N}))}catch(I){console.error("Error storing contracts in session storage:",I)}return[]}}const{data:L,error:D}=await l.order("created_at",{ascending:!1});if(D)throw D;const _=L||[];b(_);const E=Date.now();F(E);try{sessionStorage.setItem("contractsList",JSON.stringify({contracts:_,lastFetchTime:E}))}catch(p){console.error("Error storing contracts in session storage:",p)}return _}catch(l){console.error("Error fetching contracts:",l),j(l instanceof Error?l:new Error("Failed to fetch contracts")),g.error("Failed to fetch contracts")}finally{o(!1),y.current=!1}},[f,i,c]),m=async r=>{try{o(!0);const{title:t,category:s,content:u,is_active:l,is_template:L,parent_id:D,version_number:_,template_data:E,version:p,created_by:S}=r,T={title:t,category:s,content:u,is_active:l,is_template:L,parent_id:D,version_number:_,template_data:E,version:p,created_by:S},{data:N,error:I}=await d.from("contracts").insert([T]).select().single();if(I)throw I;return await n(!0),g.success("Contract created successfully"),N}catch(t){throw console.error("Failed to create contract:",t),g.error(`Failed to create contract: ${t instanceof Error?t.message:String(t)}`),t}finally{o(!1)}},v=async r=>m({...r,is_template:!0,version_number:r.version_number||1}),x=async(r,t)=>{try{o(!0);const{data:s,error:u}=await d.from("contracts").update(t).eq("id",r).select().single();if(u)throw u;return await n(!0),g.success("Contract updated successfully"),s}catch(s){throw console.error("Failed to update contract:",s),g.error("Failed to update contract"),s}finally{o(!1)}},h=async r=>{try{o(!0);const{error:t}=await d.from("contracts").delete().eq("id",r);if(t)throw t;return await n(!0),g.success("Contract deleted successfully"),!0}catch(t){throw console.error("Failed to delete contract:",t),g.error("Failed to delete contract"),t}finally{o(!1)}},k=async r=>{try{o(!0);const{data:t,error:s}=await d.from("contracts").select("*").eq("id",r).single();if(s)throw s;return t}catch(t){throw console.error("Failed to get contract by ID:",t),t}finally{o(!1)}},q=async r=>{try{o(!0);const{data:t,error:s}=await d.from("contract_assignments").select("*, contract:contracts(*)").eq("id",r).single();if(s)throw s;return t}catch(t){throw console.error("Failed to get assigned contract by ID:",t),t}finally{o(!1)}},V=async r=>{try{const{data:t,error:s}=await d.from("contract_assignments").select("*, user:profiles(*)").eq("contract_id",r);if(s)throw s;return t}catch(t){throw console.error("Failed to get contract assignments:",t),t}},z=async r=>{try{const{data:t,error:s}=await d.from("contract_assignments").select("*, contract:contracts(*)").eq("user_id",r).order("assigned_at",{ascending:!1});if(s)throw s;return t}catch(t){throw console.error("Failed to get assigned contracts:",t),t}},P=async(r,t)=>{try{o(!0);const{data:s,error:u}=await d.from("contract_assignments").update({status:"signed",signature_data:t,signed_at:new Date().toISOString()}).eq("id",r).select().single();if(u)throw u;return await n(!0),g.success("Contract signed successfully"),s}catch(s){throw console.error("Failed to sign contract:",s),g.error("Failed to sign contract"),s}finally{o(!1)}};return w.useEffect(()=>{f&&n()},[n,f]),{contracts:C,loading:a,error:A,lastFetchTime:c,fetchContracts:n,createContract:m,createContractTemplate:v,updateContract:x,deleteContract:h,getContractAssignments:V,getAssignedContracts:z,getContractById:k,getAssignedContractById:q,signContract:P}},Y=({isOpen:C,onClose:b,contract:a,isAdmin:o})=>{if(!C||!a)return null;const A=i=>{const c=document.createElement("div");c.innerHTML=i;const F=n=>{if(n.nodeType===Node.TEXT_NODE&&n.textContent){const m=document.createDocumentFragment(),v=/{{(.*?)}}/g;let x=0,h;for(;(h=v.exec(n.textContent))!==null;){h.index>x&&m.appendChild(document.createTextNode(n.textContent.substring(x,h.index)));const k=document.createElement("span");k.className="bg-yellow-100 dark:bg-yellow-900/30 px-1 rounded",k.textContent=h[0],m.appendChild(k),x=h.index+h[0].length}if(x<n.textContent.length&&m.appendChild(document.createTextNode(n.textContent.substring(x))),n.parentNode&&x>0)return n.parentNode.replaceChild(m,n),!0}return!1},y=n=>{const m=Array.from(n.childNodes);for(const v of m)y(v);F(n)};return y(c),e.jsx("div",{className:"rich-content-preview",dangerouslySetInnerHTML:{__html:c.innerHTML}})},j=X(a.content),f=()=>{alert("PDF Download functionality will be implemented soon.")};return e.jsx(J,{children:C&&e.jsxs(e.Fragment,{children:[e.jsx(O.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black bg-opacity-50 z-40",onClick:b}),e.jsx(O.div,{initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},transition:{type:"spring",damping:25,stiffness:300},className:"fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-0",onClick:i=>i.stopPropagation(),children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden w-full max-w-4xl mx-auto max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:a.title}),e.jsx("button",{onClick:b,className:"text-gray-400 hover:text-gray-500 focus:outline-none",children:e.jsx(R,{size:20})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"md:col-span-1 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Kategorie"}),e.jsx("p",{className:"mt-1 text-sm text-gray-900 dark:text-white",children:a.category})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Version"}),e.jsxs("p",{className:"mt-1 text-sm text-gray-900 dark:text-white",children:["v",a.version," ",a.version_number?`(${a.version_number})`:""]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Status"}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${a.status==="Aktiv"?"bg-green-100 text-green-800 dark:bg-green-200 dark:text-green-900":"bg-red-100 text-red-800 dark:bg-red-200 dark:text-red-900"}`,children:a.status||"Aktiv"})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Letzte Aktualisierung"}),e.jsx("p",{className:"mt-1 text-sm text-gray-900 dark:text-white",children:K(new Date(a.updated_at),{addSuffix:!0,locale:H})})]}),j.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Verwendete Variablen"}),e.jsx("div",{className:"mt-1 space-y-2",children:j.map(i=>e.jsxs("div",{className:"flex items-start",children:[e.jsxs("span",{className:"text-xs font-medium text-gray-500 dark:text-gray-400 min-w-[80px]",children:[`{{${i}}}`,":"]}),e.jsx("span",{className:"text-xs text-gray-900 dark:text-white ml-2",children:a.template_data&&a.template_data[i]?String(a.template_data[i]):"Nicht definiert"})]},i))})]}),a.template_data&&Object.keys(a.template_data).length>0&&j.length<Object.keys(a.template_data).length&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:"Alle Variablen"}),e.jsx("div",{className:"mt-1 space-y-2",children:Object.entries(a.template_data).map(([i,c])=>e.jsxs("div",{className:"flex items-start",children:[e.jsxs("span",{className:"text-xs font-medium text-gray-500 dark:text-gray-400 min-w-[80px]",children:[`{{${i}}}`,":"]}),e.jsx("span",{className:"text-xs text-gray-900 dark:text-white ml-2",children:typeof c=="object"?JSON.stringify(c):String(c)})]},i))})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-4",children:"Vertragstext"}),e.jsx("div",{className:"p-4 border border-gray-200 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900/50 overflow-auto max-h-[600px]",children:A(a.content)})]})]})}),e.jsx("div",{className:"flex justify-end items-center gap-3 p-6 border-t border-gray-200 dark:border-gray-700",children:e.jsx(M,{type:"button",variant:"outline",leftIcon:e.jsx(B,{size:16}),onClick:f,children:"PDF herunterladen"})})]})})]})})};export{Y as V,W as u};
