import{r as c,u as K,s as E,z as d,U as W,G as V,j as e,o as J,e as f,Z,h as Q,k as X,l as Y,H as ee,i as te,L as se,f as P,A as re,m as _,_ as ae,K as ie,O as ne}from"./index-C2zOcIr5.js";import{E as le}from"./EditTaskModal-Cq5ZhT06.js";import{R as q}from"./refresh-cw-BQFYSu-c.js";import{F as ce}from"./funnel-By8gi63k.js";import{E as U}from"./external-link-Bq5Q6tnA.js";import{S as oe}from"./square-pen-Df1rf3Dp.js";import{T as de}from"./trash-2-CucBzA-1.js";import"./useEmployees-BfxrKmlR.js";import"./connectionManager-WW8tX6Ox.js";const xe=()=>{const[j,g]=c.useState(()=>{try{const r=sessionStorage.getItem("adminTasksList");if(r){const s=JSON.parse(r);if(s.lastFetchTime&&Date.now()-s.lastFetchTime<3e5)return s.tasks||[]}}catch(r){console.error("Error retrieving stored tasks:",r)}return[]}),[F,i]=c.useState(!1),[N,p]=c.useState(null),{user:n,isAdmin:C}=K(),[l,z]=c.useState(()=>{try{const r=sessionStorage.getItem("adminTasksList");if(r)return JSON.parse(r).lastFetchTime||0}catch(r){console.error("Error retrieving last fetch time:",r)}return 0}),x=c.useRef(!1),h=c.useCallback(async(r=!1)=>{if(!n){console.log("No user found, skipping fetch");return}if(x.current){console.log("Data fetch already in progress, skipping");return}const s=Date.now();if(!r&&l&&s-l<5e3){console.log(`In cooling period, not fetching again. Last fetch: ${new Date(l).toLocaleTimeString()}`);return}l&&s-l<5*60*1e3||i(!0),x.current=!0,p(null);try{console.log("Fetching tasks data...");let m=E.from("tasks").select("*");C()||(m=m.eq("assignee_id",n.id));const{data:k,error:L}=await m.order("created_at",{ascending:!1});if(L)throw L;g(k||[]);const I=Date.now();z(I);try{sessionStorage.setItem("adminTasksList",JSON.stringify({tasks:k,lastFetchTime:I}))}catch(t){console.error("Error storing tasks in session storage:",t)}return k}catch(m){console.error("Error fetching tasks:",m),p(m instanceof Error?m:new Error("Failed to fetch tasks")),d.error("Failed to fetch tasks")}finally{i(!1),x.current=!1}},[n,C,l]),M=async r=>{try{i(!0);const{data:s,error:a}=await E.from("tasks").insert([r]).select().single();if(a)throw a;return await h(!0),d.success("Task created successfully"),s}catch(s){throw console.error("Failed to create task:",s),d.error("Failed to create task"),s}finally{i(!1)}},O=async(r,s)=>{try{i(!0);const{data:a,error:T}=await E.from("tasks").update(s).eq("id",r).select().single();if(T)throw T;return await h(!0),d.success("Task updated successfully"),a}catch(a){throw console.error("Failed to update task:",a),d.error("Failed to update task"),a}finally{i(!1)}},B=async r=>{try{i(!0);const{data:s,error:a}=await E.from("tasks").select("*").eq("id",r).single();if(a)throw a;return s}catch(s){throw console.error("Failed to fetch task:",s),d.error("Failed to fetch task"),s}finally{i(!1)}},D=async r=>{try{i(!0);const{error:s}=await E.from("tasks").delete().eq("id",r);if(s)throw s;return await h(!0),d.success("Task deleted successfully"),!0}catch(s){throw console.error("Failed to delete task:",s),d.error("Failed to delete task"),s}finally{i(!1)}};return c.useEffect(()=>{n&&h()},[h,n]),{tasks:j,loading:F,error:N,lastFetchTime:l,createTask:M,updateTask:O,deleteTask:D,getTaskById:B,fetchTasks:h}},w={PENDING:"pending",IN_PROGRESS:"in_progress",COMPLETED:"completed"},b={LOW:"low",MEDIUM:"medium",HIGH:"high"},me={[w.PENDING]:"Ausstehend",[w.IN_PROGRESS]:"In Bearbeitung",[w.COMPLETED]:"Abgeschlossen"},ge={[b.LOW]:"Niedrig",[b.MEDIUM]:"Mittel",[b.HIGH]:"Hoch"},S={[w.PENDING]:{bg:"bg-yellow-100",text:"text-yellow-800",icon:P,darkBg:"dark:bg-yellow-300",darkText:"dark:text-yellow-900"},[w.IN_PROGRESS]:{bg:"bg-blue-100",text:"text-blue-800",icon:J,darkBg:"dark:bg-blue-300",darkText:"dark:text-blue-900"},[w.COMPLETED]:{bg:"bg-green-100",text:"text-green-800",icon:ie,darkBg:"dark:bg-green-300",darkText:"dark:text-green-900"}},A={[b.LOW]:{bg:"bg-gray-100",text:"text-gray-800",darkBg:"dark:bg-gray-600",darkText:"dark:text-gray-200"},[b.MEDIUM]:{bg:"bg-blue-100",text:"text-blue-800",darkBg:"dark:bg-blue-600",darkText:"dark:text-blue-200"},[b.HIGH]:{bg:"bg-red-100",text:"text-red-800",darkBg:"dark:bg-red-600",darkText:"dark:text-red-200"}},he=()=>{const j=V(),[g,F]=c.useState(""),[i,N]=c.useState(!1),[p,n]=c.useState(null),[C,l]=c.useState(!1),{tasks:z,loading:x,error:h,updateTask:M,deleteTask:O,fetchTasks:B}=xe(),D=()=>{B(!0)},r=(t,o,u)=>{var v;const y=((v=S[t])==null?void 0:v.icon)||P;return e.jsx(y,{size:o,className:u})},s=async(t,o)=>{try{await M(t,o),N(!1),n(null),d.success("Aufgabe erfolgreich aktualisiert")}catch{}},a=async t=>{try{await O(t),l(!1),n(null),d.success("Aufgabe erfolgreich gelöscht")}catch{}},T=t=>{n(t),N(!0)},m=t=>{n(t),l(!0)},k=z.filter(t=>{var o,u,y;return(((o=t.title)==null?void 0:o.toLowerCase())||"").includes(g.toLowerCase())||(((u=t.description)==null?void 0:u.toLowerCase())||"").includes(g.toLowerCase())||(((y=t.id)==null?void 0:y.toLowerCase())||"").includes(g.toLowerCase())}),L={hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.05}}},I={hidden:{opacity:0,y:20},show:{opacity:1,y:0}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Aufgaben"}),e.jsx("p",{className:"mt-1 text-gray-600 dark:text-gray-400",children:"Verwalten Sie alle Aufgaben und weisen Sie sie Mitarbeitern zu."})]}),e.jsxs("div",{className:"mt-4 md:mt-0 flex items-center",children:[e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400 mr-3",children:[e.jsx(J,{className:"inline-block mr-1",size:16}),new Date().toLocaleDateString("de-DE",{weekday:"long",year:"numeric",month:"long",day:"numeric"})]}),e.jsxs(f,{variant:"outline",size:"sm",onClick:D,disabled:x,className:"mr-3",children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),"Aktualisieren"]}),e.jsx(f,{leftIcon:e.jsx(Z,{size:16}),size:"md",onClick:()=>j("/admin/task-templates/create"),children:"Neue Aufgabe"})]})]}),e.jsxs(Q,{children:[e.jsx(X,{children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsx(Y,{children:"Aufgabenliste"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(ee,{size:16,className:"text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"Suchen...",className:"pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md w-full sm:w-64 bg-white dark:bg-gray-700 text-gray-900 dark:text-white",value:g,onChange:t=>F(t.target.value)})]}),e.jsx(f,{variant:"outline",size:"md",leftIcon:e.jsx(ce,{size:16}),children:"Filter"})]})]})}),e.jsx(te,{children:x?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(se,{size:"lg"})}):h?e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200 p-6 rounded-lg flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(P,{className:"mr-2",size:20}),e.jsx("p",{children:"Ein Fehler ist aufgetreten beim Laden der Aufgaben."})]}),e.jsx("div",{className:"mt-2",children:e.jsxs(re,{onClick:D,className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center",disabled:x,children:[e.jsx(q,{className:"mr-2",size:16}),"Aufgaben neu laden"]})})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(_.table,{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",variants:L,initial:"hidden",animate:"show",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Aufgabe"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Beschreibung"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Priorität"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Fälligkeitsdatum"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Aktionen"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:k.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-6 py-8 text-center text-gray-500 dark:text-gray-400",children:g?e.jsxs("p",{children:['Keine Aufgaben gefunden, die "',g,'" entsprechen.']}):e.jsx("p",{children:"Keine Aufgaben vorhanden. Erstellen Sie Ihre erste Aufgabe!"})})}):k.map(t=>{var o,u,y,v,R,$,G,H;return e.jsxs(_.tr,{variants:I,children:[e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900 dark:text-white hover:text-accent dark:hover:text-accent-light cursor-pointer",onClick:()=>j(`/admin/tasks/${t.id}`),children:[t.title,e.jsx(U,{size:12,className:"inline ml-1"})]}),e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 truncate max-w-[150px]",children:t.id})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white",children:e.jsx("div",{className:"truncate max-w-[200px]",children:t.description||"-"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${((o=A[t.priority])==null?void 0:o.bg)||""} ${((u=A[t.priority])==null?void 0:u.text)||""} ${((y=A[t.priority])==null?void 0:y.darkBg)||""} ${((v=A[t.priority])==null?void 0:v.darkText)||""}`,children:ge[t.priority]||t.priority})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white",children:t.due_date?ae(new Date(t.due_date),"dd.MM.yyyy",{locale:ne}):"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${((R=S[t.status])==null?void 0:R.bg)||""} ${(($=S[t.status])==null?void 0:$.text)||""} ${((G=S[t.status])==null?void 0:G.darkBg)||""} ${((H=S[t.status])==null?void 0:H.darkText)||""}`,children:[r(t.status,12,"mr-1"),me[t.status]||t.status]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(f,{variant:"ghost",size:"sm",leftIcon:e.jsx(U,{size:16}),onClick:()=>j(`/admin/tasks/${t.id}`),children:"Details"}),e.jsx(f,{variant:"ghost",size:"sm",leftIcon:e.jsx(oe,{size:16}),onClick:()=>T(t),children:"Bearbeiten"}),e.jsx(f,{variant:"ghost",size:"sm",leftIcon:e.jsx(de,{size:16}),onClick:()=>m(t),children:"Löschen"})]})})]},t.id)})})]})})})]})]}),e.jsx(le,{isOpen:i,onClose:()=>N(!1),onSubmit:s,task:p,isLoading:x}),C&&p&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden w-full max-w-md mx-auto p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Aufgabe löschen"}),e.jsxs("p",{className:"text-gray-700 dark:text-gray-300 mb-6",children:['Sind Sie sicher, dass Sie die Aufgabe "',p.title,'" löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.']}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(f,{variant:"outline",onClick:()=>{l(!1),n(null)},children:"Abbrechen"}),e.jsx(f,{variant:"danger",onClick:()=>a(p.id),isLoading:x,children:"Löschen"})]})]})})]})},Te=W.memo(he);export{Te as default};
