import{G as Y,b as J,r as s,s as h,j as e,e as C,m as S,B as F,L as O,h as R,i as I,H as Q,f as X,w as Z,o as ee,F as te,D as A,z as ae,k as re}from"./index-C2zOcIr5.js";import{S as l}from"./ShimmerEffect-By9i5EVD.js";import{S as T}from"./square-pen-Df1rf3Dp.js";const se=k=>{try{const r=new Date(k);if(isNaN(r.getTime()))return"Ung체ltiges Datum";const n=r.getDate().toString().padStart(2,"0"),_=(r.getMonth()+1).toString().padStart(2,"0"),b=r.getFullYear();return`${n}.${_}.${b}`}catch{return"Ung체ltiges Datum"}},le=()=>{const k=Y(),{colors:r}=J(),[n,_]=s.useState(""),[b,j]=s.useState(!0),[M,U]=s.useState(null),[f,N]=s.useState([]),c=s.useRef(!1),m=s.useRef(!1),p=s.useRef(0),g=s.useRef(null),B=s.useMemo(()=>f.filter(a=>{var w,o;return n===""||a.template_title.toLowerCase().includes(n.toLowerCase())||a.employee_name.toLowerCase().includes(n.toLowerCase())||((w=a.demo_email)==null?void 0:w.toLowerCase().includes(n.toLowerCase()))||((o=a.ident_code)==null?void 0:o.toLowerCase().includes(n.toLowerCase()))}),[f,n]);s.useEffect(()=>{const a=async()=>{if(m.current){console.log("Data fetch already in progress for Bankdrops, skipping");return}const o=Date.now();if(o-p.current<5e3&&p.current>0){console.log(`In cooling period for Bankdrops, not fetching again. Last fetch: ${new Date(p.current).toLocaleTimeString()}`);return}if(c.current&&f.length>0){console.log("Bankdrops data already fetched, using cached data");return}console.log("Fetching Bankdrops data..."),j(!0),m.current=!0,p.current=o;try{const{data:i,error:$}=await h.from("task_templates").select("id, title, type").eq("type","bankdrop");if($)throw $;if(!i||i.length===0){console.log("No bankdrop templates found"),N([]),j(!1),m.current=!1,c.current=!0;return}const G=i.map(t=>t.id),{data:y,error:D}=await h.from("task_assignments").select(`
            id,
            task_id,
            task_template_id,
            assignee_id,
            status,
            created_at,
            updated_at,
            demo_email,
            demo_password,
            ident_code,
            task_template:task_templates(title, type)
          `).in("task_template_id",G).order("updated_at",{ascending:!1});if(D)throw D;if(!y||y.length===0){console.log("No bankdrop assignments found"),N([]),j(!1),m.current=!1,c.current=!0;return}const K=y.map(t=>t.assignee_id).filter(Boolean),{data:E,error:V}=await h.rpc("get_profiles_with_emails_by_ids",{profile_ids:K}),L={};E&&!V&&E.forEach(t=>{L[t.id]=t});const z=y.map(t=>t.task_id).filter(Boolean);let v={};if(z.length>0){const{data:t,error:d}=await h.from("task_attachments").select("task_id, id").in("task_id",z);!d&&t&&t.forEach(x=>{x.task_id&&(v[x.task_id]=(v[x.task_id]||0)+1)})}const W=y.map(t=>{const d=t.task_template,x=L[t.assignee_id];return{id:t.id,task_id:t.task_id,task_template_id:t.task_template_id,template_title:(d==null?void 0:d.title)||"Unbekannte Vorlage",template_type:(d==null?void 0:d.type)||"bankdrop",assignee_id:t.assignee_id,employee_name:x?`${x.first_name||""} ${x.last_name||""}`.trim():"Unbekannter Mitarbeiter",status:t.status,created_at:t.created_at,updated_at:t.updated_at,document_count:t.task_id&&v[t.task_id]||0,demo_email:t.demo_email,demo_password:t.demo_password,ident_code:t.ident_code}}).filter(t=>t.document_count>0);N(W),c.current=!0}catch(i){console.error("Error fetching bankdrop submissions:",i),U(i instanceof Error?i:new Error("Failed to fetch bankdrop submissions")),ae.error("Fehler beim Laden der Bankdrop-Daten")}finally{j(!1),m.current=!1}},w=()=>{g.current&&h.removeChannel(g.current);const o=h.channel("bankdrops-changes");o.on("postgres_changes",{event:"*",schema:"public",table:"task_assignments"},u=>{console.log("Task assignment change detected:",u),m.current||(Date.now()-p.current>5e3?(console.log("Changes detected, refreshing data"),c.current=!1,a()):console.log("Changes detected but in cooling period"))}).on("postgres_changes",{event:"*",schema:"public",table:"task_attachments"},u=>{console.log("Task attachment change detected:",u),m.current||(Date.now()-p.current>5e3?(console.log("Changes detected, refreshing data"),c.current=!1,a()):console.log("Changes detected but in cooling period"))}).subscribe(u=>{console.log(`Bankdrops subscription status: ${u}`)}),g.current=o};return a(),w(),()=>{g.current&&(console.log("Cleaning up Bankdrops subscriptions"),h.removeChannel(g.current),g.current=null)}},[]);const P={hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.05}}},q={hidden:{opacity:0,y:20},show:{opacity:1,y:0}},H=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center",children:[e.jsxs("div",{children:[e.jsx(l,{width:"250px",height:"32px",className:"mb-2"}),e.jsx(l,{width:"350px",height:"20px"})]}),e.jsx(l,{width:"150px",height:"40px",className:"mt-4 md:mt-0"})]}),e.jsxs(R,{children:[e.jsxs(re,{className:"flex flex-col md:flex-row justify-between items-start md:items-center",children:[e.jsx(l,{width:"200px",height:"24px"}),e.jsx("div",{className:"flex flex-col md:flex-row gap-2 w-full md:w-auto mt-4 md:mt-0",children:e.jsx(l,{width:"200px",height:"40px"})})]}),e.jsx(I,{children:e.jsx("div",{className:"space-y-4",children:[1,2,3].map(a=>e.jsx("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-4",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{children:[e.jsx(l,{width:"200px",height:"24px",className:"mb-2"}),e.jsx(l,{width:"300px",height:"16px"})]}),e.jsx(l,{width:"100px",height:"32px"})]})},a))})})]})]});return b&&f.length===0?H():M?e.jsx("div",{className:"flex flex-col items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"Fehler beim Laden der Bankdrops"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-300 mb-4",children:"Es gab ein Problem beim Laden der Bankdrop-Informationen. Bitte versuchen Sie es erneut."}),e.jsx(C,{onClick:()=>{c.current=!1,window.location.reload()},children:"Erneut versuchen"})]})}):e.jsxs("div",{className:"w-full px-4 py-6",children:[e.jsx(S.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.5},className:"bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 rounded-xl p-6 shadow-sm border border-gray-100 dark:border-gray-700 mb-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`p-2 rounded-md bg-[${r.primary}]/10 dark:bg-gray-700 mr-4`,children:e.jsx(F,{size:24,className:`text-[${r.primary}] dark:text-white`})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-app font-app-bold text-gray-900 dark:text-white flex items-center",children:["Bankdrops",b&&f.length===0&&e.jsx("span",{className:"ml-3 inline-block",children:e.jsx(O,{size:"sm"})})]}),e.jsx("p",{className:"mt-1 text-gray-600 dark:text-gray-400 font-app",children:"Alle Bankdrop-Auftr채ge mit hochgeladenen Dokumenten"})]})]}),e.jsx("div",{className:"mt-4 md:mt-0",children:e.jsx(C,{onClick:()=>k("/admin/task-templates/create"),leftIcon:e.jsx(T,{size:16}),style:{backgroundColor:r.primary,color:"white"},className:"hover:opacity-90 transition-opacity",children:"Neuer Bankdrop"})})]})}),e.jsx(R,{className:"border-0 shadow-sm overflow-hidden dark:bg-gray-800",children:e.jsxs(I,{className:"pt-6",children:[e.jsxs("div",{className:"relative flex-1 w-full mb-6",children:[e.jsx(Q,{className:`absolute left-3 top-1/2 transform -translate-y-1/2 text-[${r.primary}]/60 dark:text-gray-300`,size:18}),e.jsx("input",{type:"text",placeholder:"Nach Titel, Mitarbeiter oder Code suchen...",className:`pl-10 pr-4 py-2 border border-gray-200 dark:border-gray-700 rounded-md w-full bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-[${r.primary}]/30 focus:border-[${r.primary}] transition-colors`,value:n,onChange:a=>_(a.target.value)})]}),B.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-4",children:e.jsx(F,{className:"text-gray-500 dark:text-gray-300",size:24})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"Keine Bankdrops gefunden"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-300 max-w-md mx-auto",children:"Es wurden keine Bankdrop-Auftr채ge mit hochgeladenen Dokumenten gefunden"})]}):e.jsx(S.div,{className:"space-y-4",variants:P,initial:"hidden",animate:"show",children:B.map(a=>e.jsx(S.div,{variants:q,className:"border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors shadow-sm",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-2",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:a.template_title}),e.jsxs("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium bg-[${r.primary}]/10 text-[${r.primary}] dark:bg-gray-700 dark:text-white flex items-center`,children:[e.jsx(X,{size:12,className:"mr-1"}),a.template_type]}),e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium ${a.status==="completed"?"bg-green-100 text-green-800 dark:bg-green-700/30 dark:text-white":`bg-[${r.accent}]/10 text-[${r.accent}] dark:bg-gray-700 dark:text-white`}`,children:a.status==="completed"?"Abgeschlossen":"Ausstehend"})]}),e.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-600 dark:text-gray-300 mb-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Z,{size:14,className:"mr-1.5 text-gray-500 dark:text-gray-300"}),a.employee_name]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(ee,{size:14,className:"mr-1.5 text-gray-500 dark:text-gray-300"}),se(a.updated_at)]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(te,{size:14,className:"mr-1.5 text-gray-500 dark:text-gray-300"}),a.document_count," Dokumente"]}),a.demo_email&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(A,{size:14,className:"mr-1.5 text-gray-500 dark:text-gray-300"}),a.demo_email]}),a.ident_code&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(A,{size:14,className:"mr-1.5 text-gray-500 dark:text-gray-300"}),"Code: ",a.ident_code]})]})]}),e.jsx("div",{className:"flex items-center space-x-2 mt-4 md:mt-0",children:e.jsx(C,{onClick:()=>k(`/admin/bankdrops/${a.task_template_id}?assignment=${a.id}`),variant:"outline",size:"sm",className:`border-[${r.primary}] dark:border-gray-600 text-[${r.primary}] dark:text-white hover:bg-[${r.primary}]/10 dark:hover:bg-gray-600`,leftIcon:e.jsx(T,{size:16}),children:"Details anzeigen"})})]})},a.id))})]})})]})};export{le as default};
