import{P as K,t as W,r as n,u as H,G as Q,j as e,L as U,e as x,aw as X,h as J,k as Y,l as ee,i as te,I as b,a5 as re,af as se,s as E}from"./index-C2zOcIr5.js";import{e as _}from"./contractUtils-B5S0O9Tf.js";import{u as ae}from"./useToast-BsUGRjrm.js";import{R as ne}from"./quill.snow-B5tST0Aw.js";const me=()=>{var C,S,T,z;const{id:d}=K(),F=W(),{register:m,handleSubmit:A,formState:{errors:o},setValue:i}=F,[l,u]=n.useState({}),[v,V]=n.useState(!1),[I,k]=n.useState(!0),[y,w]=n.useState(""),[f,R]=n.useState(null),[j,q]=n.useState(!1),N=n.useRef(!0),h=n.useRef(null),{user:ie}=H(),c=Q(),{showToast:g}=ae(),B=async t=>{try{k(!0);const{data:r,error:s}=await E.from("contracts").select("*").eq("id",t).single();if(s)throw s;return r}catch(r){throw console.error("Error fetching contract:",r),r}finally{k(!1)}},D=async(t,r)=>{try{V(!0);const{data:s,error:a}=await E.from("contracts").update(r).eq("id",t).select().single();if(a)throw a;return s}catch(s){throw console.error("Error updating contract:",s),s}finally{V(!1)}};n.useEffect(()=>{const t=async()=>{if(d)try{const r=await B(d);if(!r){g({title:"Fehler",message:"Vertragsvorlage nicht gefunden.",type:"error"}),c("/admin/contracts");return}if(R(r),i("title",r.title),i("category",r.category),i("content",r.content),i("version",r.version),i("version_number",r.version_number||1),w(r.content||""),r.template_data&&r.template_data.salary){const a=r.template_data.salary.match(/(\d+)/);a&&a[1]&&i("monthly_salary",parseInt(a[1],10))}L(r)}catch(r){console.error("Error loading contract:",r),g({title:"Fehler",message:"Die Vertragsvorlage konnte nicht geladen werden.",type:"error"}),c("/admin/contracts")}};N.current&&(t(),N.current=!1)},[d,c,g,i]);const L=t=>{if(!t||!t.content)return;const r={},s=_(t.content);t.template_data&&Object.entries(t.template_data).forEach(([a,p])=>{r[a]=String(p)}),s.forEach(a=>{r[a]||(r[a]="")}),u(r)},M=t=>{t!==y&&(w(t),h.current&&clearTimeout(h.current),h.current=setTimeout(()=>{i("content",t),P(t)},500))},P=t=>{if(!t)return;const r=_(t),s={...l};let a=!1;r.forEach(p=>{s[p]||(s[p]="",a=!0)}),a&&u(s)};n.useEffect(()=>()=>{h.current&&clearTimeout(h.current)},[]);const O=async t=>{if(!(!f||!d))try{const r={...l},s=t.monthly_salary||0;s>0&&(r.salary=`${s} €`);const a={title:t.title,category:t.category,content:y,version:t.version,template_data:r};j&&(a.version_number=(f.version_number||1)+1),await D(d,a),g({title:"Erfolg",message:"Vertragsvorlage wurde erfolgreich aktualisiert.",type:"success"}),c("/admin/contracts")}catch{g({title:"Fehler",message:"Die Vertragsvorlage konnte nicht aktualisiert werden.",type:"error"})}},Z=()=>{const t=`custom${Object.keys(l).length+1}`;u({...l,[t]:""})},$=(t,r)=>{u({...l,[t]:r})},G=t=>{const r={...l};delete r[t],u(r)};return I?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(U,{size:"lg"})}):f?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Vertragsvorlage bearbeiten"}),e.jsxs(x,{onClick:()=>c("/admin/contracts"),variant:"outline",className:"flex items-center gap-2",children:[e.jsx(X,{size:16}),"Zurück"]})]}),e.jsxs(J,{children:[e.jsx(Y,{children:e.jsx(ee,{children:"Vorlagendetails"})}),e.jsx(te,{children:e.jsxs("form",{onSubmit:A(O),className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-md mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"majorVersion",checked:j,onChange:t=>q(t.target.checked),className:"h-4 w-4 text-accent focus:ring-accent border-gray-300 rounded"}),e.jsxs("label",{htmlFor:"majorVersion",className:"ml-2 block text-sm text-blue-800 dark:text-blue-200",children:["Als neue Version speichern (Version ",(f.version_number||1)+1,")"]})]}),e.jsx("p",{className:"text-xs text-blue-600 dark:text-blue-300 mt-1",children:"Wenn aktiviert, wird eine neue Version der Vorlage erstellt, anstatt die bestehende zu überschreiben."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("div",{children:e.jsx(b,{label:"Titel",...m("title",{required:"Titel ist erforderlich"}),error:(C=o.title)==null?void 0:C.message,placeholder:"Vertragsvorlage Titel"})}),e.jsx("div",{children:e.jsx(b,{label:"Kategorie",...m("category",{required:"Kategorie ist erforderlich"}),error:(S=o.category)==null?void 0:S.message,placeholder:"z.B. Arbeitsvertrag, Dienstleistungsvertrag, etc."})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("div",{children:e.jsx(b,{label:"Version",...m("version",{required:"Version ist erforderlich"}),error:(T=o.version)==null?void 0:T.message,placeholder:"z.B. 1.0, 2023-01, etc."})}),e.jsx("div",{children:e.jsx(b,{label:"Monatliches Gehalt (€)",type:"number",...m("monthly_salary",{valueAsNumber:!0,validate:t=>!t||t>=0||"Gehalt muss eine positive Zahl sein"}),error:(z=o.monthly_salary)==null?void 0:z.message,placeholder:"z.B. 2500"})})]}),e.jsx("div",{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Vertragstext"}),e.jsx("input",{type:"hidden",...m("content",{required:"Vertragstext ist erforderlich"})}),e.jsx(ne,{theme:"snow",value:y,onChange:M,modules:{toolbar:[[{header:[1,2,3,4,5,6,!1]}],["bold","italic","underline","strike"],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],[{align:[]}],["link","image","video"],["clean"]]},formats:["header","bold","italic","underline","strike","list","bullet","indent","link","image","video","align"],className:"bg-white dark:bg-gray-700 text-gray-900 dark:text-white",style:{height:"300px",marginBottom:"40px"}}),o.content&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.content.message}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:["Verwenden Sie Platzhalter im Format ","{{"," variableName ","}}",". Diese werden automatisch erkannt und unten angezeigt."]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Erkannte Variablen"}),e.jsxs(x,{type:"button",variant:"outline",size:"sm",onClick:Z,className:"flex items-center gap-2",children:[e.jsx(re,{size:14}),"Variable hinzufügen"]})]}),e.jsx("div",{className:"space-y-4 bg-gray-50 dark:bg-gray-800 p-4 rounded-md",children:Object.keys(l).length===0?e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Keine Variablen im Vertragstext gefunden. Fügen Sie Platzhalter wie ","{{"," name ","}}","  im Text ein."]}):Object.entries(l).map(([t,r])=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(b,{label:`Variable {{${t}}}`,value:r,onChange:s=>$(t,s.target.value),placeholder:`Standardwert für ${t}`})}),e.jsx("button",{type:"button",className:"mt-6 p-2 text-red-500 hover:text-red-700 focus:outline-none",onClick:()=>G(t),children:e.jsx(se,{size:16})})]},t))}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:"Diese Werte werden als Standardwerte für die Variablen verwendet. Sie können beim Zuweisen des Vertrags überschrieben werden."})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(x,{onClick:()=>c("/admin/contracts"),type:"button",variant:"outline",children:"Abbrechen"}),e.jsx(x,{type:"submit",variant:"primary",isLoading:v,disabled:v,children:j?"Als neue Version speichern":"Änderungen speichern"})]})]})})]})]}):e.jsxs("div",{className:"text-center p-10",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Vertragsvorlage nicht gefunden"}),e.jsx("p",{className:"mb-4",children:"Die angeforderte Vertragsvorlage konnte nicht gefunden werden."}),e.jsx(x,{onClick:()=>c("/admin/contracts"),children:"Zurück zur Übersicht"})]})};export{me as default};
