import{G as fe,b as je,r as a,a3 as ke,U as ve,s as Ne,j as e,m as N,a4 as Z,L as A,A as w,a5 as q,h as Q,k as ee,i as te,e as h,a6 as we,a7 as Se,a8 as Ce,a9 as Te,aa as ze,ab as Ee,ac as Fe,ad as Le,ae as Me,I as D,af as Ae,ag as De,z as y}from"./index-C2zOcIr5.js";import{S as n}from"./ShimmerEffect-By9i5EVD.js";import{u as _e}from"./useTaskTemplates-DrpK2931.js";import{u as $e}from"./useEmployees-BfxrKmlR.js";import"./connectionManager-WW8tX6Ox.js";const Ie=d=>{try{const l=new Date(d);if(isNaN(l.getTime()))return"Ungültiges Datum";const C=l.getDate().toString().padStart(2,"0"),m=(l.getMonth()+1).toString().padStart(2,"0"),_=l.getFullYear();return`${C}.${m}.${_}`}catch{return"Ungültiges Datum"}},u={LOW:"low",MEDIUM:"medium",HIGH:"high"},Pe={[u.LOW]:"Niedrig",[u.MEDIUM]:"Mittel",[u.HIGH]:"Hoch"},S={[u.LOW]:{bg:"bg-gray-100",text:"text-gray-800",darkBg:"dark:bg-gray-600",darkText:"dark:text-gray-200"},[u.MEDIUM]:{bg:"bg-blue-100",text:"text-blue-800",darkBg:"dark:bg-blue-600",darkText:"dark:text-blue-200"},[u.HIGH]:{bg:"bg-red-100",text:"text-red-800",darkBg:"dark:bg-red-600",darkText:"dark:text-red-200"}},Ke=()=>{var X,Y;const d=fe(),{colors:l,shouldShowPaymentManagement:C}=je(),[m,_]=a.useState(""),[T,Be]=a.useState(""),[z,$]=a.useState(!0),[se,I]=a.useState(null),[P,f]=a.useState(null),[r,B]=a.useState(null),[i,E]=a.useState([]),[H,F]=a.useState(""),[L,U]=a.useState(""),[M,V]=a.useState(!1),[c,O]=a.useState(""),{templates:o,fetchTemplates:ae,deleteTemplate:re,createTaskFromTemplate:ie}=_e(),{employees:x,loading:j,error:k,refreshEmployees:b}=$e(),R=async()=>{try{$(!0),I(null),await ae()}catch(t){console.error("Failed to fetch task templates:",t),I(t instanceof Error?t:new Error("Failed to fetch task templates")),y.error("Failed to fetch task templates")}finally{$(!1)}},ne=async t=>{try{return await re(t),!0}catch(s){throw console.error("Failed to delete task template:",s),y.error("Failed to delete task template"),s}},le=()=>{R()},{isNewNavigation:K,lastRefreshTimestamp:de}=ke(),g=ve.useRef(null);a.useRef(null),a.useEffect(()=>{const t=s=>{s.target instanceof Element&&(s.target.closest('button[data-action="edit"]')||s.target.closest('button[data-action="duplicate"]')||s.target.closest('button[data-action="delete"]'))||f(null)};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[]),a.useEffect(()=>(K("/admin/task-templates")&&(console.log("Navigation to TaskTemplates detected, fetching data..."),R()),g.current||(console.log("Creating new subscription for task templates"),g.current=Ne.channel("task_templates_changes"),g.current.on("postgres_changes",{event:"*",schema:"public",table:"task_templates"},t=>{console.log("Task template change detected:",t.eventType)}).subscribe()),()=>{g.current&&(console.log("Unsubscribing from task templates channel"),g.current.unsubscribe(),g.current=null)}),[K,de]);const G=a.useMemo(()=>o.filter(t=>{const s=t.title.toLowerCase().includes(m.toLowerCase())||t.description.toLowerCase().includes(m.toLowerCase())||t.type.toLowerCase().includes(m.toLowerCase()),p=!T||t.type===T;return s&&p}),[o,m,T]);[...new Set(o.map(t=>t.type))].sort();const ce=async t=>{if(window.confirm("Sind Sie sicher, dass Sie diese Aufgabenvorlage löschen möchten?"))try{await ne(t),y.success("Aufgabenvorlage erfolgreich gelöscht")}catch{}},oe=(t,s)=>{s&&(s.stopPropagation(),s.preventDefault()),f(null),d("/admin/task-templates/create",{state:{duplicateFrom:t}})},me=(t,s)=>{s&&(s.stopPropagation(),s.preventDefault()),f(null),console.log(`Editing template, navigating to: /admin/task-templates/${t}/edit`),d(`/admin/task-templates/${t}/edit`)},xe=(t,s)=>{s.stopPropagation(),f(P===t?null:t)},ge=t=>{B(t),E([]),F(""),O(""),sessionStorage.removeItem("employeesList"),b()},W=()=>{B(null),E([]),F(""),U("")},J=t=>{E(s=>s.includes(t)?s.filter(p=>p!==t):[...s,t])},he=async()=>{if(r){if(i.length===0){y.error("Bitte wählen Sie mindestens einen Mitarbeiter aus");return}try{V(!0);const t=L?parseFloat(L):void 0,s=await Promise.all(i.map(p=>ie(r.id,p,H||void 0,t)));y.success(`Aufgabe erfolgreich an ${i.length} Mitarbeiter zugewiesen`),W()}catch{}finally{V(!1)}}},v=a.useMemo(()=>x.filter(t=>{var s;return t.role==="employee"&&(!t.banned_until||new Date(t.banned_until)<=new Date)&&(c===""||`${t.first_name} ${t.last_name}`.toLowerCase().includes(c.toLowerCase())||((s=t.email)==null?void 0:s.toLowerCase().includes(c.toLowerCase())))}),[x,c,j]);a.useMemo(()=>o.filter(t=>t.is_starter_job).length,[o]);const ue={hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.05}}},be={hidden:{opacity:0,y:20},show:{opacity:1,y:0}},pe=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center",children:[e.jsxs("div",{children:[e.jsx(n,{width:"250px",height:"32px",className:"mb-2"}),e.jsx(n,{width:"350px",height:"20px"})]}),e.jsx(n,{width:"150px",height:"40px",className:"mt-4 md:mt-0"})]}),e.jsxs(Q,{children:[e.jsxs(ee,{className:"flex flex-col md:flex-row justify-between items-start md:items-center",children:[e.jsx(n,{width:"200px",height:"24px"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-2 w-full md:w-auto mt-4 md:mt-0",children:[e.jsx(n,{width:"200px",height:"40px"}),e.jsx(n,{width:"150px",height:"40px"})]})]}),e.jsx(te,{children:e.jsx("div",{className:"space-y-4",children:[1,2,3,4].map(t=>e.jsx("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-4",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{children:[e.jsx(n,{width:"200px",height:"24px",className:"mb-2"}),e.jsx(n,{width:"300px",height:"16px"})]}),e.jsx(n,{width:"100px",height:"32px"})]})},t))})})]})]}),ye=()=>e.jsx("div",{className:"flex flex-col items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"Fehler beim Laden der Aufgabenvorlagen"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-4",children:"Es gab ein Problem beim Laden der Aufgabenvorlagen. Bitte versuchen Sie es erneut."}),e.jsx(h,{onClick:le,children:"Erneut versuchen"})]})});return a.useEffect(()=>{r&&x.length===0&&!j&&!k&&b()},[x,j,k,r,b]),z?pe():se?ye():e.jsxs("div",{className:"w-full px-4 py-6",children:[e.jsx(N.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.5},className:"bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 rounded-xl p-6 shadow-sm border border-gray-100 dark:border-gray-700 mb-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`p-2 rounded-md bg-${l.primary}/10 dark:bg-gray-700 mr-4`,children:e.jsx(Z,{size:24,className:`text-${l.primary} dark:text-white`})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-app font-app-bold text-gray-900 dark:text-white flex items-center",children:["Aufgabenvorlagen",z&&e.jsx("span",{className:"ml-3 inline-block",children:e.jsx(A,{size:"sm"})})]}),e.jsx("p",{className:"mt-1 text-gray-600 dark:text-gray-400 font-app",children:"Erstellen und verwalten Sie Vorlagen für wiederkehrende Aufgabentypen"})]})]}),e.jsx("div",{className:"mt-4 md:mt-0",children:e.jsx(w,{variant:"primary",icon:e.jsx(q,{size:16}),onClick:()=>d("/admin/task-templates/create"),className:"bg-blue-500 hover:bg-blue-600 text-white dark:bg-blue-600 dark:hover:bg-blue-700",children:"Neue Vorlage"})})]})}),e.jsxs(Q,{className:"border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden rounded-lg",children:[e.jsx(ee,{className:"bg-white dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700",children:e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("div",{className:"flex items-center",children:z&&e.jsx(A,{size:"sm"})})})}),e.jsx(te,{className:"bg-white dark:bg-gray-800 p-6",children:G.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-4",children:e.jsx(Z,{size:24,className:"text-gray-400 dark:text-gray-500"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"Keine Aufgabenvorlagen gefunden"}),o.length>0&&e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 max-w-md mx-auto",children:"Versuchen Sie, Ihre Suchkriterien anzupassen oder entfernen Sie Filter, um mehr Ergebnisse zu sehen."}),o.length===0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 max-w-md mx-auto mb-6",children:"Erstellen Sie Ihre erste Aufgabenvorlage, um wiederkehrende Aufgaben effizienter zu verwalten."}),e.jsx(h,{leftIcon:e.jsx(q,{size:16}),className:"bg-blue-500 hover:bg-blue-600 text-white dark:bg-blue-600 dark:hover:bg-blue-700",onClick:()=>d("/admin/task-templates/create"),children:"Erste Vorlage erstellen"})]})]}):e.jsx(N.div,{className:"space-y-4",variants:ue,initial:"hidden",animate:"show",children:G.map(t=>e.jsx(N.div,{variants:be,className:`bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-md border border-gray-200 dark:border-gray-700 transition-all duration-200 ${(r==null?void 0:r.id)===t.id?"ring-2 ring-blue-500":""}`,children:e.jsx("div",{className:"p-5",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:t.title}),t.is_starter_job&&e.jsx("div",{className:"text-yellow-500",title:"Starter-Job für neue Mitarbeiter",children:e.jsx(we,{size:16,fill:"currentColor"})}),e.jsx("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${S[t.priority].bg} ${S[t.priority].text} ${S[t.priority].darkBg} ${S[t.priority].darkText}`,children:Pe[t.priority]}),e.jsx("span",{className:"px-2.5 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200",children:t.type})]}),e.jsx("p",{className:"mt-2 text-sm text-gray-600 dark:text-gray-300 line-clamp-2",children:t.description}),e.jsxs("div",{className:"mt-3 flex items-center text-xs text-gray-500 dark:text-gray-400",children:[t.estimated_hours&&e.jsxs("span",{className:"flex items-center",children:[e.jsx(Se,{size:14,className:"mr-1"}),t.estimated_hours," Stunden"]}),e.jsxs("span",{className:"ml-4 flex items-center",children:[e.jsx("span",{className:"text-gray-400 dark:text-gray-500 mr-1",children:"Aktualisiert:"}),Ie(t.updated_at)]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-4 md:mt-0",children:[e.jsx(w,{variant:"ghost",size:"sm",icon:e.jsx(Ce,{size:16}),onClick:s=>d(`/admin/task-templates/${t.id}`),className:"text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Ansehen"}),e.jsx(w,{variant:"ghost",size:"sm",icon:e.jsx(Te,{size:16}),onClick:s=>ge(t),className:"text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30",children:"Zuweisen"}),e.jsxs("div",{className:"relative",children:[e.jsx(w,{variant:"ghost",size:"sm",icon:e.jsx(ze,{size:16}),onClick:s=>xe(t.id,s),className:"text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none"}),P===t.id&&e.jsx("div",{className:"absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white dark:bg-gray-800 shadow-lg ring-1 ring-gray-200 dark:ring-gray-700 focus:outline-none overflow-hidden",onClick:s=>s.stopPropagation(),children:e.jsxs("div",{className:"py-1",children:[e.jsxs("button",{"data-action":"edit",className:"flex w-full items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-700",onClick:s=>me(t.id,s),children:[e.jsx(Ee,{size:16,className:"mr-2 text-blue-500 dark:text-blue-400"}),"Bearbeiten"]}),e.jsxs("button",{"data-action":"duplicate",className:"flex w-full items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-100 dark:border-gray-700",onClick:s=>oe(t,s),children:[e.jsx(Fe,{size:16,className:"mr-2 text-purple-500 dark:text-purple-400"}),"Duplizieren"]}),e.jsxs("button",{"data-action":"delete",className:"flex w-full items-center px-4 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30",onClick:s=>{s.stopPropagation(),s.preventDefault(),console.log(`Deleting template: ${t.id}`),ce(t.id)},children:[e.jsx(Le,{size:16,className:"mr-2"}),"Löschen"]})]})})]})]})]})})},t.id))})})]}),r&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs(N.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full",children:[e.jsx("div",{className:"p-6 border-b border-gray-200 dark:border-gray-700",children:e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Aufgabe zuweisen"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:["Mitarbeiter auswählen ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"mb-4 relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none",children:e.jsx(Me,{size:16,className:"text-gray-500"})}),e.jsx(D,{type:"text",placeholder:"Mitarbeiter suchen...",value:c,onChange:t=>O(t.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"mt-2 mb-4",children:[e.jsxs("p",{className:"text-sm text-gray-700 dark:text-gray-300 mb-1",children:["Ausgewählte Mitarbeiter: ",i.length]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:i.length>0&&x.filter(t=>i.includes(t.id)).map(t=>e.jsxs("div",{className:"flex items-center bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-2 py-1 rounded-full text-sm",children:[t.first_name," ",t.last_name,e.jsx("button",{onClick:()=>J(t.id),className:"ml-1 text-blue-800 dark:text-blue-200 focus:outline-none",children:e.jsx(Ae,{size:14})})]},t.id))})]}),j?e.jsxs("div",{className:"py-4 text-center",children:[e.jsx(A,{size:"sm"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-2",children:"Lade Mitarbeiter..."})]}):k?e.jsxs("div",{className:"py-4 text-center text-red-600 dark:text-red-400",children:[e.jsx("p",{className:"text-sm",children:"Fehler beim Laden der Mitarbeiter:"}),e.jsx("p",{className:"text-xs mt-1",children:k.message}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>b(),className:"mt-2",children:"Erneut versuchen"})]}):e.jsx("div",{className:"max-h-60 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-md",children:v.length>0?v.map(t=>e.jsxs("div",{className:`
                            flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700
                            ${i.includes(t.id)?"bg-blue-50 dark:bg-blue-900/20":""}
                            ${v.indexOf(t)!==v.length-1?"border-b border-gray-200 dark:border-gray-700":""}
                          `,onClick:()=>J(t.id),children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:[t.first_name," ",t.last_name]}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:t.email})]}),i.includes(t.id)&&e.jsx(De,{size:18,className:"text-blue-600 dark:text-blue-400"})]},t.id)):x.length===0?e.jsxs("div",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:[e.jsx("p",{className:"text-sm",children:"Keine Mitarbeiter im System gefunden"}),e.jsx("p",{className:"text-xs mt-1",children:"Erstellen Sie zuerst Mitarbeiter-Konten"}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>b(),className:"mt-2",children:"Neu laden"})]}):c?e.jsxs("div",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:[e.jsxs("p",{className:"text-sm",children:['Keine Mitarbeiter für "',c,'" gefunden']}),e.jsx("p",{className:"text-xs mt-1",children:"Versuchen Sie einen anderen Suchbegriff"})]}):e.jsxs("div",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:[e.jsx("p",{className:"text-sm",children:"Keine verfügbaren Mitarbeiter"}),e.jsx("p",{className:"text-xs mt-1",children:"Alle Mitarbeiter sind gesperrt oder haben Admin-Rollen"})]})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Fälligkeitsdatum (optional)"}),e.jsx(D,{type:"date",value:H,onChange:t=>F(t.target.value),min:new Date().toISOString().split("T")[0]})]}),C()&&r&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Individuelle Vergütung (optional)"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none",children:e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"€"})}),e.jsx(D,{type:"number",value:L,onChange:t=>U(t.target.value),placeholder:((X=r.payment_amount)==null?void 0:X.toFixed(2))||"0.00",step:"0.01",min:"0",className:"pl-8"})]}),e.jsxs("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:["Standard: €",((Y=r.payment_amount)==null?void 0:Y.toFixed(2))||"0.00"," • Leer lassen für Standard-Vergütung"]})]})]}),e.jsxs("div",{className:"p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-2",children:[e.jsx(h,{variant:"outline",onClick:W,disabled:M,children:"Abbrechen"}),e.jsx(h,{onClick:he,disabled:M||i.length===0,children:M?"Wird zugewiesen...":"Aufgabe zuweisen"})]})]})})]})};export{Ke as default};
