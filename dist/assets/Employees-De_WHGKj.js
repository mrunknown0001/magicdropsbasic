import{r as x,s as U,z as D,a as $,t as ke,j as e,v as P,m as S,X as G,I as Z,e as z,u as se,b as J,F as ne,C as K,f as je,A as T,w as ve,x as V,y as E,T as Ne,c as X,U as _e,G as Ee,h as Se,i as Ce,H as Me,L as re,E as ae,J as Ae}from"./index-C2zOcIr5.js";import{u as ze}from"./useEmployees-BfxrKmlR.js";import{E as $e}from"./EditEmployeeModal-BCGk3b_X.js";import{u as Ie}from"./usePaymentManagement-Bi8mdWpA.js";import{R as q}from"./refresh-cw-BQFYSu-c.js";import{U as Te}from"./user-plus-rakINPbx.js";import{F as Le}from"./funnel-By8gi63k.js";import{E as De}from"./external-link-Bq5Q6tnA.js";import{S as Ue}from"./square-pen-Df1rf3Dp.js";import"./connectionManager-WW8tX6Ox.js";const Fe=()=>{const[l,n]=x.useState(()=>{try{const s=sessionStorage.getItem("employeesList");if(s){const t=JSON.parse(s);if(t.lastFetchTime&&Date.now()-t.lastFetchTime<3e5)return t.employees||[]}}catch(s){console.error("Error retrieving stored employees:",s)}return[]}),[u,c]=x.useState(!1),[o,h]=x.useState(null),[p,C]=x.useState(()=>{try{const s=sessionStorage.getItem("employeesList");if(s)return JSON.parse(s).lastFetchTime||0}catch(s){console.error("Error retrieving last fetch time:",s)}return 0}),k=x.useRef(!1),j=x.useCallback(async(s=!1)=>{if(k.current){console.log("Data fetch already in progress, skipping");return}const t=Date.now();if(!s&&p&&t-p<5e3){console.log(`In cooling period, not fetching again. Last fetch: ${new Date(p).toLocaleTimeString()}`);return}p&&t-p<5*60*1e3||c(!0),k.current=!0,h(null);const m=l.filter(d=>d._manuallyUpdated);try{console.log("Fetching employees data...");const{data:d,error:g}=await U.rpc("get_profiles_with_emails");if(g)throw g;if(!d)throw new Error("No data returned from profiles query");let w=d.map(_=>({..._,name:`${_.first_name||""} ${_.last_name||""}`.trim()}));if(m.length>0){const _=m;_.length>0&&(console.log(`Preserving ${_.length} manually updated employees`),w=w.map(I=>{const f=_.find(F=>F.id===I.id);return f?(console.log(`Preserving manual status for ${f.name}, banned until: ${f.banned_until||"not banned"}`),{...I,banned_until:f.banned_until,_manuallyUpdated:!0,_lastUpdateTime:f._lastUpdateTime}):I}))}n(w);const N=Date.now();C(N);try{sessionStorage.setItem("employeesList",JSON.stringify({employees:w,lastFetchTime:N}))}catch(_){console.error("Error storing employees in session storage:",_)}return w}catch(d){console.error("Error fetching employees:",d),h(d instanceof Error?d:new Error("Failed to fetch employees")),D.error("Failed to fetch employees")}finally{c(!1),k.current=!1}},[l,p]),b=async s=>{try{c(!0);const{data:t,error:a}=await $.auth.admin.createUser({email:s.email,password:s.password,email_confirm:!0,user_metadata:{first_name:s.first_name,last_name:s.last_name,position:s.position||"",role:"employee"}});if(a)throw a;if(t.user){await new Promise(d=>setTimeout(d,1e3));const{data:i,error:m}=await U.from("profiles").select("*").eq("id",t.user.id).single();if(m&&m.code!=="PGRST116")throw m;if(!i){const{error:d}=await U.from("profiles").insert([{id:t.user.id,first_name:s.first_name,last_name:s.last_name,role:"employee"}]);if(d)throw d}}return await j(!0),D.success("Mitarbeiter erfolgreich erstellt"),t.user}catch(t){throw console.error("Error creating employee:",t),D.error(t instanceof Error?t.message:"Fehler beim Erstellen des Mitarbeiters"),t}finally{c(!1)}},v=async(s,t)=>{try{c(!0);const a=t==="Inaktiv"?new Date(Date.now()+10*365*24*60*60*1e3).toISOString():null;n(i=>i.map(m=>m.id===s?(console.log(`Updating local employee ${m.name} status to ${t}, banned_until: ${a}`),{...m,banned_until:a,_manuallyUpdated:!0,_lastUpdateTime:Date.now()}):m));try{const i=sessionStorage.getItem("employeesList");if(i){const m=JSON.parse(i);m.employees&&(m.employees=m.employees.map(d=>d.id===s?{...d,banned_until:a,_manuallyUpdated:!0,_lastUpdateTime:Date.now()}:d),sessionStorage.setItem("employeesList",JSON.stringify(m)))}}catch(i){console.error("Error updating session storage:",i)}if(t==="Inaktiv"){const{error:i}=await $.auth.admin.updateUserById(s,{ban_duration:"87600h"});if(i)throw i;console.log(`Employee ${s} deactivated in auth system (from useEmployeesStats)`)}else{const{error:i}=await $.auth.admin.updateUserById(s,{ban_duration:"0h"});if(i)throw i;console.log(`Employee ${s} activated in auth system (from useEmployeesStats)`)}try{const{error:i}=await U.from("profiles").update({banned_until:a,updated_at:new Date().toISOString(),status_manually_set:!0}).eq("id",s);i?console.error("Error updating profile banned_until:",i):console.log(`Successfully updated profile banned_until for ${s}`)}catch(i){console.error("Failed to update profile banned_until:",i)}D.success(`Mitarbeiter ${t==="Aktiv"?"aktiviert":"deaktiviert"}`)}catch(a){throw console.error("Error updating employee status:",a),D.error(a instanceof Error?a.message:"Fehler beim Aktualisieren des Mitarbeiterstatus"),a}finally{c(!1)}},M=async(s,t)=>{try{c(!0);const{error:a}=await $.auth.admin.updateUserById(s,{user_metadata:{first_name:t.first_name,last_name:t.last_name},role:t.role});if(a)throw a;const{error:i}=await U.from("profiles").update({first_name:t.first_name,last_name:t.last_name,role:t.role}).eq("id",s);if(i)throw i;await j(!0),D.success("Mitarbeiter erfolgreich aktualisiert")}catch(a){throw console.error("Error updating employee:",a),D.error(a instanceof Error?a.message:"Fehler beim Aktualisieren des Mitarbeiters"),a}finally{c(!1)}};return x.useEffect(()=>{j()},[j]),{employees:l,loading:u,error:o,lastFetchTime:p,createEmployee:b,updateEmployee:M,updateEmployeeStatus:v,fetchEmployees:j,setEmployees:n}},Oe=({isOpen:l,onClose:n,onSubmit:u,isLoading:c})=>{var b,v,M,s;const{register:o,handleSubmit:h,formState:{errors:p},reset:C}=ke(),k=async t=>{try{await u(t),C(),n()}catch{}},j=()=>{c||(C(),n())};return e.jsx(P,{children:l&&e.jsxs(e.Fragment,{children:[e.jsx(S.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black bg-opacity-50 z-40",onClick:j}),e.jsx(S.div,{initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},transition:{type:"spring",damping:25,stiffness:300},className:"fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-0",onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden w-full max-w-md mx-auto",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Neuen Mitarbeiter hinzufügen"}),e.jsx("button",{onClick:j,disabled:c,className:"text-gray-400 hover:text-gray-500 focus:outline-none",children:e.jsx(G,{size:20})})]}),e.jsxs("form",{onSubmit:h(k),children:[e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx(Z,{label:"Name",...o("name",{required:"Name ist erforderlich"}),error:(b=p.name)==null?void 0:b.message,placeholder:"Max Mustermann"}),e.jsx(Z,{label:"E-Mail",type:"email",...o("email",{required:"E-Mail ist erforderlich",pattern:{value:/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,message:"Ungültige E-Mail-Adresse"}}),error:(v=p.email)==null?void 0:v.message,placeholder:"max.mustermann@example.com"}),e.jsx(Z,{label:"Position",...o("position"),error:(M=p.position)==null?void 0:M.message,placeholder:"z.B. Entwickler, Designer, etc."}),e.jsx(Z,{label:"Passwort",type:"password",...o("password",{required:"Passwort ist erforderlich",minLength:{value:6,message:"Passwort muss mindestens 6 Zeichen lang sein"}}),error:(s=p.password)==null?void 0:s.message,placeholder:"Mindestens 6 Zeichen"})]}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 dark:bg-gray-700 flex justify-end space-x-3",children:[e.jsx(z,{type:"button",variant:"outline",onClick:j,disabled:c,children:"Abbrechen"}),e.jsx(z,{type:"submit",isLoading:c,children:"Mitarbeiter erstellen"})]})]})]})})]})})},W=async()=>{var l,n;try{console.log("🔍 Checking if payment_mode columns exist...");const{data:u,error:c}=await $.from("profiles").select("payment_mode, payment_mode_set_at, payment_mode_set_by").limit(1);if(c)throw console.error("❌ Payment mode columns do not exist:",c),(l=c.message)!=null&&l.includes("column")&&((n=c.message)!=null&&n.includes("does not exist"))?(console.error("💡 SOLUTION: Please run the migration in Supabase SQL Editor:"),console.error(`
-- Add payment mode columns to profiles table
ALTER TABLE profiles 
ADD COLUMN IF NOT EXISTS payment_mode VARCHAR(20) DEFAULT NULL 
CHECK (payment_mode IN ('vertragsbasis', 'verguetung') OR payment_mode IS NULL);

ALTER TABLE profiles 
ADD COLUMN IF NOT EXISTS payment_mode_set_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS payment_mode_set_by UUID REFERENCES auth.users(id);

ALTER TABLE profiles 
ADD COLUMN IF NOT EXISTS created_at TIMESTAMPTZ DEFAULT NOW(),
ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();

-- Create index for performance
CREATE INDEX IF NOT EXISTS idx_profiles_payment_mode ON profiles(payment_mode);
        `),new Error("Payment mode columns are missing. Please run the migration in Supabase SQL Editor first.")):c;return console.log("✅ Payment mode columns exist and are accessible"),!0}catch(u){return console.error("❌ Error checking payment mode columns:",u),!1}},Pe=async l=>{try{if(console.log("🧪 Testing payment mode update for user:",l),!await W())return!1;const{data:u,error:c}=await $.from("profiles").update({updated_at:new Date().toISOString()}).eq("id",l).select("id, payment_mode");return c?(console.error("❌ Test update failed:",c),!1):!u||u.length===0?(console.error("❌ User not found or no rows updated"),!1):(console.log("✅ Test update successful, user data:",u[0]),!0)}catch(n){return console.error("❌ Error testing payment mode update:",n),!1}},Be=({employee:l,onUpdate:n,onClose:u})=>{var t;const{profile:c}=se(),{colors:o}=J(),[h,p]=x.useState(l.payment_mode||"vertragsbasis"),[C,k]=x.useState(!1),[j,b]=x.useState(!1),v=[{value:"vertragsbasis",title:"Vertragsbasis",subtitle:"Traditioneller Arbeitsvertrag",icon:ne,description:"Mitarbeiter erhalten einen Arbeitsvertrag mit festem Stundenlohn und regulären Gehaltsauszahlungen.",features:["Fester Arbeitsvertrag","Stundenlohn-basierte Bezahlung","Monatliche Gehaltsauszahlung","Arbeitsrechtlicher Schutz"],color:"blue"},{value:"verguetung",title:"Vergütung pro Aufgabe",subtitle:"Aufgaben-basierte Bezahlung",icon:K,description:"Mitarbeiter erhalten Bezahlung pro abgeschlossener Aufgabe und können flexible Auszahlungen beantragen.",features:["Bezahlung pro Aufgabe","Flexible Auszahlungen","Guthaben-System","Leistungsbasierte Vergütung"],color:"emerald"}],M=async()=>{var a;if(!c){E.error("Nicht autorisiert");return}k(!0);try{if(console.log("🔄 Updating payment mode for user:",l.id,"to mode:",h),!await W()){E.error("Datenbankschema-Fehler: Zahlungsmodus-Spalten fehlen. Bitte kontaktieren Sie den Administrator.");return}if(!await Pe(l.id)){E.error("Benutzer kann nicht aktualisiert werden. Bitte kontaktieren Sie den Administrator.");return}const{data:d,error:g}=await $.from("profiles").update({payment_mode:h,payment_mode_set_at:new Date().toISOString(),payment_mode_set_by:c.id,updated_at:new Date().toISOString()}).eq("id",l.id).select();if(console.log("📊 Update result:",d),console.log("❌ Update error:",g),g)throw console.error("Database update error:",g),g;if(!d||d.length===0)throw new Error("No rows were updated - user may not exist or columns may be missing");if(h==="verguetung"){const{data:w}=await U.from("worker_balances").select("id").eq("worker_id",l.id).single();if(!w){const{error:N}=await $.from("worker_balances").insert({worker_id:l.id,current_balance:0,total_earned:0,total_paid_out:0});N&&(console.error("Error creating worker balance:",N),E.error("Zahlungsmodus zugewiesen, aber Guthaben-Erstellung fehlgeschlagen"))}}E.success(`Zahlungsmodus erfolgreich auf "${(a=v.find(w=>w.value===h))==null?void 0:a.title}" gesetzt`),sessionStorage.removeItem("employeesList"),n(),u()}catch(i){console.error("Error assigning payment mode:",i),E.error("Fehler beim Zuweisen des Zahlungsmodus")}finally{k(!1)}},s=v.find(a=>a.value===h);return j?e.jsx(P,{children:e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex min-h-screen items-center justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0",children:[e.jsx(S.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 transition-opacity",onClick:()=>b(!1)}),e.jsx("span",{className:"hidden sm:inline-block sm:h-screen sm:align-middle",children:"​"}),e.jsx(S.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.2},className:"relative z-50 inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left align-bottom shadow-xl transition-all sm:my-8 sm:align-middle max-w-md w-full",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(je,{className:"h-12 w-12 mx-auto mb-4",style:{color:o.accent}}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 dark:text-white mb-2",children:"Zahlungsmodus zuweisen?"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300",children:["Möchten Sie ",l.first_name," ",l.last_name," wirklich den Zahlungsmodus",e.jsxs("strong",{className:"text-gray-900 dark:text-white",children:[' "',s==null?void 0:s.title,'"']})," zuweisen?"]})]}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx(T,{variant:"outline",onClick:()=>b(!1),className:"flex-1",children:"Abbrechen"}),e.jsx(T,{variant:"primary",onClick:M,isLoading:C,className:"flex-1",children:C?"Wird zugewiesen...":"Bestätigen"})]})]})})]})})}):e.jsx(P,{children:e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex min-h-screen items-center justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0",children:[e.jsx(S.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 transition-opacity",onClick:u}),e.jsx("span",{className:"hidden sm:inline-block sm:h-screen sm:align-middle",children:"​"}),e.jsx(S.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.2},className:"relative z-50 inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left align-bottom shadow-xl transition-all sm:my-8 sm:align-middle max-w-2xl w-full",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ve,{className:"h-6 w-6",style:{color:o.primary}}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Zahlungsmodus zuweisen"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300",children:[l.first_name," ",l.last_name]})]})]}),e.jsxs("button",{onClick:u,className:"rounded-md bg-white dark:bg-gray-800 text-gray-400 dark:text-gray-500 hover:text-gray-500 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2",style:{focusRingColor:`${o.primary}50`},children:[e.jsx("span",{className:"sr-only",children:"Close"}),e.jsx(G,{className:"h-6 w-6","aria-hidden":"true"})]})]}),l.payment_mode&&e.jsxs("div",{className:"border rounded-lg p-4 mb-6",style:{backgroundColor:`${o.primary}10`,borderColor:`${o.primary}30`},children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(V,{className:"h-4 w-4",style:{color:o.primary}}),e.jsxs("span",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:["Aktueller Modus: ",(t=v.find(a=>a.value===l.payment_mode))==null?void 0:t.title]})]}),l.payment_mode_set_at&&e.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400 mt-1",children:["Zugewiesen am: ",new Date(l.payment_mode_set_at).toLocaleDateString("de-DE")]})]}),e.jsx("div",{className:"space-y-4 mb-8",children:v.map(a=>{const i=a.icon,m=h===a.value;return e.jsx("button",{onClick:()=>p(a.value),className:`w-full text-left p-6 rounded-xl border-2 transition-all duration-200 dark:bg-gray-700 ${m?"shadow-md":"border-gray-200 dark:border-gray-600 hover:border-gray-300 dark:hover:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-600"}`,style:{borderColor:m?o.primary:void 0,backgroundColor:m?`${o.primary}10`:void 0},children:e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-xl flex items-center justify-center",style:{backgroundColor:a.color==="blue"?`${o.primary}20`:`${o.accent}20`},children:e.jsx(i,{className:"h-6 w-6",style:{color:a.color==="blue"?o.primary:o.accent}})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-900 dark:text-white",children:a.title}),m&&e.jsx(V,{className:"h-5 w-5",style:{color:o.primary}})]}),e.jsx("p",{className:"text-sm font-medium text-gray-600 dark:text-gray-300 mb-3",children:a.subtitle}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-4 leading-relaxed",children:a.description}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:a.features.map((d,g)=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full",style:{backgroundColor:o.primary}}),e.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:d})]},g))})]})]})},a.value)})}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(T,{variant:"outline",onClick:u,size:"lg",children:"Abbrechen"}),e.jsx(T,{variant:"primary",onClick:()=>b(!0),disabled:h===l.payment_mode,size:"lg",children:h===l.payment_mode?"Bereits zugewiesen":"Modus zuweisen"})]})]})})]})})})},Ze=({selectedEmployees:l,onUpdate:n,onClose:u})=>{const{profile:c}=se(),{colors:o}=J(),[h,p]=x.useState("vertragsbasis"),[C,k]=x.useState(!1),[j,b]=x.useState(!1),v=[{value:"vertragsbasis",title:"Vertragsbasis",description:"Traditioneller Arbeitsvertrag mit festem Stundenlohn",icon:ne,color:"blue"},{value:"verguetung",title:"Vergütung pro Aufgabe",description:"Aufgaben-basierte Bezahlung mit flexiblen Auszahlungen",icon:K,color:"emerald"}],M=async()=>{var t;if(!c){E.error("Nicht autorisiert");return}k(!0);try{if(console.log("🔄 Bulk updating payment mode for users to mode:",h),!await W()){E.error("Datenbankschema-Fehler: Zahlungsmodus-Spalten fehlen. Bitte kontaktieren Sie den Administrator.");return}const i=l.map(N=>N.id),m=new Date().toISOString();console.log("🔄 Proceeding with bulk update for users:",i);const{data:d,error:g}=await $.from("profiles").update({payment_mode:h,payment_mode_set_at:m,payment_mode_set_by:c.id,updated_at:m}).in("id",i).select();if(console.log("📊 Bulk update result:",d),console.log("❌ Bulk update error:",g),g)throw console.error("Database bulk update error:",g),g;if(!d||d.length===0)throw new Error("No rows were updated - users may not exist or columns may be missing");if(h==="verguetung"){const{data:N}=await U.from("worker_balances").select("worker_id").in("worker_id",i),_=(N==null?void 0:N.map(f=>f.worker_id))||[],I=i.filter(f=>!_.includes(f));if(I.length>0){const f=I.map(R=>({worker_id:R,current_balance:0,total_earned:0,total_paid_out:0})),{error:F}=await $.from("worker_balances").insert(f);F&&(console.error("Error creating worker balances:",F),E.error("Zahlungsmodi zugewiesen, aber einige Guthaben-Erstellungen fehlgeschlagen"))}}const w=(t=v.find(N=>N.value===h))==null?void 0:t.title;E.success(`${l.length} Mitarbeiter erfolgreich auf "${w}" gesetzt`),sessionStorage.removeItem("employeesList"),n(),u()}catch(a){console.error("Error in bulk payment mode assignment:",a),E.error("Fehler beim Zuweisen der Zahlungsmodi")}finally{k(!1)}},s=v.find(t=>t.value===h);return j?e.jsx(P,{children:e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex min-h-screen items-center justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0",children:[e.jsx(S.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 transition-opacity",onClick:()=>b(!1)}),e.jsx("span",{className:"hidden sm:inline-block sm:h-screen sm:align-middle",children:"​"}),e.jsx(S.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.2},className:"relative z-50 inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left align-bottom shadow-xl transition-all sm:my-8 sm:align-middle max-w-md w-full",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(Ne,{className:"h-12 w-12 mx-auto mb-4",style:{color:o.accent}}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 dark:text-white mb-2",children:"Bulk-Zuweisung bestätigen"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300",children:["Möchten Sie wirklich ",e.jsxs("strong",{children:[l.length," Mitarbeiter"]})," den Zahlungsmodus",e.jsxs("strong",{className:"text-gray-900 dark:text-white",children:[' "',s==null?void 0:s.title,'"']})," zuweisen?"]})]}),e.jsxs("div",{className:"rounded-lg p-4 mb-6",style:{backgroundColor:`${o.primary}10`},children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-white mb-2",children:"Betroffene Mitarbeiter:"}),e.jsx("div",{className:"max-h-32 overflow-y-auto space-y-1",children:l.map((t,a)=>e.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:[a+1,". ",t.first_name," ",t.last_name]},t.id))})]}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx(T,{variant:"outline",onClick:()=>b(!1),className:"flex-1",children:"Abbrechen"}),e.jsx(T,{variant:"primary",onClick:M,isLoading:C,className:"flex-1",children:C?"Wird zugewiesen...":"Zuweisen"})]})]})})]})})}):e.jsx(P,{children:e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:e.jsxs("div",{className:"flex min-h-screen items-center justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0",children:[e.jsx(S.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 transition-opacity",onClick:u}),e.jsx("span",{className:"hidden sm:inline-block sm:h-screen sm:align-middle",children:"​"}),e.jsx(S.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.2},className:"relative z-50 inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left align-bottom shadow-xl transition-all sm:my-8 sm:align-middle max-w-3xl w-full",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(X,{className:"h-6 w-6",style:{color:o.primary}}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Bulk Zahlungsmodus-Zuweisung"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300",children:[l.length," Mitarbeiter ausgewählt"]})]})]}),e.jsxs("button",{onClick:u,className:"rounded-md bg-white dark:bg-gray-800 text-gray-400 dark:text-gray-500 hover:text-gray-500 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2",style:{focusRingColor:`${o.primary}50`},children:[e.jsx("span",{className:"sr-only",children:"Close"}),e.jsx(G,{className:"h-6 w-6","aria-hidden":"true"})]})]}),e.jsxs("div",{className:"rounded-lg p-4 mb-6",style:{backgroundColor:`${o.primary}10`},children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-white mb-2",children:"Ausgewählte Mitarbeiter:"}),e.jsx("div",{className:"max-h-24 overflow-y-auto",children:e.jsx("div",{className:"grid grid-cols-2 gap-2 text-sm text-gray-600 dark:text-gray-400",children:l.map((t,a)=>e.jsxs("div",{children:[t.first_name," ",t.last_name]},t.id))})})]}),e.jsxs("div",{className:"space-y-4 mb-8",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Zahlungsmodus auswählen:"}),v.map(t=>{const a=t.icon,i=h===t.value;return e.jsx("button",{onClick:()=>p(t.value),className:`w-full text-left p-4 rounded-xl border-2 transition-all duration-200 dark:bg-gray-700 ${i?"shadow-md":"border-gray-200 dark:border-gray-600 hover:border-gray-300 dark:hover:border-gray-500 hover:bg-gray-50 dark:hover:bg-gray-600"}`,style:{borderColor:i?o.primary:void 0,backgroundColor:i?`${o.primary}10`:void 0},children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg flex items-center justify-center",style:{backgroundColor:t.color==="blue"?`${o.primary}20`:`${o.accent}20`},children:e.jsx(a,{className:"h-5 w-5",style:{color:t.color==="blue"?o.primary:o.accent}})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h4",{className:"text-base font-bold text-gray-900 dark:text-white",children:t.title}),i&&e.jsx(V,{className:"h-4 w-4",style:{color:o.primary}})]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:t.description})]})]})},t.value)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(T,{variant:"outline",onClick:u,size:"lg",children:"Abbrechen"}),e.jsxs(T,{variant:"primary",onClick:()=>b(!0),size:"lg",children:[l.length," Mitarbeiter zuweisen"]})]})]})})]})})})},Re=()=>{const l=Ee(),{colors:n,shouldShowPaymentManagement:u}=J(),[c,o]=x.useState(""),[h,p]=x.useState(!1),[C,k]=x.useState(!1),[j,b]=x.useState(null),[v,M]=x.useState(!1),[s,t]=x.useState(null),[a,i]=x.useState(!1),[m,d]=x.useState(null),[g,w]=x.useState([]),[N,_]=x.useState(!1),{employees:I,loading:f,error:F,createEmployee:R,updateEmployee:ie,fetchEmployees:H}=Fe(),{deleteEmployee:le}=ze(),{workerBalances:oe,loading:ce}=Ie(u()),B=()=>{H(!0)},de=r=>oe.find(y=>y.worker_id===r),me=r=>{d(r),i(!0)},ue=r=>{w(y=>y.some(A=>A.id===r.id)?y.filter(A=>A.id!==r.id):[...y,r])},xe=()=>{if(g.length===0){E.error("Bitte wählen Sie mindestens einen Mitarbeiter aus");return}_(!0)},Q=r=>{switch(r){case"verguetung":return{text:"Vergütung",color:"bg-emerald-100 text-emerald-800"};case"vertragsbasis":return{text:"Vertrag",color:"bg-blue-100 text-blue-800"};default:return{text:"Nicht gesetzt",color:"bg-gray-100 text-gray-800"}}},Y=Array.isArray(I)?I.filter(r=>r?!r.banned_until||new Date(r.banned_until)<new Date:!1):[],O=Y.filter(r=>{var L,A,ee,te;if(!r)return!1;const y=c.toLowerCase();return(((L=r.name)==null?void 0:L.toLowerCase())||"").includes(y)||(((A=r.first_name)==null?void 0:A.toLowerCase())||"").includes(y)||(((ee=r.last_name)==null?void 0:ee.toLowerCase())||"").includes(y)||(((te=r.email)==null?void 0:te.toLowerCase())||"").includes(y)}),he=async r=>{try{await R(r),p(!1)}catch{}},ge=async(r,y)=>{try{await ie(r,y),k(!1),b(null)}catch{}},pe=r=>{b(r),k(!0)},ye=async()=>{if(s)try{await le(s.id,s.name),M(!1),t(null),await H(!0)}catch(r){console.error("Error deleting employee:",r),E.error("Fehler beim Löschen des Mitarbeiters")}},fe=r=>{t(r),M(!0)},be={hidden:{opacity:0},show:{opacity:1,transition:{staggerChildren:.05}}},we={hidden:{opacity:0,y:20},show:{opacity:1,y:0}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6 w-full",children:[e.jsx(S.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.5},className:"bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 rounded-xl p-6 shadow-sm border border-gray-100 dark:border-gray-700",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`p-2 rounded-md bg-[${n.primary}]/10 dark:bg-gray-700 mr-4`,children:e.jsx(X,{size:24,className:`text-[${n.primary}] dark:text-white dark:text-[${n.primaryLight}]`})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-app font-app-bold text-gray-900 dark:text-white",children:"Mitarbeiter"}),e.jsx("p",{className:"mt-1 text-gray-600 dark:text-gray-400 font-app",children:"Verwalten Sie Ihre Mitarbeiter und deren Konten."})]})]}),e.jsxs("div",{className:"mt-4 md:mt-0 flex items-center space-x-3",children:[e.jsx(z,{variant:"outline",size:"sm",onClick:B,disabled:f,leftIcon:e.jsx(q,{size:16}),children:"Aktualisieren"}),e.jsx(z,{leftIcon:e.jsx(Te,{size:16}),size:"md",onClick:()=>p(!0),style:{backgroundColor:n.primary,color:"white"},className:"hover:opacity-90 transition-opacity",children:"Mitarbeiter hinzufügen"}),g.length>0&&e.jsxs(z,{leftIcon:e.jsx(K,{size:16}),size:"md",onClick:xe,style:{backgroundColor:n.accent,color:"white"},className:"hover:opacity-90 transition-opacity",children:["Zahlungsmodus zuweisen (",g.length,")"]})]})]})}),e.jsx(Se,{className:"border-0 shadow-sm overflow-hidden",children:e.jsxs(Ce,{className:"pt-4",children:[e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700 mb-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center pb-4",children:[e.jsx("div",{className:"flex items-center",children:e.jsxs("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white flex items-center",children:[e.jsx(X,{className:"mr-2 h-5 w-5 text-gray-600 dark:text-gray-400"}),"Mitarbeiter (",Y.length,")"]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-4 md:mt-0",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(Me,{size:16,className:`text-[${n.primary}] dark:text-white/60`})}),e.jsx("input",{type:"text",placeholder:"Suchen...",className:"pl-10 pr-4 py-2 border border-gray-200 dark:border-gray-700 rounded-md w-full sm:w-64 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-accent/30 focus:border-accent transition-colors",value:c,onChange:r=>o(r.target.value)})]}),e.jsx(z,{variant:"outline",size:"md",leftIcon:e.jsx(Le,{size:16}),className:"border-gray-200 dark:border-gray-700 hover:border-accent hover:text-accent dark:hover:text-accent transition-colors",children:"Filter"})]})]})}),f?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(re,{size:"lg"})}):F?e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200 p-6 rounded-lg flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(q,{className:"mr-2",size:20}),e.jsx("p",{children:"Ein Fehler ist aufgetreten beim Laden der Mitarbeiterdaten."})]}),e.jsx("div",{className:"mt-2",children:e.jsx(T,{onClick:B,className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center",disabled:f,icon:e.jsx(q,{size:16,className:"mr-2"}),children:"Daten neu laden"})})]}):e.jsx("div",{className:"overflow-x-auto",children:O.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:c?e.jsxs("p",{children:['Keine Mitarbeiter gefunden, die "',c,'" entsprechen.']}):e.jsx("p",{children:"Keine Mitarbeiter vorhanden. Fügen Sie neue Mitarbeiter hinzu."})}):e.jsxs(S.table,{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",variants:be,initial:"hidden",animate:"show",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800/50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-3 py-3 text-left",children:e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:g.length===O.length&&O.length>0,onChange:r=>{r.target.checked?w(O):w([])}})}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-app font-app-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Name"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-app font-app-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Rolle"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-app font-app-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-app font-app-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Zahlungsmodus"}),u()&&e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-app font-app-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Guthaben"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-app font-app-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Aktionen"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:O.map(r=>{var L;const y=!r.banned_until||new Date(r.banned_until)<new Date;return e.jsxs(S.tr,{variants:we,className:"hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors",children:[e.jsx("td",{className:"px-3 py-4 whitespace-nowrap",children:e.jsx("input",{type:"checkbox",className:"rounded border-gray-300",checked:g.some(A=>A.id===r.id),onChange:()=>ue(r)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`h-10 w-10 flex-shrink-0 flex items-center justify-center font-app font-app-medium ${y?`bg-[${n.primary}]/10 dark:bg-gray-700 text-[${n.primary}] dark:text-white dark:text-[${n.primaryLight}]`:`bg-[${n.accent}]/10 dark:bg-gray-700 text-[${n.accent}] dark:text-white dark:text-[${n.accentLight}]`} rounded-full cursor-pointer shadow-sm border ${y?`border-[${n.primary}]/20 dark:border-gray-600`:`border-[${n.accent}]/20 dark:border-gray-600`}`,onClick:()=>l(`/admin/employees/${r.id}`),children:((L=r.name)==null?void 0:L.charAt(0))||"?"}),e.jsxs("div",{className:"ml-4",children:[e.jsxs("div",{className:`text-sm font-app font-app-medium text-gray-900 dark:text-white hover:text-[${n.primary}] dark:text-white dark:hover:text-[${n.primaryLight}] cursor-pointer flex items-center transition-colors`,onClick:()=>l(`/admin/employees/${r.id}`),children:[r.name||"Unbenannt",!y&&e.jsx("span",{className:`ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-app font-app-medium bg-[${n.accent}]/10 dark:bg-gray-700 text-[${n.accent}] dark:text-white dark:text-[${n.accentLight}] border border-[${n.accent}]/20 dark:border-gray-600 shadow-sm`,children:"DEAKTIVIERT"})]}),e.jsx("div",{className:"text-sm font-app text-gray-500 dark:text-gray-400",children:r.email||"Keine E-Mail"})]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-app text-gray-900 dark:text-white",children:r.role==="admin"?"Administrator":"Mitarbeiter"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-app font-app-medium ${y?`bg-[${n.primary}]/10 dark:bg-gray-700 text-[${n.primary}] dark:text-white dark:text-[${n.primaryLight}] border border-[${n.primary}]/20 dark:border-gray-600`:`bg-[${n.accent}]/10 dark:bg-gray-700 text-[${n.accent}] dark:text-white dark:text-[${n.accentLight}] border border-[${n.accent}]/20 dark:border-gray-600`} shadow-sm`,children:y?"Aktiv":"Inaktiv"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${Q(r.payment_mode).color}`,children:Q(r.payment_mode).text}),e.jsx("button",{onClick:()=>me(r),className:"text-xs text-gray-500 hover:text-gray-700 underline",children:"Ändern"})]})}),u()&&e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white",children:(()=>{const A=de(r.id);return ce?e.jsxs("div",{className:"flex items-center",children:[e.jsx(re,{size:"sm"}),e.jsx("span",{className:"ml-2 text-gray-500",children:"Lädt..."})]}):A?e.jsxs("div",{className:"flex items-center",children:[e.jsx(ae,{className:"text-emerald-600 dark:text-emerald-400 mr-1",size:16}),e.jsxs("span",{className:"font-medium",children:["€",A.current_balance.toFixed(2)]})]}):e.jsxs("div",{className:"flex items-center text-gray-400",children:[e.jsx(ae,{className:"mr-1",size:16}),e.jsx("span",{children:"€0.00"})]})})()}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(z,{variant:"ghost",size:"sm",leftIcon:e.jsx(De,{size:16}),onClick:()=>l(`/admin/employees/${r.id}`),children:"Details"}),e.jsx(z,{variant:"ghost",size:"sm",leftIcon:e.jsx(Ue,{size:16}),onClick:()=>pe(r),children:"Bearbeiten"}),e.jsx(z,{variant:"ghost",size:"sm",leftIcon:e.jsx(Ae,{size:16}),onClick:()=>fe(r),className:"text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300",children:"Löschen"})]})})]},r.id)})})]})})]})})]}),e.jsx(Oe,{isOpen:h,onClose:()=>p(!1),onSubmit:he,isLoading:f}),e.jsx($e,{isOpen:C,onClose:()=>{k(!1),b(null)},onSubmit:ge,employee:j,isLoading:f}),v&&s&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Mitarbeiter löschen"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300 mb-6",children:["Sind Sie sicher, dass Sie ",e.jsx("strong",{children:s.name})," permanent löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden und entfernt alle Daten des Mitarbeiters."]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(z,{variant:"outline",onClick:()=>{M(!1),t(null)},children:"Abbrechen"}),e.jsx(z,{variant:"primary",onClick:ye,className:"bg-red-600 hover:bg-red-700 text-white",children:"Löschen"})]})]})}),a&&m&&e.jsx(Be,{employee:m,onUpdate:()=>{B(),d(null)},onClose:()=>{i(!1),d(null)}}),N&&e.jsx(Ze,{selectedEmployees:g,onUpdate:()=>{B(),w([])},onClose:()=>{_(!1)}})]})},et=_e.memo(Re);export{et as default};
