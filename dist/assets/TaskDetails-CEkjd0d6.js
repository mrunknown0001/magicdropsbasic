import{$ as H,r as u,u as A,a as _,a0 as E,z as x,s as v,j as e,_ as S,O as T,e as N,X as q,a1 as R,L as F,P as B,G as O,Q as U,h as $,k as P,l as Z,o as z,i as Q,w as V}from"./index-C2zOcIr5.js";import{c as D}from"./connectionManager-WW8tX6Ox.js";import{u as G}from"./useEmployees-BfxrKmlR.js";import{E as X}from"./EditTaskModal-Cq5ZhT06.js";import{S as K}from"./square-pen-Df1rf3Dp.js";import{T as I}from"./trash-2-CucBzA-1.js";import{C as J}from"./calendar-BCDof-Hg.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],Y=H("save",W),ee=(a=!1)=>{const[g,y]=u.useState([]),[k,b]=u.useState(!a),[j,p]=u.useState(null),{user:o,isAdmin:t}=A(),l=u.useCallback(async()=>{if(o)try{b(!0),p(null),console.log("Fetching tasks with admin client...");let r=_.from("tasks").select("*");t()||(r=r.eq("assignee_id",o.id)),console.log("Query built:",{isAdmin:t(),userId:o.id});const{data:i,error:c}=await E(async()=>await r.order("created_at",{ascending:!1}));if(c)throw c;y(i)}catch(r){console.error("Failed to fetch tasks:",r),p(r instanceof Error?r:new Error("Failed to fetch tasks")),x.error("Failed to fetch tasks"),D.scheduleReconnect("tasks-channel")}finally{b(!1)}},[o,t]),f=u.useRef(null),h=u.useCallback(()=>{var c;if((c=f.current)!=null&&c.subscription){try{_.removeChannel(f.current.subscription)}catch(d){console.error("Error removing existing channel:",d)}f.current=null}if(!o)return;const r=`tasks-channel-${o.id}`,i=_.channel(r).on("postgres_changes",{event:"*",schema:"public",table:"tasks"},d=>{console.log("Tasks change received:",d),l()}).subscribe(d=>{(d==="TIMED_OUT"||d==="CHANNEL_ERROR"||d==="CLOSED")&&f.current&&D.scheduleReconnect(r,3e3)});return f.current={subscription:i,channelId:r},i},[o,l]);return u.useEffect(()=>{let r=!0;const i=async()=>{if(!(!o||!r))try{a||await l(),h()}catch(d){console.error("Error in setup:",d)}},c=d=>{var L,M;((L=d.detail)==null?void 0:L.channel)===((M=f.current)==null?void 0:M.channelId)&&(console.log("Reconnecting tasks subscription"),l().finally(()=>{r&&h()}))};return i(),window.addEventListener("supabase-reconnect",c),()=>{var d;if(r=!1,window.removeEventListener("supabase-reconnect",c),(d=f.current)!=null&&d.subscription)try{_.removeChannel(f.current.subscription),f.current=null}catch(C){console.error("Error removing channel on cleanup:",C)}}},[o,l,h,a]),{tasks:g,loading:k,error:j,createTask:async r=>{try{window.dispatchEvent(new CustomEvent("fetch-start"));const{data:i,error:c}=await E(async()=>await v.from("tasks").insert([r]).select().single());if(c)throw c;return l(),x.success("Task created successfully"),i}catch(i){throw console.error("Failed to create task:",i),x.error("Failed to create task"),i}finally{window.dispatchEvent(new CustomEvent("fetch-end"))}},updateTask:async(r,i)=>{try{window.dispatchEvent(new CustomEvent("fetch-start"));const{data:c,error:d}=await E(async()=>await v.from("tasks").update(i).eq("id",r).select().single());if(d)throw d;return l(),x.success("Task updated successfully"),c}catch(c){throw console.error("Failed to update task:",c),x.error("Failed to update task"),c}finally{window.dispatchEvent(new CustomEvent("fetch-end"))}},deleteTask:async r=>{try{window.dispatchEvent(new CustomEvent("fetch-start"));const{error:i}=await E(async()=>await v.from("tasks").delete().eq("id",r));if(i)throw i;return l(),x.success("Task deleted successfully"),!0}catch(i){throw console.error("Failed to delete task:",i),x.error("Failed to delete task"),i}finally{window.dispatchEvent(new CustomEvent("fetch-end"))}},getTaskById:async r=>{try{window.dispatchEvent(new CustomEvent("fetch-start"));const{data:i,error:c}=await E(async()=>await v.from("tasks").select("*").eq("id",r).single());if(c)throw c;return i}catch(i){throw console.error("Failed to fetch task:",i),x.error("Failed to fetch task"),i}finally{window.dispatchEvent(new CustomEvent("fetch-end"))}},fetchTasks:l}},te=a=>{const[g,y]=u.useState([]),[k,b]=u.useState(!0),[j,p]=u.useState(null),{user:o}=A();return u.useEffect(()=>{const h=async()=>{try{b(!0),p(null);const{data:s,error:n}=await v.from("task_comments").select(`
            *,
            profiles:user_id (
              name,
              email
            )
          `).eq("task_id",a).order("created_at",{ascending:!1});if(n)throw n;const w=s.map(m=>{var r;return{...m,user_name:m.profiles?`${m.profiles.first_name||""} ${m.profiles.last_name||""}`.trim():"",user_email:((r=m.profiles)==null?void 0:r.email)||"",profiles:void 0}});y(w)}catch(s){console.error("Error fetching comments:",s),p(s),x.error("Fehler beim Laden der Kommentare")}finally{b(!1)}};if(a){h();const s=v.channel(`task_comments:${a}`).on("postgres_changes",{event:"*",schema:"public",table:"task_comments",filter:`task_id=eq.${a}`},n=>{n.eventType==="INSERT"?(async()=>{const{data:m}=await v.from("profiles").select("name, email").eq("id",n.new.user_id).single(),r={...n.new,user_name:(m==null?void 0:m.name)||"",user_email:(m==null?void 0:m.email)||""};y(i=>[r,...i])})():n.eventType==="UPDATE"?y(w=>w.map(m=>m.id===n.new.id?{...m,...n.new}:m)):n.eventType==="DELETE"&&y(w=>w.filter(m=>m.id!==n.old.id))}).subscribe();return()=>{s.unsubscribe()}}},[a]),{comments:g,loading:k,error:j,addComment:async h=>{if(!o){x.error("Sie müssen angemeldet sein, um Kommentare hinzuzufügen");return}try{const{data:s,error:n}=await v.from("task_comments").insert({task_id:a,user_id:o.id,content:h}).select().single();if(n)throw n;return x.success("Kommentar hinzugefügt"),s}catch(s){throw console.error("Error adding comment:",s),x.error("Fehler beim Hinzufügen des Kommentars"),s}},updateComment:async(h,s)=>{try{const{data:n,error:w}=await v.from("task_comments").update({content:s}).eq("id",h).select().single();if(w)throw w;return x.success("Kommentar aktualisiert"),n}catch(n){throw console.error("Error updating comment:",n),x.error("Fehler beim Aktualisieren des Kommentars"),n}},deleteComment:async h=>{try{const{error:s}=await v.from("task_comments").delete().eq("id",h);if(s)throw s;x.success("Kommentar gelöscht")}catch(s){throw console.error("Error deleting comment:",s),x.error("Fehler beim Löschen des Kommentars"),s}}}},se=({comment:a,onUpdate:g,onDelete:y})=>{const{user:k}=A(),[b,j]=u.useState(!1),[p,o]=u.useState(a.content),[t,l]=u.useState(!1),f=(k==null?void 0:k.id)===a.user_id,h=async()=>{if(p.trim()!==""){l(!0);try{await g(a.id,p),j(!1)}catch{}finally{l(!1)}}},s=async()=>{if(window.confirm("Sind Sie sicher, dass Sie diesen Kommentar löschen möchten?")){l(!0);try{await y(a.id)}catch{}finally{l(!1)}}};return e.jsxs("div",{className:"border-b border-gray-200 dark:border-gray-700 py-4 last:border-0",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-white",children:a.user_name||a.user_email||"Unbekannter Benutzer"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2",children:S(new Date(a.created_at),"dd.MM.yyyy, HH:mm",{locale:T})}),a.updated_at!==a.created_at&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 ml-2 italic",children:"(bearbeitet)"})]}),f&&!b&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("button",{onClick:()=>j(!0),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300",disabled:t,children:e.jsx(K,{size:16})}),e.jsx("button",{onClick:s,className:"text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300",disabled:t,children:e.jsx(I,{size:16})})]})]}),b?e.jsxs("div",{className:"space-y-2",children:[e.jsx("textarea",{value:p,onChange:n=>o(n.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-accent focus:border-accent bg-white dark:bg-gray-700 text-gray-900 dark:text-white",rows:3,disabled:t}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(N,{variant:"outline",size:"sm",leftIcon:e.jsx(q,{size:16}),onClick:()=>{j(!1),o(a.content)},disabled:t,children:"Abbrechen"}),e.jsx(N,{variant:"primary",size:"sm",leftIcon:e.jsx(Y,{size:16}),onClick:h,isLoading:t,disabled:p.trim()===""||t,children:"Speichern"})]})]}):e.jsx("p",{className:"text-gray-700 dark:text-gray-300 whitespace-pre-wrap",children:a.content})]})},re=({taskId:a})=>{const{comments:g,loading:y,error:k,addComment:b,updateComment:j,deleteComment:p}=te(a),[o,t]=u.useState(""),[l,f]=u.useState(!1),h=async s=>{if(s.preventDefault(),o.trim()!==""){f(!0);try{await b(o),t("")}catch{}finally{f(!1)}}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Kommentare"}),e.jsxs("form",{onSubmit:h,className:"space-y-3",children:[e.jsx("textarea",{value:o,onChange:s=>t(s.target.value),placeholder:"Schreiben Sie einen Kommentar...",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-accent focus:border-accent bg-white dark:bg-gray-700 text-gray-900 dark:text-white",rows:3,disabled:l}),e.jsx("div",{className:"flex justify-end",children:e.jsx(N,{type:"submit",leftIcon:e.jsx(R,{size:16}),isLoading:l,disabled:o.trim()===""||l,children:"Kommentar senden"})})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:y?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx(F,{size:"md"})}):k?e.jsx("div",{className:"p-4 text-center text-red-600 dark:text-red-400",children:"Fehler beim Laden der Kommentare. Bitte versuchen Sie es später erneut."}):g.length===0?e.jsx("div",{className:"p-6 text-center text-gray-500 dark:text-gray-400",children:"Keine Kommentare vorhanden. Sei der Erste, der einen Kommentar hinterlässt!"}):e.jsx("div",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:g.map(s=>e.jsx("div",{className:"p-4",children:e.jsx(se,{comment:s,onUpdate:j,onDelete:p})},s.id))})})]})},ae={pending:"Ausstehend",in_progress:"In Bearbeitung",completed:"Abgeschlossen"},ne={low:"Niedrig",medium:"Mittel",high:"Hoch"},ie={pending:"bg-yellow-100 text-yellow-800 dark:bg-yellow-300 dark:text-yellow-900",in_progress:"bg-blue-100 text-blue-800 dark:bg-blue-300 dark:text-blue-900",completed:"bg-green-100 text-green-800 dark:bg-green-300 dark:text-green-900"},ce={low:"bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-200",medium:"bg-blue-100 text-blue-800 dark:bg-blue-600 dark:text-blue-200",high:"bg-red-100 text-red-800 dark:bg-red-600 dark:text-red-200"},fe=()=>{const{id:a}=B(),g=O(),{tasks:y,loading:k,error:b,updateTask:j,deleteTask:p}=ee(),{employees:o}=G(),[t,l]=u.useState(null),[f,h]=u.useState(!1),[s,n]=u.useState(!1),[w,m]=u.useState("");u.useEffect(()=>{if(y.length>0&&a){const c=y.find(d=>d.id===a);if(c){if(l(c),c.assignee_id){const d=o.find(C=>C.id===c.assignee_id);d&&m(d.name||d.email||d.id)}}else x.error("Aufgabe nicht gefunden"),g("/admin/tasks")}},[y,a,o,g]);const r=async(c,d)=>{try{await j(c,d),h(!1),x.success("Aufgabe erfolgreich aktualisiert")}catch{}},i=async()=>{if(t)try{await p(t.id),x.success("Aufgabe erfolgreich gelöscht"),g("/admin/tasks")}catch{}};return k?e.jsx("div",{className:"flex justify-center items-center h-96",children:e.jsx(F,{size:"lg"})}):b?e.jsx("div",{className:"text-center text-red-600 p-4",children:"Ein Fehler ist aufgetreten beim Laden der Aufgabe."}):t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{variant:"ghost",onClick:()=>g("/admin/tasks"),leftIcon:e.jsx(U,{size:16}),children:"Zurück zur Aufgabenliste"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(N,{variant:"outline",leftIcon:e.jsx(K,{size:16}),onClick:()=>h(!0),children:"Bearbeiten"}),e.jsx(N,{variant:"danger",leftIcon:e.jsx(I,{size:16}),onClick:()=>n(!0),children:"Löschen"})]})]}),e.jsxs($,{children:[e.jsx(P,{children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(Z,{children:t.title}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:["ID: ",t.id]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${ie[t.status]}`,children:[e.jsx(z,{size:12,className:"mr-1"}),ae[t.status]]}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${ce[t.priority]}`,children:ne[t.priority]})]})]})}),e.jsx(Q,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Beschreibung"}),e.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:t.description||"Keine Beschreibung vorhanden."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Details"}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-4 space-y-3",children:[t.assignee_id&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(V,{size:16,className:"text-gray-400 mr-2"}),e.jsxs("span",{className:"text-sm text-gray-900 dark:text-white",children:["Zugewiesen an: ",w]})]}),t.due_date&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(J,{size:16,className:"text-gray-400 mr-2"}),e.jsxs("span",{className:"text-sm text-gray-900 dark:text-white",children:["Fällig am: ",S(new Date(t.due_date),"dd. MMMM yyyy",{locale:T})]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(z,{size:16,className:"text-gray-400 mr-2"}),e.jsxs("span",{className:"text-sm text-gray-900 dark:text-white",children:["Erstellt am: ",S(new Date(t.created_at),"dd. MMMM yyyy, HH:mm",{locale:T})]})]}),t.updated_at&&t.updated_at!==t.created_at&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(z,{size:16,className:"text-gray-400 mr-2"}),e.jsxs("span",{className:"text-sm text-gray-900 dark:text-white",children:["Aktualisiert am: ",S(new Date(t.updated_at),"dd. MMMM yyyy, HH:mm",{locale:T})]})]})]})]}),e.jsx("div",{children:e.jsx(re,{taskId:t.id})})]})]})})]})]}),e.jsx(X,{isOpen:f,onClose:()=>h(!1),onSubmit:r,task:t,isLoading:k}),s&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden w-full max-w-md mx-auto p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Aufgabe löschen"}),e.jsxs("p",{className:"text-gray-700 dark:text-gray-300 mb-6",children:['Sind Sie sicher, dass Sie die Aufgabe "',t.title,'" löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.']}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(N,{variant:"outline",onClick:()=>n(!1),children:"Abbrechen"}),e.jsx(N,{variant:"danger",onClick:i,isLoading:k,children:"Löschen"})]})]})})]}):e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Aufgabe nicht gefunden."}),e.jsx(N,{onClick:()=>g("/admin/tasks"),children:"Zurück zur Aufgabenliste"})]})};export{fe as default};
